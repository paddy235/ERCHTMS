<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="stylesheet" href="css/common.css">
	<link rel="stylesheet" href="js/swiper/css/swiper.min.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/left.css">
	<link rel="stylesheet" href="css/table.css">
	<link rel="stylesheet" href="css/zSec.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/swiper/js/swiper.min.js"></script>
    <script src="js/echarts.min.js"></script>
    <script src="js/echarts/echart1.js"></script>
    <script src="js/nicescroll.min.js"></script>
    <title>广西华昇安全生产智能管控中心</title>
    <script type="text/javascript">
      
    </script>
</head>
<body>
<div class="container">
	<div class="main-left clearfix">
		<div class="main-left1-border" >
				<div class="main_left1 clearfix">
						<div class="chartsTitle">
						   <h1 id="warnLevel">目前处于较安全状态</h1>
						   <!-- <p>点击查看详情</p> -->
					   </div>
						<div class="charts1"></div>
						  <div class="tableDiv1" >
							<h2 class="tableTit"></h2>
                  <div style="min-height:315px;">
                      <table>
                          <thead>
                          <th>日期</th>
                          <th>单位/部门</th>
                          <th>工作描述</th>
                          </thead>
                          <tbody id="work"></tbody>
                      </table>
                  </div>
                  <div class="notice" id="notices">
                      <p>通知公告 | 关于发布并启用《BS产品清单V2.0》的通知<span>2020-05-21</span></p>
                  </div>
						</div>
				  </div>
		</div>
		<div class="main-left2-border">
             <div class="main-left2-inner">
				<h2 class="section_title"><img src="img/tit2.png"></h2>

					<div class="swip-middle1">
							<div class="inner1-left">
								<p><span>安</span><span>全</span><span>风</span><span>险</span><span>管</span><span>理</span></p>
							</div>
                        <div class="swiper-container swiper-no-swiping swiper-container1">
                                <div class="swiper-wrapper" id="fxlist">
                                    <p style="color:white;">正在加载数据……</p>
								</div>
							</div>
						</div>
				   <div class="swip-middle2" style="margin-top:10px;margin-bottom: 10px">
						<div class="inner1-left" style="margin-right:10px">
								<p>隐患排查治理</p>
						</div>
           <div class="swiper-container swiper-content swiper-no-swiping swiper-container2">
               <div class="swiper-wrapper" id="htlist">
                   <p style="color:white;">正在加载数据……</p>
								</div>
												</div>
						<div class="swiper-button-prev"></div>
                        <div class="swiper-button-next"></div>
					</div>			
					<div class="swip-middle3">            
							<div class="inner1-left">
									<p>反违章管理</p>
								</div>       
                        <div class="swiper-container swiper-no-swiping swiper-container3">
                            <div class="swiper-wrapper" id="wzlist">
                                    <p style="color:white;">正在加载数据……</p>
											</div>
									</div>
									</div>
								</div>	
						</div>	
		<div class="main-left3-border">
				<h2><img src="img/tit3.png"></h2>
				<div class="charts2">

				</div>
		</div>
		<div class="main-left4-border">
				<div class="left4-top">
					<h2 class="section_title" style="margin-left:0"><img src="img/tit4.png"></h2>
					<!-- <ul id="tab" class='tabs'>
						<li class="activ-a">部门</li>
						<li class="activ-b">专业</li>
						<li class="activ-c">区域</li>
					</ul> -->
				</div>
				<div class="tableDiv1 tableDivs" >
						<table>
							<thead>
							<th>单位/部门</th>
							<th>未闭环一般隐患</th>
							<th>未闭环重大隐患</th>
							</thead>
							<tbody id="tabStat">
							</tbody>
						</table>
					</div>
		</div>
		<div class="main-left5-border" >
				<h2 style="margin-top:30px;margin-left:35px;margin-bottom:25px;"><img src="img/tit5.png"></h2>
				<div class="charts3">

				</div>
		</div>
	</div>
    <div class="main-center clearfix">
		<div class="title" onclick="window.location.href = 'http://bigscreen.gxhs.com';">
			<div class="logo"></div>
			<div class="text"></div>
			<div class="time clearfix">
				<div class="tip fl">
					安全生产
                    <span class="yel" id="safeDays">-</span>
					天
				</div>
				<div class="date fr">
					<p class="clearfix">
						<i class="fl" id="date">06-10</i>
						<i class="fr" id="time">8:30</i>
					</p>
				</div>
			</div>
		</div>
		<div class="main-center-border">
			<img src="images/bg_big.png">
		</div>
    </div>
    <div class="main-right clearfix">
		<div class="main-right1-border fl">
			<div class="right1_inner">
				<h2 class="section_title"><img src="images/wb_project.png"></h2>
				<div class="swiper-container swiper-no-swiping swiper-container1">
					<div class="swiper-wrapper" id="OutProject">
					</div>
                    <div id="OutProjectNoData" style="color:white;">
                        <center>正在加载数据……</center>
                    </div>
					<div class="swiper-pagination"></div>
                    
				</div>
			</div>
		</div>
		<div class="main-right2-border fl">
				<div class="right2_inner">
					<h2 class="section_title"><img src="images/warning.png"></h2>
					<!--<p class="more">更多</p>-->
					<div class="tableDiv2_lc" >
						<table>
							<thead>
							<th>预警类型</th>
							<th>预警描述</th>
							<th>预警时间</th>
							<th>处理状态</th>
							<th>备注</th>
							<!--<th>操作</th>-->
							</thead>
							<tbody id="warn">
							   
							</tbody>
						</table>
					</div>
					<div class="btnsDiv">
						<div class="btns_container">
							<p class="fl"><img src="images/bg_right2_icon1.png" alt="">今日预警 <i id="total">-</i></p>
							<p class="fr"><img src="images/bg_right2_icon2.png" alt="">未处理<i style="color: #c9c900" id="waitCount">-</i></p>
						</div>
					</div>
				</div>
		</div>
		<div class="main-right3-border fl">
			<div class="right3_inner">
				<h2 class="section_title"><img src="images/break_project.png"></h2>
				<div class="charts4"></div>
			</div>
		</div>
		<div class="main-right4-border fl">
			<div class="right4_inner">
				<h2 class="section_title"><img src="images/hidden_month.png"></h2>
				<div id="charts5"></div>
			</div>
		</div>
    </div>
</div>
<script type="text/javascript">
    var apiUrl = "http://127.0.0.1/erchtmsapp/api/";
    //设置日期格式
    function formatDate(v, format) {
        if (!v) return "";
        var d = v;
        if (typeof v === 'string') {
            if (v.indexOf("/Date(") > -1)
                d = new Date(parseInt(v.replace("/Date(", "").replace(")/", ""), 10));
            else
                d = new Date(Date.parse(v.replace(/-/g, "/").replace("T", " ").split(".")[0]));//.split(".")[0] 用来处理出现毫秒的情况，截取掉.xxx，否则会出错
        }
        var o = {
            "M+": d.getMonth() + 1,  //month
            "d+": d.getDate(),       //day
            "h+": d.getHours(),      //hour
            "m+": d.getMinutes(),    //minute
            "s+": d.getSeconds(),    //second
            "q+": Math.floor((d.getMonth() + 3) / 3),  //quarter
            "S": d.getMilliseconds() //millisecond
        };
        if (/(y+)/.test(format)) {
            format = format.replace(RegExp.$1, (d.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(format)) {
                format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
            }
        }
        return format;
    };
    //设置时间
    function setTime() {
        var currDate = new Date();
        var strDate =(currDate.getMonth() + 1) + "-" + currDate.getDate();
        $("#date").text(strDate);
        var hour = currDate.getHours() < 10 ? "0" + currDate.getHours() : currDate.getHours();
        var min = currDate.getMinutes() < 10 ? "0" + currDate.getMinutes() : currDate.getMinutes();
        var sec = currDate.getSeconds() < 10 ? "0" + currDate.getSeconds() : currDate.getSeconds();
        $("#time").text(hour + ":" + min + ":" + sec);
    }
    //获取安全生产天数
    function getDays() {
        $.get(apiUrl + "basedata/GetSafeDays", function (data) {
            if (data.length > 0) {
                $("#safeDays").text(data);
            }
        });
    }
    //定时刷新数据
    function refreshData() {
        $.get("../../login/ImitateLogin", { args: "4894DC460DCF31DBF469DF6EB76E99BF0362E1B7008513AAB2C18C66AEDBD14C48C45A783BCAAFD5F1D8E40363059762" }, function (data) {
            var json = $.parseJSON(data);
            if (json.type==1) {
                getSafeStatus();
                getDays();//安全生产天数
                getNews();//通知公告
                getWork();//实时工作
                getWarn();//预警中心
                getIndexData();//安全指标
                getNoCloseHTInfo();//未闭环隐患统计
                getProjectStat();  //获取外包工程建设情况
                getWorkStat();//高风险作业统计
                getHTChangeStat();//隐患整改情况统计
                getWZStat();//违章统计
                GetMonthHTStat();//月度隐患趋势统计
            } else {
                window.location.href = "../../login/signin?args=A5F094496C3F013753D47B30F41695561A19ED21A34637FE75A39B5760ABCEA7E09BE6F29B0A3FCA637E3B318AE95A4F6B6E2DAD92243EFC8F772EC92407E9C2";
            }
           
        });
    }
    //通知公告
    function getNews() {
        $.ajax({
            dataType: "json",
            type: "post",
            url: "../../desktop/getNotices",
            success: function (json) {
                if (json.type == 1) {
                    var data = json.resultdata;
                    var html = "";
                    if (data.length == 0) {
                        html = "<p style='color:white;'>暂无通知公告</p>";
                    } else {
                        var title = data[0].title;
                        title = title.length > 30 ? title.substring(0, 30) : title;
                        //$(json).each(function (j, item) {
                        html = "<p>" + title + "<span>" + data[0].time + "</span></p>";
                        //});
                    }
                    $("#notices").html(html);
                }
            }
        });
    }
    //预警中心
    function getWarn() {
        $.ajax({
            dataType: "json",
            type: "get",
            url: "../../desktop/getWarn",
            success: function (json) {
                if (json.type == 1) {
                    var html = "";
                  
                    $(json.resultdata.data).each(function (j, item) {
                        var desc = item.WorkDescribe == null ? "" : item.WorkDescribe;
                        desc = desc.length > 30 ? desc.substring(0, 30)+"..." : desc;
                        var remark = item.Remark == null ? "" : item.Remark;
                        remark = remark.length > 20 ? remark.substring(0, 20) : remark;
                        html += '<tr><td>' + (item.ModuleType == null ? "" : item.ModuleType) + '</td><td title="' + item.WorkDescribe + '">' + desc + '</td><td>08:30</td><td>未处理</td><td title="' + item.Remark + '">' + remark + '</td><tr>';
                    });
                    $("#warn").html(html);
                    $("#total").text(json.resultdata.count);
                    $("#waitCount").text(json.resultdata.data.length);
                }
            }
        });
    }
    //实时工作
    function getWork() {
        $.ajax({
            dataType: "json",
            type: "get",
            url: "../../desktop/getrealtimework",
            success: function (json) {
                if (json.type == 1) {
                    var html = "";
                    $(json.resultdata).each(function (j, item) {
                        if (j < 5) {
                            var deptName = item.DeptName == null ? "" : item.DeptName;
                            deptName = deptName.length > 8 ? deptName.substring(0, 8) : deptName;
                            html += '<tr><td>' + formatDate(item.Time, "yyyy-MM-dd hh:mm") + '</td><td>' + deptName + '</td><td title=\"' + item.WorkDescribe + '\">' + (item.WorkDescribe.length > 25 ? item.WorkDescribe.substring(0, 25) + "..." : item.WorkDescribe) + '</td><tr>';
                        }
                    });
                    $("#work").html(html);
                }
            }
        });
    }
    //指标
    function loadData(data, mode) {
        var html = "";
        var divNum = 0;
        if (data.length % 4 == 0) {
            divNum = data.length / 4;
        }
        else {
            divNum = data.length / 4 + 1;
        }
        var divIndex = 0;
        var count = 0;
        $(data).each(function (index, ele) {
            var findex = index + 1;
            var isShow = false;
            if (ele.itemcode == "CKPLAN") {
                var arr = ele.Num.split(',');
                if (arr[0] != "0") {
                    isShow = true;
                }
            } else {
                if (parseInt(ele.Num) > 0) {
                    isShow = true;
                }

            }
            if (findex % 4 == 1) {
                divIndex++;
                html += "<div class=\"swiper-slide\">";
                if (mode == 1) {
                    html += '<div class="inner1"> <div class="inner1-rgiht"><ul class="clearfix modules_list">';
                }
                else {
                    html += '<div class="inner1"> <div class="inner1-rgiht"><ul class="clearfix modules_list">';
                }

            }
            var content = '<li><img src="../../' + ele.icon + '" /><p>' + ele.itemname + '</p><p><span>' + ele.Num + '</span></p></li>';
            html += content;
            if ((findex % 4 == 0 && divIndex <= divNum) || findex / 4 + 1 == divNum) {
                html += "</ul></div></div>";
                html += "</div>";
            }
        });
        //风险
        if (mode == 1) {
            $("#fxlist").html(html);
            
        }
       //隐患排查
        else if (mode == 2) {
            $("#htlist").html(html);
            
        }
        //违章
        else if (mode == 3) {
            $("#wzlist").html(html);
            
        }
    }
    //安全指标
    function getIndexData(){
        $.post("../../Desktop/PowerPlantSafetyHomePage", { itemType: "SSJK", mode: 0 }, function (data) {
            var json = $.parseJSON(data);
            if (json.type == 1) {
                //风险管控
                var fx = json.resultdata.filter(function (x) {
                    var typeCode = x.TypeCode == null ? "" : x.TypeCode;
                    return typeCode.indexOf('CJLDJSC-002') >= 0;
                });                loadData(fx,1);                //隐患排查                              var ht = json.resultdata.filter(function (x) {
                    var typeCode = x.TypeCode == null ? "" : x.TypeCode;
                    return typeCode.indexOf('CJLDJSC-003') >= 0;
                });                loadData(ht, 2);                //反违章                var wz = json.resultdata.filter(function (x) {
                    var typeCode = x.TypeCode == null ? "" : x.TypeCode;
                    return typeCode.indexOf('CJLDJSC-004') >= 0;
                });
                loadData(wz, 3);

                new Swiper('.swiper-container', {//一屏二屏切换
                    pagination: {
                        el: '.swiper-pagination'
                    },
                    autoplay: {
                        delay: 3000//切换时间
                    },
                    loop: true,

                })
                new Swiper('.swiper-content', {//
                    loop: false,
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev',
                    }
                })
            }
        });
    }
    //数据初始化
    $(function () {
        window.setInterval("refreshData()", 600000);//设置定时刷新相关数据
        setTime();//时间
        window.setInterval("setTime()", 1000);//刷新时间
        $.get("../../login/ImitateLogin", { args: "4894DC460DCF31DBF469DF6EB76E99BF0362E1B7008513AAB2C18C66AEDBD14C48C45A783BCAAFD5F1D8E40363059762" }, function (data) {
            var json = $.parseJSON(data);
            if (json.type == 1) {
                getSafeStatus();
                getDays();//安全生产天数
                getNews();//通知公告
                getWork();//实时工作
                getWarn();//预警中心
                getIndexData();//安全指标
                getNoCloseHTInfo();//未闭环隐患统计
                getProjectStat();  //获取外包工程建设情况
                getWorkStat();//高风险作业统计
                getHTChangeStat();//隐患整改情况统计
                getWZStat();//违章统计
                GetMonthHTStat();//月度隐患趋势统计
            } else {
                window.location.href = "../../login/signin?args=A5F094496C3F013753D47B30F41695561A19ED21A34637FE75A39B5760ABCEA7E09BE6F29B0A3FCA637E3B318AE95A4F6B6E2DAD92243EFC8F772EC92407E9C2";
            }
        });
		$('.activ-a').click(function(){
			$(this).parent().css('background','url(img/1.png) no-repeat')
		})
		$('.activ-b').click(function(){
			$(this).parent().css('background','url(img/2.png) no-repeat')
		})
		$('.activ-c').click(function () {
		    $(this).parent().css('background', 'url(img/3.png) no-repeat')
		});
		
    })

    //获取外包工程建设情况
    function getProjectStat() {
        $.post(apiUrl + "WorkMeeting/GetTempProjectData", function (json) {
            if (json.code == 0) {
                $("#OutProject").html("");
                if (json.data.tempData.length > 0) {
                    $("#OutProjectNoData").hide();
                var data = [];
                $(json.data.tempData).each(function (index, ele) {
                    data = $.merge(data, ele.ProList);
                })
                console.log(data);
                $(data).each(function (index, ele) {
                    var head = "<div class=\"swiper-slide\"><div class=\"tableDiv1\"><div class=\"right1_header1 clearfix\"><div class=\"right1_left fl\"><img src=\"images/bg_right1_icon1.png\" alt=\"\"></div>";
                    head += "<div class=\"right1_right fr\"><div class=\"top\">【全厂】外包工程数量</div><div class=\"bottom clearfix\"><div class=\"b_left fl clearfix\"><span class=\"fl\">进行中工程数量</span>";
                    head += "<span class=\"fr\">" + json.data.totalProNum + " 个</span></div><div class=\"b_right fr\"><span class=\"fl\">施工人数</span><span class=\"fr\">" + json.data.totalPersonNum + " 人</span></div></div></div></div></div>";

                    var body = "<div class=\"right1_header2\"><div class=\"top clearfix\"><h3 class=\"fl\">外包单位: <span>" + ele.UnitName + "</span></h3><p class=\"fr\">风险等级: ";
                    body += GetRiskColor(ele.RiskLevel) + "</p></div><div class=\"bottom clearfix\"><div class=\"b fl\"><img class=\"icon\" src=\"images/bg_right1_icon4.png\" />";
                    body += "工程名称: <span>" + cutString(ele.ProName,8) + "</span></div><div class=\"b fl tx_center\"><img class=\"icon\" src=\"images/bg_right1_icon2.png\" /> 施工人数: <span>" + ele.RealperNum + "人</span>";
                    body += "</div><div class=\"b fr tx_right\"><img class=\"icon\" src=\"images/bg_right1_icon3.png\" />责任部门负责人: <span>" + ele.DeptPersonName + "</span></div></div></div>";

                    if (index % 2 == 0) {
                        $("#OutProject").append(head);
                    }
                    $("#OutProject .swiper-slide").eq(parseInt(index / 2)).find(".tableDiv1").eq(0).append(body);
                })
                new Swiper('.swiper-container1', {//一屏二屏切换
                    pagination: {
                        el: '.swiper-pagination'
                    },
                    autoplay: {
                        delay: 3000//切换时间
                    },
                    loop: true,

                })
            }
                else {
                    $("#OutProjectNoData").html('<center>暂无数据可显示</center>');
                    $("#OutProject").hide();
                }
                
            }
        });
    }
    function GetRiskColor(risk) {
        var str = "";
        switch (risk) {
            case "一级风险":
                str = "<span class=\"risk_level1\">一级风险</span>";
                break;
            case "二级风险":
                str = "<span class=\"risk_level2\">二级风险</span>";
                break;
            case "三级风险":
                str = "<span class=\"risk_level3\">三级风险</span>";
                break;
            case "四级风险":
                str = "<span class=\"risk_level4\">四级风险</span>";
                break;
            default:
        }
        return str;
    }

    //截取字符串
    function cutString(str, len) {
        if (str != null && str != undefined) {
            if (str.length > len) {
                return str.substring(0, len) + "...";
            } else {
                return str;
            }
        } else {
            return "";
        }

    }
</script>
</body>
</html>