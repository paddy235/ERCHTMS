@{;
ViewBag.Title = "表单页面";
Layout = "~/Views/Shared/_Form.cshtml";
}

<script src="~/Content/scripts/plugins/ckeditor/ckeditor.js"></script>
<script src="~/Content/scripts/plugins/simditor/js/module.min.js"></script>
<script src="~/Content/scripts/plugins/simditor/js/uploader.min.js"></script>
<script src="~/Content/scripts/plugins/simditor/js/hotkeys.min.js"></script>
<link href="~/Content/scripts/plugins/cxColor/css/jquery.cxcolor.css" rel="stylesheet" />
<script src="~/Content/scripts/plugins/cxColor/js/jquery.cxcolor.js"></script>
<script type="text/javascript" src="~/content/scripts/business/common.js"></script>
<!--webUploader文件上传组件-->
<link href="~/content/scripts/plugins/webuploader/webuploader.css" rel="stylesheet" />
<link href="~/content/scripts/plugins/webuploader/webuploader-demo.css" rel="stylesheet" />
<script type="text/javascript" src="~/content/scripts/plugins/webuploader/webuploader.min.js"></script>
<script type="text/javascript" src="~/content/scripts/business/fileupload.js"></script>

<script src="~/Content/scripts/plugins/combo-select/jquery.combo.select.js"></script>
<link rel="stylesheet" href="~/Content/scripts/plugins/combo-select/combo.select.css">

<style>
    .form .formTitle {
        width: 110px;
    }

    .combo-select {
        max-width: initial;
    }

    .OutProjectName {
        width: 100%;
    }

    .form .formValue select {
        padding: 0px;
    }

    .filePicker > div {
        width: 102px;
        height: 37px;
    }
</style>
<script>
    var rolename = '@ERCHTMS.Code.OperatorProvider.Provider.Current().RoleName';
    var userid = '@ERCHTMS.Code.OperatorProvider.Provider.Current().UserId';
    var username = '@ERCHTMS.Code.OperatorProvider.Provider.Current().UserName';
    var deptid = '@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptId';
    var deptcode = '@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptCode';
    var deptname = '@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptName';
    var isldap = '@(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetItemValue("IsOpenPassword"))';
    var mode = request('mode');
    var keyValue = request('keyValue');          //主键ID
    var FAZLFILES = "";
    var flag = true;
    var riskFlag = false;
    var curflowid = "";
    $(function () {
        initControl();
        loadAuditList();
        //加载作业安全分析
        GetRiskGrid();
        ///加载人员信息
        GetPersonGrid();
        //$("#tr_liftscheme").hide();
    });

    //加载审核记录
    function loadAuditList() {
        //-审核记录
        var $gridTable = $('#LifthoistAudit');
        $gridTable.jqGrid({
            autowidth: true,
            height: 'auto',
            url: "../../HighRiskWork/Lifthoist/GetAuditListToJson?businessid=" + keyValue,
            postData: {},
            datatype: "json",
            colModel: [
                { label: '审核部门', name: 'AUDITDEPTNAME', width: '110', sortable: false, align: 'center' },
                { label: '审核人', name: 'AUDITUSERNAME', width: '110', sortable: false, align: 'center' },
                {
                    label: '审核时间', name: 'AUDITDATE', width: '110', sortable: false, align: 'center', formatter: function (cellvalue, options, rowObject) {
                        return formatDate(rowObject.AUDITDATE, 'yyyy-MM-dd hh:mm');
                    }
                },
                {
                    label: '审核结果', name: 'AUDITSTATE', width: '100', sortable: false, align: 'center', formatter: function (cellvalue, options, rowObject) {
                        if (rowObject.AUDITSTATE == 1)
                            return "同意";
                        return "不同意";
                    }
                },
                {
                    label: '签名', name: 'AUDITSIGNIMG', index: 'AUDITSIGNIMG', width: 150, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var content = !!rowObject.AUDITSIGNIMG ? rowObject.AUDITSIGNIMG : "";
                        var html = "";
                        if (content == "" || content == undefined) {
                            var html = "<img  style=\"height:50px;\" />&nbsp;";
                        } else {
                            html = "<img style=\"height:50px;\"  src=\"" + content + "\"/>&nbsp;";
                        }

                        return html;
                    }
                },
                { label: '审核意见', name: 'AUDITREMARK', width: '100', sortable: false, align: 'center' }
            ],
            cellsubmit: 'clientArray',
            multiselect: false,
            viewrecords: true,
            onSelectRow: function () {
            },
            gridComplete: function () {
            }
        });
    }
    //初始化控件
    function initControl() {

        if (isldap == "true") {
            $("#tdWorkDate").html("").html("作业时间<font face=\"宋体\">*</font>");
        }
        if (mode == "add" || mode == "edit") {
            riskFlag = true;
            $("#select,#choose1").removeAttr("disabled");
        }
        //吊装工具名称
        $("#TOOLNAME").ComboBox({
            param: { EnCode: "ToolName" },
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            description: "==请选择==",
            id: "ItemValue",
            text: "ItemName",
            height: "230px"
        });

        $("#QUALITYTYPE").ComboBox({
            param: { EnCode: "LifthoistQualityType" },
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            description: "==请选择==",
            id: "ItemValue",
            text: "ItemName",
            height: "230px"
        }).change(function () {
            if ($(this).attr("data-value") == "0") {
                $("#tr_liftscheme").hide();
            } else {
                $("#tr_liftscheme").show();
            }
        });

        if (rolename.indexOf("承包商") >= 0 || rolename.indexOf("分包商") >= 0) {
            $("input[name='WORKDEPTTYPE']:eq(1)").prop("checked", "checked");
            $("input[name='WORKDEPTTYPE']").attr("disabled", "disabled");
            $("#td_title_projectname").show();
            $("#td_value_projectname").show();

        }
        else {
            $("input[name='WORKDEPTTYPE']:eq(0)").prop("checked", "checked");
            $("#td_title_projectname").hide();
            $("#td_value_projectname").hide();
            $("#ENGINEERINGNAME").removeAttr("checkexpession").removeAttr("isvalid");
        }

        if (isldap) {
            $("#td_title_projectname").hide();
            $("#td_value_projectname").hide();
            $("#ENGINEERINGNAME").removeAttr("checkexpession").removeAttr("isvalid");
            GetSpecialty("", "");  //华润电力 专业类别不关联工程跟作业单位
        }
        //选择作业单位类别时，控制工程名称显示
        $("input[name='WORKDEPTTYPE']").click(function () {
            //0:单位内部,1:外包单位
            if ($(this).val() == "0") {
                $("#td_title_projectname").hide();
                $("#td_value_projectname").hide();
                $("#ENGINEERINGNAME").removeAttr("checkexpession").removeAttr("isvalid");
            } else {
                $("#td_title_projectname").show();
                $("#td_value_projectname").show();
                $("#ENGINEERINGNAME").attr("checkexpession", "NotNull").attr("isvalid", "yes");
            }
            //清空文本框(作业单位,工程,作业人员,作业区域)
            $("#CONSTRUCTIONUNITNAME,#CONSTRUCTIONUNITID,#CONSTRUCTIONUNITCODE,#ENGINEERINGID,#ENGINEERINGNAME").val("");
            $("#SPECIALTYTYPE").html("");
            $("#SPECIALTYTYPE").append('<option value="">请选择</option>');
            clearUser();
        });

        //查看
        if (mode == "view") {
            $("#btn_Save").hide();
            $("#btn_Submit").hide();
            $("#btn_Audit").hide();
            $("#btn_Transfer").hide();
            $("#panel_audit").hide();
            //$("input:text,select,textarea").each(function () {
            //    $(this).attr("disabled", "disabled");
            //});
            $("#form1 input,textarea,select, .ui-select, .ui-select-text , .ui-select-option-content").each(function (ele, index) {
                $(this).attr("disabled", "disabled");
            });
            $("#chooseperson").attr("disabled", "disabled");
            flag = false;
        } else if (mode == "audit") {
            $("#btn_Save").hide();
            $("#btn_Submit").hide();
            $("#panel_info").find("input,select,textarea,.ui-select, .ui-select-text , .ui-select-option-content").each(function () {
                $(this).attr("disabled", "disabled");
            });
            $("#chooseperson").attr("disabled", "disabled");
            flag = false;
        } else {
            $("#historyRecord").hide();
            //编辑或新增
            $("#btn_Transfer").hide();
            $("#panel_audit").hide();
            $("#panel_auditrecord").hide();
            $("#btn_Audit").hide();
            //是否可上传
            flag = true;
        }

        //区域的处理
        $("#WORKAREANAME").attr("onclick", "selectArea(window.document.body, 'WORKAREANAME,WORKAREACODE');").attr("placeholder", "请选择吊装施工区域");

        //获取表单
        if (!!keyValue) {
            $.SetForm({
                url: "../../HighRiskWork/Lifthoist/GetFormJson",
                param: { keyValue: keyValue },
                success: function (data) {
                    $("#form1").formDeserialize(data)
                    if (data.QUALITYTYPE == 0) {
                        $("#tr_liftscheme").hide();
                    } else {
                        $("#tr_liftscheme").show();
                    }
                    if (data.WORKDEPTTYPE == "0") {//单位内部
                        $("input[name='WORKDEPTTYPE']:eq(0)").prop("checked", "checked");
                        $("#td_title_projectname").hide();
                        $("#td_value_projectname").hide();
                        $("#ENGINEERINGNAME").removeAttr("checkexpession").removeAttr("isvalid");
                        GetSpecialty(data.CONSTRUCTIONUNITID, data.SPECIALTYTYPE);
                    }
                    if (data.WORKDEPTTYPE == "1") {//外包单位
                        $("input[name='WORKDEPTTYPE']:eq(1)").prop("checked", "checked");
                        $("#td_title_projectname").show();
                        $("#td_value_projectname").show();
                        $("#ENGINEERINGNAME").attr("checkexpession", "NotNull").attr("isvalid", "yes");
                        GetSpecialty(data.ENGINEERINGID, data.SPECIALTYTYPE);
                    }
                    if (isldap) {
                        $("#td_title_projectname").hide();
                        $("#td_value_projectname").hide();
                        $("#ENGINEERINGNAME").removeAttr("checkexpession").removeAttr("isvalid");
                        GetSpecialty("", data.SPECIALTYTYPE);  //华润电力 专业类别不关联工程跟作业单位
                    }
                    FAZLFILES = data.FAZLFILES;
                    curflowid = data.FLOWID;
                    if (data.AUDITSTATE != 2) {
                        $("#historyRecord").hide();
                    }
                }
            })
        } else {
            //初始化上传组件
            keyValue = "@Guid.NewGuid().ToString()";
            FAZLFILES = "@Guid.NewGuid().ToString()";
        }

        file_upload.init({
            keyValue: FAZLFILES, extensions: '', isImage: true, el: '#uploader1'
        });
        file_upload.init({
            keyValue: keyValue, extensions: '', isImage: false, el: '#uploader2'
        });
        file_upload.bindFiles(flag, false, keyValue, 'uploader2', flag);
        file_upload.bindFiles(flag, true, FAZLFILES, 'uploader1', flag);

        $("#btn_Save").click(function () {
            AcceptClick(0);
        });
        $("#btn_Submit").click(function () {
            AcceptClick(1);
        });

        //审批转交
        $("#btn_Transfer").click(function () {
            TransferAction();
        });

    }

    //选择作业单位
    function selectCompany() {
        var setupcompanytype = $("input[type=radio]:checked").val();
        /**
        1.选择单位内部时，工程名称隐藏,当前角色为“厂级部门”，作业单位为所有单位不包含承包商，否则为作业单位本部门及以下单位。
        2.选择外包单位时，工程名称显示,当前角色为“厂级部门”，作业单位为所有外包单位,否则作业单位为本部门及以下级部门管辖的外包单位。
        3.另工程名称为选择作业单位后单位管辖的工程，选择工程后把作业区域代入文本框。
        **/
        //当前角色为“厂级部门”，作业单位为所有单位，否则为本部门及下及部门单位
        if (setupcompanytype == "0") {
            selectDept('&type=highrisk', 0, 4, '选择吊装施工单位', document.body, 'CONSTRUCTIONUNITNAME,CONSTRUCTIONUNITCODE,CONSTRUCTIONUNITID', "1", function () {
                clearUser();
                var departid = $("#CONSTRUCTIONUNITID").val();
                $("#SPECIALTYTYPE").html('');
                $("#SPECIALTYTYPE").append('<option value="">请选择</option>');
                GetSpecialty(departid, "");
            });

        } else {
            selectDept('', 0, 7, '选择吊装施工单位', document.body, 'CONSTRUCTIONUNITNAME,CONSTRUCTIONUNITCODE,CONSTRUCTIONUNITID', "1", function () {
                clearUser();
                if (!isldap) {
                    $("#ENGINEERINGID,#ENGINEERINGNAME").val("");
                    $("#SPECIALTYTYPE").html('');
                    $("#SPECIALTYTYPE").append('<option value="">请选择</option>');
                }
                
            });
        }
    }

    function clearUser() {
        //清空与之关联的作业负责人,作业监护人,作业人员
        $("#WorkUserNames,#WorkUserIds,#WorkDutyUserName,#WorkDutyUserId,#WorkTutelageUserName,#WorkTutelageUserId").val("");
    }

    //选择工程
    function chooseProject() {
        if (!!$("#CONSTRUCTIONUNITNAME").val()) {
            SelectOutProject(window.document.body, 'ENGINEERINGNAME,ENGINEERINGID', $("#CONSTRUCTIONUNITID").val(), function () {
                var engineeringid = $("#ENGINEERINGID").val()
                $("#SPECIALTYTYPE").html('');
                $("#SPECIALTYTYPE").append('<option value="">请选择</option>');
                GetSpecialty(engineeringid, "");
                GetEngineerInfo(engineeringid);
            });

        }
        else {
            dialogMsg('请先选择作业单位！', 0);
        }

    }

    //获取工程详情
    function GetEngineerInfo(id) {
        $.SetForm({
            url: "../../OutsourcingProject/Outsouringengineer/GetFormJson?keyValue=" + id,
            success: function (data) {
                $("#WorkAreaName").val(data.data.ENGINEERAREANAME);
            }
        })
    }

    //获取部门下的专业类别
    function GetSpecialty(departid, stype) {
        var specialtytype = stype;
        if (mode == "edit" || mode == "add") {
            specialtytype = "";
        }
        var workdepttype = $("input[name='WORKDEPTTYPE']:checked").val();
        if (isldap) {
            departid = '@(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetItemValue("LifthoistDept"))';
        }
        var flag = false;
        $.ajax({
            url: "../../HighRiskWork/Scaffold/GetSpecialtyToJson?deptid=" + departid + "&specialtytype=" + specialtytype + "&workdepttype=" + workdepttype,
            asycn: true,
            type: 'get',
            success: function (data) {
                if (!!data) {
                    var json = JSON.parse(data);
                    for (var i = 0; i < json.length; i++) {
                        if (stype == json[i].itemvalue) {
                            $("#SPECIALTYTYPE").append('<option value="' + json[i].itemvalue + '" selected="selected">' + json[i].itemname + '</option>');
                        }
                        else {
                            $("#SPECIALTYTYPE").append('<option value="' + json[i].itemvalue + '">' + json[i].itemname + '</option>');
                        }
                    }
                }
            }
        });
    }

    function TransferAction() {
        var url = '/HighRiskWork/HighRiskCommonApply/TransferForm?keyValue=' + keyValue + "&FlowId=" + curflowid;
        idx = dialogOpen({
            id: "Transfer",
            title: '审批转交',
            url: url,
            width: ($(top.window).width() * 0.4) + "px",
            height: ($(top.window).height() * 0.4) + "px",
            callBack: function (iframeId) {
                top.document.getElementById(iframeId).contentWindow.AcceptClick();
                //top.layer.close(idx);
                //$.currentIframe().$("#gridTable").trigger("reloadGrid");
            },
            cancel: function (index) {
            }
        });
    }
    //保存表单;
    function AcceptClick(auditstate) {
        if (!$('#form1').Validform()) {
            return false;
        }

        if ($("#QUALITYTYPE").attr("data-value") != "0" && !($("#uploader2 .queueList .filelist").find("tr[style!='display:none;']").length > 1)) {
            dialogMsg('请上传起吊方案！', 0);
            return false;
        }
        var person=$("#gridPerson").jqGrid('getRowData');
        if (person.length == 0) {
            dialogMsg('请先添加人员信息！', 0);
            return false;
        }
        var postData = $("#form1").formSerialize(keyValue);
        postData["AuditState"] = auditstate;
        postData["FAZLFILES"] = FAZLFILES;
        postData["QUALITYTYPENAME"] = $("#QUALITYTYPE").attr("data-text");
        postData["SPECIALTYTYPENAME"] = $("#SPECIALTYTYPE option:selected").text();
        //存储作业单位类别
        var unittype = $("input[name='WORKDEPTTYPE']:checked").val();
        postData["WORKDEPTTYPE"] = unittype;

        var $gridTable = $('#gridAnalyse');
        var risk = $gridTable.jqGrid('getRowData');
        var arr = [];
        var flag = false;
        for (var i = 0; i < risk.length; i++) {
            var dom = risk[i];
            if (($.trim($gridTable.find("textarea[name='atrisk']").eq(i).val()).length == 0 || $.trim($gridTable.find("textarea[name='controls']").eq(i).val()).length == 0 || $.trim($gridTable.find("textarea[name='worktask']").eq(i).val()).length == 0 || $.trim($gridTable.find("textarea[name='workprocess']").eq(i).val()).length == 0) && !flag) {
                flag = true;
            } else {
                if ($.trim($gridTable.find("textarea[name='worktask']").eq(i).val()).length <= 500) {
                    arr.push({
                        WorkTask: $gridTable.find("textarea[name='worktask']").eq(i).val(),
                        WorkProcess: $gridTable.find("textarea[name='workprocess']").eq(i).val(),
                        AtRisk: $gridTable.find("textarea[name='atrisk']").eq(i).val(),
                        Controls: $gridTable.find("textarea[name='controls']").eq(i).val(),
                        WorkId: keyValue,
                        Id: newGuid(),
                        CreateDate: formatDate(new Date(), "yyyy-MM-dd hh:mm:ss")
                    });
                } else {
                    dialogMsg("工作任务字符过大,不可超过500个字符！", 2);
                    return false;
                }
            }
        }
        if (flag) {
            dialogMsg("工作任务、工序、风险描述和控制措施都不能为空！", 2);
            return false;
        }
        postData["RiskRecord"] = arr;

        $.SaveForm({
            url: "../../HighRiskWork/Lifthoist/SaveForm?keyValue=" + keyValue,
            param: { jsonData: JSON.stringify(postData) },
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        })
    }
    //审核提交
    function AuditSubmit() {
        if (!$('#form1').Validform()) {
            return false;
        }
        var auditresult = $("input[name='AuditState']:checked").val();
        if (auditresult == "" || auditresult == undefined) {
            dialogAlert("审核结果未勾选,无法进行提交!!!", function () {
                return false;
            })
            return false;
        }
        var postData = {
            BusinessId: $("#BusinessId").val(),
            AuditUserId: $("#AuditUserId").val(),
            AuditUserName: $("#AuditUserName").val(),
            AuditDeptId: $("#AuditDeptId").val(),
            AuditDeptName: $("#AuditDeptName").val(),
            AuditDeptCode: $("#AuditDeptCode").val(),
            AuditRemark: $("#AuditRemark").val(),
            AuditDate: $("#AuditDate").val(),
            AuditState: auditresult,
            AUDITSIGNIMG: $("#AuditSignImg").attr("src")
        };
        $.SaveForm({
            url: "../../HighRiskWork/Lifthoist/AuditSubmit?keyValue=" + keyValue,
            param: { jsonData: JSON.stringify(postData) },
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        });
    }
    //导出
    //function ExportDoc() {
    //    location.href = "../../HighRiskWork/Lifthoist/ExportDoc?keyValue=" + keyValue;
    //}

    //加载作业安全分析
    function GetRiskGrid() {
        var $gridTable = $('#gridAnalyse');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/HighRiskCommonApply/GetRiskListJson",
            postData: { workId: keyValue },
            datatype: "json",
            height: "200px",
            autowidth: true,
            colModel: [
                { label: '主键', name: 'Id', hidden: true },
                {
                    label: '操作', name: 'Oper', width: 80, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        if (riskFlag) {
                            html += "&nbsp;&nbsp;<a href=javascript:delRow('" + rowObject.Id + "',this)  title='删除'><i class='fa fa-trash-o'></i></a>";
                        }
                        return html;
                    }
                },
                {
                    label: '工作任务', name: 'WorkTask', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="worktask" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:50px;" class="form-control"';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                },
                {
                    label: '工序', name: 'WorkProcess', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="workprocess" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:50px;" class="form-control"> ';
                        html += !!rowObject.WorkProcess ? rowObject.WorkProcess : "";
                        html += '</textarea>';
                        return html;
                    }
                },
                {
                    label: '风险描述', name: 'AtRisk', width: 250, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="atrisk" ' + str + ' role="textbox" maxlength="500"  style="width: 100%;height:50px;" class="form-control" ';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                },
                {
                    label: '风险控制措施', name: 'Controls', width: 200, sortable: false, align: 'center'
                    , formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="controls" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:50px;" class="form-control" ';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                }
            ],
            viewrecords: true,
            rowNum: 100000,
            sortname: 'CreateDate',
            sortorder: 'desc',
            rownumbers: true,
            shrinkToFit: false,
            gridview: true

        });
    }



    //删除数据行
    function delRow(id, obj) {
        var jqTable = $("#gridAnalyse");
        var idx = dialogConfirm("确认删除吗？", function (isSure) {
            if (isSure) {
                jqTable.delRowData(jqTable.getGridParam('selrow'));
                top.layer.close(idx);
            } else {
                top.layer.close(idx);
            }
        });
    }

    //添加行
    function addItems(obj) {
        var rowId = $("#gridAnalyse").jqGrid('getRowData').length;
        $("#gridAnalyse").addRowData(rowId, { ID: newGuid(), WorkTask: "", WorkProcess: "", AtRisk: "", Controls: "" }, "first");
    }


    //从风险库中选择数据
    function selRisk() {
        dialogOpen({
            id: 'SelectRisk',
            title: '选择工作任务',
            url: '/HighRiskWork/HighRiskCommonApply/Select?worktypevale=7',
            width: ($(window).width() - 200) + 'px',
            height: ($(window).height() - 20) + 'px',
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick(window.document.body);
            }
        })
    }

    //加载人员信息
    function GetPersonGrid() {
        var $gridTable = $('#gridPerson');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/Lifthoistperson/GetPersonListJson",
            postData: { workId: keyValue },
            datatype: "json",
            height: "200px",
            autowidth: true,
            colModel: [
                { label: '主键', name: 'id',index:'id', hidden: true },
                {
                    label: '操作', name: 'Oper', width: 80, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        html += "<a href=javascript:showPerson('" + rowObject.id + "')  title='查看'><i class='fa fa-eye'></i></a>";
                        if (riskFlag) {
                            html += "<a href=javascript:editPerson('" + rowObject.id + "')  title='编辑'><i class='fa fa-pencil-square-o'></i></a>";
                            html += "<a href=javascript:delPerson('" + rowObject.id + "')  title='删除'><i class='fa fa-trash-o'></i></a>";
                        }
                        return html;
                    }
                },
                {
                    label: '人员类型', name: 'persontype', width: 200, align: 'center', sortable: false
                },
                {
                    label: '人员姓名', name: 'personname', width: 200, align: 'center', sortable: false
                },
                {
                    label: '所属单位', name: 'belongdeptname', width: 200, align: 'center', sortable: false
                },
                {
                    label: '证件号', name: 'certificatenum', width: 250, align: 'center', sortable: false
                },
                {
                    label: '附件', name: 'Controls', width: 200, sortable: false, align: 'center'
                    , formatter: function (cellvalue, options, rowObject) {

                        if (rowObject.filenum == 0) {
                            html = "否";
                            return html;

                        } else if (rowObject.filenum > 0) {
                            html = "<a href=javascript:btn_Annex('" + rowObject.id + "') style='color:blue; text-decoration:underline;padding-left:0px;' title='修改'>是</a>";
                            return html;

                        }
                    }
                }
            ],
            rownumbers: true,
            shrinkToFit: true,
            gridview: true,
            viewrecords: true,
            rowNum: 30,
            rowList: [30, 50, 100],
            pager: "#PersonPager"

        });
    }

    function addPerson() {
        var url = "/HighRiskWork/Lifthoist/OperatePerson?mode=add&recid=" + keyValue;
        idx = dialogOpen({
            id: "Details",
            title: "新增人员信息",
            url: url,
            width: $(window).width() + "px",
            height: $(window).height() + 'px',
            callBack: function (iframeId) {
                top.document.getElementById(iframeId).contentWindow.AcceptClick();
                //$("#gridPerson").trigger('reloadGrid');
            }
        });
    }

    function editPerson(id) {
        var url = "/HighRiskWork/Lifthoist/OperatePerson?mode=edit&recid=" + keyValue + "&keyValue=" + id;
        idx = dialogOpen({
            id: "Details",
            title: "编辑人员信息",
            url: url,
            width: $(window).width() + "px",
            height: $(window).height() + 'px',
            callBack: function (iframeId) {
                top.document.getElementById(iframeId).contentWindow.AcceptClick();
                $("#gridPerson").trigger('reloadGrid');
            }
        });
    }

    function showPerson(id) {
        var url = "/HighRiskWork/Lifthoist/OperatePerson?mode=show&recid=" + keyValue + "&keyValue=" + id;
        idx = dialogOpen({
            id: "Details",
            title: "查看人员信息",
            url: url,
            width: $(window).width() + "px",
            height: $(window).height() + 'px',
            btn: ["关闭"],
            callBack: function (iframeId) {
                top.layer.close(idx);
            }
        });
    }

    function delPerson() {
        var keyValue = $('#gridPerson').jqGridRowValue('id');
        if (keyValue) {
            var url = '../../HighRiskWork/Lifthoistperson/RemoveForm?keyValue=' + keyValue;
            $.RemoveForm({
                url: url,
                success: function (data) {
                    $('#gridPerson').trigger('reloadGrid');
                }
            })
        } else {
            dialogMsg('请选择需要删除的人员信息！', 0);
        }
    }

    //查看附件
    function btn_Annex(id) {
        var keyValue = id;
        if (checkedRow(keyValue)) {
            var dlg = dialogOpen({
                id: 'Annex',
                title: '附件列表',
                url: '/OccupationalHealthManage/Occupatioalstaff/FileList?keyValue=' + keyValue,
                width: '600px',
                height: '550px',
                btn: ["关闭"],
                callBack: function (iframeId) {
                    top.layer.close(dlg);
                }
            })
        }
    }

    function auditCheck(obj) {
        var signImg = getUserSignPic(userid);
        if (signImg != "" && signImg != undefined) {
            $("#AuditSignImg").attr("src", "../.." + signImg);
        } else {
            $(obj).get(0).checked = false;
        }


    }

    function ExportInfo() {
        window.location.href = "ExportInfo?keyValue=" + keyValue;
    }
</script>
<div style="margin-left:5px;margin-right:5px;">
    <div id="div1"></div>
    <div id="panel_info" class="panel panel-default" style="padding-top:40px">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;起重吊装作业基本信息</strong>
            <span class="tools pull-right">
                <a href="#" id="historyRecord" style="font-weight: bold;" onclick="ExportInfo()" class="btn btn-primary btn-xs">导出作业信息</a>
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form">
                <tr>
                    <td id="titleTag" class="formTitle">申请单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYCOMPANYNAME" type="text" disabled="disabled" class="form-control" isvalid="yes" checkexpession="NotNull" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptName" />
                        <input id="APPLYCOMPANYCODE" type="hidden" class="form-control" isvalid="yes" checkexpession="NotNull" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptCode" />
                        <input id="APPLYCOMPANYID" type="hidden" class="form-control" isvalid="yes" checkexpession="NotNull" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptId" />
                    </td>
                    <td id="titleTag" class="formTitle">申请人<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYUSERNAME" type="text" disabled="disabled" class="form-control" isvalid="yes" checkexpession="NotNull" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().UserName" />
                        <input id="APPLYUSERID" type="hidden" class="form-control" isvalid="yes" checkexpession="NotNull" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().UserId" />
                    </td>
                </tr>
                <tr>
                    <td id="titleTag" class="formTitle">申请时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYDATE" type="text" disabled="disabled" class="form-control" isvalid="yes" checkexpession="NotNull" value="@DateTime.Now.ToString("yyyy-MM-dd HH:mm")" />
                    </td>
                    <td id="titleTag" class="formTitle">申请编号<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYCODESTR" type="text" disabled="disabled" class="form-control" placeholder="自动生成" />
                        <input id="APPLYCODE" type="hidden" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" id="tddept">作业单位类别<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="WORKDEPTTYPE" id="WORKDEPTTYPE1" value="0" />单位内部
                            </label>
                        </div>
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="WORKDEPTTYPE" id="WORKDEPTTYPE2" value="1" />外包单位
                            </label>
                        </div>
                    </td>
                    <td class="formTitle">吊装施工单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="CONSTRUCTIONUNITNAME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" maxlength="100" onclick="selectCompany()" readonly />
                        <input id="CONSTRUCTIONUNITID" type="hidden" class="form-control" />
                        <input id="CONSTRUCTIONUNITCODE" type="hidden" class="form-control" />
                    </td>
                    @*<td class="formTitle">作业单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="WorkDeptName" type="text" class="form-control" placeholder="请选择作业单位" isvalid="yes" checkexpession="NotNull" readonly onclick="selectCompany()" />
                        <input type="hidden" id="WorkDeptId" />
                        <input type="hidden" id="WorkDeptCode" />
                    </td>*@
                </tr>
                <tr>
                    <td class="formTitle" id="td_title_projectname">工程名称<font face="宋体">*</font></td>
                    <td class="formValue" id="td_value_projectname">
                        <input id="ENGINEERINGNAME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" readonly placeholder="请选择工程" onclick="chooseProject();" />
                        <input id="ENGINEERINGID" type="hidden" />
                    </td>
                    <td class="formTitle">专业类别<font face="宋体">*</font></td>
                    <td class="formValue">
                        <select id="SPECIALTYTYPE" name="SpecialtyType" class="form-control" isvalid="yes" checkexpession="NotNull">
                            <option value="">请选择</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">工作负责人<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="CHARGEPERSONNAME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" maxlength="50" onclick="selectUser({ deptId: '', checkMode: 0, mode: 0, winObject: window.document.body, domId: 'CHARGEPERSONNAME,,CHARGEPERSONID', userIds: $('#CHARGEPERSONID').val() });" readonly />
                        <input id="CHARGEPERSONID" type="hidden" class="form-control" />
                    </td>
                    <td class="formTitle">监护人<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="GUARDIANNAME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" maxlength="50" onclick="selectUser({ deptId: '', checkMode: 0, mode: 0, winObject: window.document.body, domId: 'GUARDIANNAME,,GUARDIANID', userIds: $('#GUARDIANID').val() });" readonly />
                        <input id="GUARDIANID" type="hidden" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">起吊重物质量描述<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="QUALITYTYPE" type="select" class="ui-select"  isvalid="yes" checkexpession="NotNull"></div>
                    </td>
                    <td class="formTitle">起吊重物质量<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input type="text" id="QUALITY" class="form-control" isvalid="yes" checkexpession="NotNull" />
                    </td>
                </tr>
                <tr>

                    <td class="formTitle">吊装工具名称<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="TOOLNAME" type="select" class="ui-select" isvalid="yes" checkexpession="NotNull"></div>
                    </td>
                    <td class="formTitle">吊装施工区域<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="WORKAREANAME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" readonly />
                        <input id="WORKAREACODE" type="hidden" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" id="tdWorkDate">计划作业时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div style="float:left;width:48%;">
                            <input id="WORKSTARTDATE" type="text" class="form-control input-wdatepicker" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm', maxDate: '#F{$dp.$D(\'WORKENDDATE\')}' })" isvalid="yes" checkexpession="NotNull" />
                        </div>
                        <div style="float:left;width:4%;text-align:center;line-height:28px">
                            -
                        </div>
                        <div style="float:left;width:48%">
                            <input id="WORKENDDATE" type="text" class="form-control input-wdatepicker" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm', minDate: '#F{$dp.$D(\'WORKSTARTDATE\')}' })" isvalid="yes" checkexpession="NotNull" />
                        </div>
                    </td>
                    <td class="formTitle">吊装施工地点</td>
                    <td class="formValue">
                        <input id="CONSTRUCTIONADDRESS" type="text" class="form-control"  maxlength="100" isvalid="yes" checkexpession="NotNull" />
                    </td>
                    @*<td class="formTitle">审核专业<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="CHECKMAJORNAME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" maxlength="100" readonly onclick="selectDept('', 0, 0, '选择作业单位', document.body, 'CHECKMAJORNAME,CHECKMAJORCODE,CHECKMAJORID');" />
                        <input id="CHECKMAJORID" type="hidden" class="form-control" />
                        <input id="CHECKMAJORCODE" type="hidden" class="form-control" />
                    </td>*@
                </tr>
                <tr>
                    <td class="formTitle">作业内容<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <textarea id="HOISTCONTENT" class="form-control" rows="5" maxlength="2000" isvalid="yes" checkexpession="NotNull"></textarea>
                    </td>
                </tr>
               
                <tr >
                    <td class="formTitle">设备资料</td>
                    <td class="formValue" colspan="3">
                        <div class="ibox">
                            <div id="uploader1" class="uploader" style="border: 1px solid #ccc; margin-top: 10px;height: 200px; margin-bottom: 10px;">
                                <div class="queueList">
                                    <div id="dndArea2" class="placeholder">
                                        <div class="filePicker" style="margin-left: 25px; margin-top: 10px;"></div>
                                    </div>
                                </div>
                                <div class="statusBar" style="display: none;">
                                    <div class="progress">
                                        <span class="text">0%</span>
                                        <span class="percentage"></span>
                                    </div>
                                    <div class="info"></div>
                                </div>
                            </div>

                        </div>
                    </td>
                </tr>
                <tr id="tr_liftscheme" style="display:none">
                    <td class="formTitle">起吊方案</td>
                    <td class="formValue" colspan="3">
                        <div class="ibox">
                            <div id="uploader2" class="uploader" style="border: 1px solid #ccc; margin-top: 10px;height: 120px; margin-bottom: 10px;">
                                <div class="queueList">
                                    <div id="dndArea3" class="placeholder">
                                        <div class="filePicker" style="margin-left: 25px; margin-top: 10px;"></div>
                                    </div>
                                </div>
                                <div class="statusBar" style="display: none;">
                                    <div class="progress">
                                        <span class="text">0%</span>
                                        <span class="percentage"></span>
                                    </div>
                                    <div class="info"></div>
                                </div>
                            </div>

                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="panel panel-default" id="operatePerson">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;人员信息</strong>
            <span class="tools pull-right">
                <a href="javascript:addPerson(this)" id="chooseperson" class="btn btn-primary btn-xs">新增</a>&nbsp;&nbsp;&nbsp;&nbsp; <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table id="gridPerson" data-text="asdfasdf"></table>
            <div id="PersonPager"></div>
        </div>
    </div>
    <div class="panel panel-default" id="riskAnalyse">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;作业安全分析</strong>
            <span class="tools pull-right">
                <a href="javascript:selRisk()" id="select" disabled="disabled" class="btn btn-primary btn-xs">选择工作任务</a>&nbsp;&nbsp;&nbsp;&nbsp;
                <a href="javascript:addItems(this)" id="choose1" disabled="disabled" class="btn btn-primary btn-xs">新增工作任务</a>&nbsp;&nbsp;&nbsp;&nbsp; <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table id="gridAnalyse"></table>
            <div id="AnalysePager"></div>
        </div>
    </div>
    <div id="panel_audit" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;审核信息</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <div style="margin-top: 5px; margin-right: 30px;">
                <table class="form">
                    <tr>
                        <td class="formTitle">审核部门<font face="宋体">*</font></td>
                        <td class="formValue">
                            <input id="AuditDeptName" type="text" class="form-control" checkexpession="NotNull" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptName" readonly />
                        </td>
                        <td class="formTitle">审核人<font face="宋体">*</font></td>
                        <td class="formValue">
                            <input id="AuditUserName" type="text" class="form-control" checkexpession="NotNull" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().UserName" readonly />
                            <input type="hidden" id="AuditUserId" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().UserId" />
                            <input type="hidden" id="AuditDeptId" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptId" />
                            <input type="hidden" id="AuditDeptCode" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptCode" />
                            <input type="hidden" id="BusinessId" />
                        </td>
                        <td class="formTitle">审核时间<font face="宋体">*</font></td>
                        <td class="formValue">
                            <input id="AuditDate" type="text" class="form-control" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm:ss' })" value="@DateTime.Now.ToString("yyyy-MM-dd HH:mm")" disabled="disabled" readonly checkexpession="NotNull" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">审核结果<font face="宋体">*</font></td>
                        <td class="formValue">
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="AuditState" id="AuditState1" value="1" onclick="auditCheck(this)"  />同意
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="AuditState" id="AuditState2" value="0" onclick="auditCheck(this)"  />不同意
                                </label>
                            </div>
                        </td>
                        <td class="formTitle">签名<font face="宋体">*</font></td>
                        <td class="formValue">
                            <img id="AuditSignImg" style="height:50px;" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">审核意见</td>
                        <td class="formValue" colspan="5">
                            <textarea id="AuditRemark" name="AuditRemark" class="form-control" maxlength="1000"></textarea>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div id="panel_auditrecord" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;审核记录</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table id="LifthoistAudit"></table>
        </div>
    </div>
</div>
<div class="form-button" style=" top: 40px; text-align: left; padding-left: 20px; position: fixed; bottom: auto; z-index: 1000;">
    <div style="float:left;">
        <a id="btn_Save" class="btn btn-primary" style="background-color: #2e99d4; border-color: #2e99d4; "><i class="fa fa-check"></i>&nbsp;保&nbsp;&nbsp;存</a>
        &nbsp; &nbsp;
        <a id="btn_Submit" class="btn btn-primary" style="background-color: #2e99d4; border-color: #2e99d4; "><i class="fa fa-mail-forward"></i>&nbsp;提&nbsp;&nbsp;交</a>
        &nbsp; &nbsp;
        <a id="btn_Audit" class="btn btn-primary" style="background-color: #2e99d4; border-color: #2e99d4; " onclick="AuditSubmit()"><i class="fa fa-mail-forward"></i>&nbsp;提&nbsp;&nbsp;交</a>
        &nbsp; &nbsp;
        <a id="btn_Transfer" class="btn btn-primary" style="background-color: #2e99d4; border-color: #2e99d4; "><i class="fa fa-mail-forward"></i>&nbsp;审&nbsp;&nbsp;批&nbsp;&nbsp;转&nbsp;&nbsp;交</a>
        &nbsp; &nbsp;
    </div>
</div>
