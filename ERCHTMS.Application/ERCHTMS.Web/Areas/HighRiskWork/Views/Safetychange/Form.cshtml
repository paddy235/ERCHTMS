@{;
  ViewBag.Title = "表单页面";
  Layout = "~/Views/Shared/_Form.cshtml";
}
<script src="~/Content/scripts/business/Common.js" type="text/javascript"></script>
<!--webUploader文件上传组件-->
<link href="~/content/scripts/plugins/webuploader/webuploader.css" rel="stylesheet" />
<link href="~/content/scripts/plugins/webuploader/webuploader-demo.css" rel="stylesheet" />
<script type="text/javascript" src="~/content/scripts/plugins/webuploader/webuploader.min.js"></script>
<script type="text/javascript" src="~/content/scripts/business/fileupload.js"></script>
<script src="~/Content/scripts/plugins/combo-select/jquery.combo.select.js"></script>
<link rel="stylesheet" href="~/Content/scripts/plugins/combo-select/combo.select.css">
<style>
    .form .formTitle {
        width: 110px;
    }

    .form .formValue select {
        padding: 0px;
    }
</style>
<script>


    //获取当前登录人信息
    var deptname = "@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptName";
    var deptid = "@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptId";
    var deptcode = "@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptCode";
    var userid = "@ERCHTMS.Code.OperatorProvider.Provider.Current().UserId";
    var username = "@ERCHTMS.Code.OperatorProvider.Provider.Current().UserName";
    //当前登录人所拥有的角色
    var rolenames = "@ERCHTMS.Code.OperatorProvider.Provider.Current().RoleName";
    var keyValue = request('keyValue');
    var actiontype = request('actiontype');
    var currstate = request('currstate');
    var editFile = false;//表示是否可以上传,删除附件
    var accEditFile=false;//验收图片
    var riskFlag=false;
    var curflowid = "";
    $(function () {
        $('#CHANGENAME,#CHANGETYPE').comboSelect();
        InitInfo();
        initControl();
    });

    function InitInfo() {
        //加载作业安全分析
        GetRiskGrid();
        //加载执行信息
        LoadZxGrid();
        if (actiontype == "add" || actiontype == "edit") {
            riskFlag = true;
            $("#select,#choose1").removeAttr("disabled");
        }
        $("#PROJECTNAME").attr("disabled", "disabled")
        switch (actiontype) {
            case "add"://新增
                $("#PROJECTNAME").attr("disabled", false)
                editFile = true;
                accEditFile=false;
                $("#btn_Accp").hide();//验收申请使用
                $("#btn_div").show();//变动申请使用
                $("#btn_Audit").hide();
                $("#btn_Transfer").hide();
                $("#panel4").hide();
                $("#panel5").hide();
                $("#panel6").hide();
                $("#panel7").hide();
                $("#panel8").hide();
                $("#ACCEPTANCE").attr("checkexpession", "").attr("isvalid", "");
                $("#ACCSPECIALTYTYPE").attr("checkexpession", "").attr("isvalid", "");
                ClearInputClass();
                $("#APPLYTYPE").val("安全设施变动申请")
                $("#panel9").hide();
                break;
            case "view"://查看
                $(".combo-dropdown").hide();
                editFile = false;
                accEditFile=false;
                $("input").attr("disabled", "disabled");
                $("select").attr("disabled", "disabled");
                $("textarea").attr("disabled", "disabled");
                $("#btn_div").hide();
                $("#btn_Accp").hide();
                $("#panel5").hide();
                $("#panel6").hide();
                switch (currstate) {
                    case "0"://保存未提交
                        $("#panel4").hide();
                        $("#APPLYTYPE").val("安全设施变动申请")
                        $("#panel7").hide();
                        $("#panel8").hide();
                        $("#panel9").hide();
                        break
                    case "1"://提交未审核
                        $("#APPLYTYPE").val("安全设施变动申请")
                        $("#panel4").show();
                        $("#panel7").hide();
                        $("#panel8").hide();
                        $("#panel9").hide();
                        GetGridAudit();
                        break
                    case "2"://申请审核未通过
                        $("#APPLYTYPE").val("安全设施变动申请")
                        $("#panel4").show();
                        $("#panel7").hide();
                        $("#panel8").hide();
                        $("#panel9").hide();
                        GetGridAudit();
                        break
                    case "3"://验收申请中
                        $("#APPLYTYPE").val("安全设施验收申请")
                        $("#panel7").hide();
                        $("#panel9").hide();
                        GetGridAudit();
                        break
                    case "4"://验收审核中
                        $("#panel5").hide();
                        $("#panel9").hide();
                        GetGridAudit();
                        $("#APPLYTYPE").val("安全设施验收申请")
                        GetGridAccpAudit();
                        break
                    case "5"://验收审核(批)未通过
                        GetGridAudit();
                        $("#APPLYTYPE").val("安全设施验收申请")
                        GetGridAccpAudit();
                        $("#panel9").hide();
                        break
                    case "6"://验收完成
                        GetGridAudit();
                        $("#APPLYTYPE").val("安全设施验收申请")
                        GetGridAccpAudit();
                        break
                    default:
                }
                break;
            case "edit"://编辑
                $("#PROJECTNAME").attr("disabled", false)
                editFile = true;
                accEditFile=false;
                $("#btn_Accp").hide();//验收申请使用
                $("#btn_div").show();//变动申请使用
                $("#btn_Audit").hide();
                $("#btn_Transfer").hide();
                $("#panel4").hide();
                $("#panel5").hide();
                $("#panel6").hide();
                $("#panel7").hide();
                $("#panel8").hide();
                $("#ACCEPTANCE").attr("checkexpession", "").attr("isvalid", "");
                $("#ACCSPECIALTYTYPE").attr("checkexpession", "").attr("isvalid", "");
                ClearInputClass();
                $("#APPLYTYPE").val("安全设施变动申请")
                $("#panel9").hide();
                //$("#btn_div").show();
                break;
            case "applyAudit"://申请审核
                editFile = false;
                accEditFile=false;
                $("#btn_div").show();
                $("#btn_Save").hide();
                $("#btn_Submit").hide();
                $("#btn_Accp").hide();
                $("#AuditDeptName").val(deptname);
                $("#AuditDeptId").val(deptid);
                $("#AuditDeptCode").val(deptcode);
                $("#AuditUserId").val(userid);
                $("#AuditUserName").val(username);
                $("#AuditDate").val("@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")");
                $("#panel4").show();
                $("#panel6").hide();
                $("#panel7").hide();
                $("#panel8").hide();
                $("#panel9").hide();
                GetGridAudit();
                $("#apply_tab input").attr("disabled", "disabled");
                $("#apply_tab textarea").attr("disabled", "disabled");
                $("#ACCEPTANCE").attr("checkexpession", "").attr("isvalid", "");
                $("#ACCSPECIALTYTYPE").attr("checkexpession", "").attr("isvalid", "");
                ClearInputClass();
                break;
            case "AccpApply"://验收申请
                editFile = false;
                accEditFile=true;
                $("#btn_div").hide();
                $("#btn_Accp").show();
                $("#btn_AccAudit").hide();
                $("#btn_AccTransfer").hide();
                $("#apply_tab input,select").attr("disabled", "disabled");
                $("#apply_tab textarea").attr("disabled", "disabled");
                $("#panel5").hide();
                $("#panel6").hide();
                $("#panel7").hide();
                $("#panel9").hide();
                ClearInputClass();
                GetGridAudit();
                $("#ACCEPTANCE").attr("checkexpession", "NotNull").attr("isvalid", "yes");
                $("#ACCSPECIALTYTYPE").attr("checkexpession", "NotNull").attr("isvalid", "yes");
                $("#APPLYTYPE").val("安全设施验收申请");
                break;
            case "AccpAudit"://验收审核
                editFile = false;
                accEditFile=false;
                $("#btn_div").hide();
                $("#btn_Accp").show();
                $("#btn_AccpSave").hide();
                $("#btn_AccpSubmit").hide();
                $("#apply_tab input,select").attr("disabled", "disabled");
                $("#apply_tab textarea").attr("disabled", "disabled");
                $("#panel5").hide();
                $("#panel9").hide();
                GetGridAudit();
                $("#APPLYTYPE").val("安全设施验收申请");
                $("#AuditDeptName1").val(deptname);
                $("#AuditDeptId1").val(deptid);
                $("#AuditDeptCode1").val(deptcode);
                $("#AuditUserId1").val(userid);
                $("#AuditUserName1").val(username);
                $("#AuditDate1").val("@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")");
                $("#ACCEPTANCE").attr("disabled", "disabled");
                $("#ACCSPECIALTYTYPE").attr("disabled", "disabled");
                $("#ACCCOPYUSERNAMES").attr("disabled", "disabled");
                $("#ACCISMESSAGE1,#ACCISMESSAGE2").attr("disabled", "disabled");
                GetGridAccpAudit();
                break;
            default:

        }
    }
    function ClearInputClass() {
        $("#APPLYUNIT1").attr("checkexpession", "").attr("isvalid", "");
        $("#APPLYUNITID1").attr("checkexpession", "").attr("isvalid", "");
        $("#APPLYPEOPLEID1").attr("checkexpession", "").attr("isvalid", "");
        $("#APPLYPEOPLE1").attr("checkexpession", "").attr("isvalid", "");
        $("#APPLYTIME1").attr("checkexpession", "").attr("isvalid", "");
    }
    function GetGridAudit() {
        var selectedRowIndex = 0;
        var $gridTable = $('#approveGridTable');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/Safetychange/GetApplyAuditList?keyValue=" + keyValue,
            datatype: "json",
            height: $(window).height() / 2 - 200,
            postData: { AuditType: 0 },
            autowidth: true,
            colModel: [
                 {
                     label: '审核部门', name: 'AuditDeptName', width: 300, align: 'center'
                 },
                { label: '审核人', name: 'AuditUserName', index: 'AuditUserName', width: 120, align: 'center' },
                {
                    label: '审核结果', name: 'AuditState', index: 'AuditState', width: 150, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var html = rowObject.AuditState == 0 ? "同意" : "不同意";
                        return html;
                    }
                },
                {
                    label: '审核意见', name: 'AuditRemark', index: 'AuditRemark', width: 150, align: 'center', formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        if (!!rowObject.AuditRemark) {
                            var content = rowObject.AuditRemark.length > 20 ? rowObject.AuditRemark.substring(0, 20) + "......" : rowObject.AuditRemark;

                            html = "<div title=" + content + ">" + content + "</div>";
                        }
                        return html;
                    }
                },
                {
                    label: '审核时间', name: 'AuditDate', index: 'AuditDate', width: 150, align: 'center', formatter: "date", formatoptions: { srcformat: 'Y-m-d', newformat: 'Y-m-d' }

                },
                {
                    label: '签名', name: 'AuditSignImg', index: 'AuditSignImg', width: 150, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var content = !!rowObject.AuditSignImg ? rowObject.AuditSignImg : "";
                        var html = "";
                        if (content == "" || content == undefined) {
                            var html = "<img />&nbsp;";
                        } else {
                            html = "<img style=\"height:50px;\"  src=\"../.." + content + "\"/>&nbsp;";
                        }

                        return html;
                    }
                }
            ],
            pager: false,
            rowNum: "20",
            rownumbers: true,
            shrinkToFit: false,
            gridview: true,
            ondblClickRow: function (id) {

            }
        });

    }
    function GetGridAccpAudit() {
        var selectedRowIndex = 0;
        var $gridTable = $('#approveGridTable1');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/Safetychange/GetApplyAuditList?keyValue=" + keyValue,
            datatype: "json",
            height: $(window).height() / 2 - 200,
            postData: { AuditType: 1 },
            autowidth: true,
            colModel: [
                 {
                     label: '审核部门', name: 'AuditDeptName', width: 300, align: 'center'
                 },
                { label: '审核人', name: 'AuditUserName', index: 'AuditUserName', width: 120, align: 'center' },
                {
                    label: '审核结果', name: 'AuditState', index: 'AuditState', width: 150, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var html = rowObject.AuditState == 0 ? "同意" : "不同意";
                        return html;
                    }
                },
                {
                    label: '审核意见', name: 'AuditRemark', index: 'AuditRemark', width: 150, align: 'center', formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        if (!!rowObject.AuditRemark) {
                            var content = rowObject.AuditRemark.length > 20 ? rowObject.AuditRemark.substring(0, 20) + "......" : rowObject.AuditRemark;

                            html = "<div title=" + content + ">" + content + "</div>";
                        }
                        return html;
                    }
                },
                {
                    label: '审核时间', name: 'AuditDate', index: 'AuditDate', width: 150, align: 'center', formatter: "date", formatoptions: { srcformat: 'Y-m-d H:i', newformat: 'Y-m-d H:i' }

                }, {
                    label: '签名', name: 'AuditSignImg', index: 'AuditSignImg', width: 150, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var content = !!rowObject.AuditSignImg ? rowObject.AuditSignImg : "";
                        var html = "";
                        if (content == "" || content == undefined) {
                            var html = "<img />&nbsp;";
                        } else {
                            html = "<img style=\"height:50px;\"  src=\"../.." + content + "\"/>&nbsp;";
                        }

                        return html;
                    }
                }
            ],
            pager: false,
            rowNum: "20",
            rownumbers: true,
            shrinkToFit: false,
            gridview: true,
            ondblClickRow: function (id) {

            }
        });
    }
    function InitCombox() {
        //6：验收完成 5：验收审核未通过 2：申请审核未通过
        if (currstate == "6" || currstate == "2" || currstate == "5") {
            $("#btnexport").show();
        }
        else {
            $("#btnexport").hide();
        }

        $("#APPLYUNIT").val(deptname);
        $("#APPLYUNITID").val(deptid);
        $("#APPLYPEOPLEID").val(userid);
        $("#APPLYPEOPLE").val(username);
        $("#APPLYTIME").val("@DateTime.Now.ToString("yyyy-MM-dd HH:mm")");

        if (rolenames.indexOf("承包商") >= 0 || rolenames.indexOf("分包商") >= 0) {
            $("input[name='WorkDeptType']:eq(1)").prop("checked", "checked");
            $("input[name='WorkDeptType']").attr("disabled", "disabled");
            $("#td_title_projectname").show();
            $("#td_value_projectname").show();
        }
        else {
            $("input[name='WorkDeptType']:eq(0)").prop("checked", "checked");
            $("#td_title_projectname").hide();
            $("#td_value_projectname").hide();
            $("#PROJECTNAME").removeAttr("checkexpession").removeAttr("isvalid");
        }
        //选择作业单位类别时，控制工程名称显示
        $("input[name='WorkDeptType']").click(function () {
            //0:单位内部,1:外包单位
            if ($(this).val() == "0") {
                $("#td_title_projectname").hide();
                $("#td_value_projectname").hide();
                $("#PROJECTNAME").removeAttr("checkexpession").removeAttr("isvalid");

            } else {
                $("#td_title_projectname").show();
                $("#td_value_projectname").show();
                $("#PROJECTNAME").attr("checkexpession", "NotNull").attr("isvalid", "yes");
            }
            $("#WORKUNIT,#WORKUNITID,#WORKUNITCODE,#WORKAREA,#PROJECTID,#PROJECTNAME,#WORKFZRID,#WORKFZR").val("");
            $("#SPECIALTYTYPE").html("");
            $("#SPECIALTYTYPE").append('<option value="">请选择</option>');
        });

        //保存
        $("#btn_Save").click(function () {
            AcceptClick("0");
        });

        //提交
        $("#btn_Submit").click(function () {
            AcceptClick("1");
        });

        //验收申请保存
        $("#btn_AccpSave").click(function () {
            AccpApplyClick("0");
        });

        //验收申请提交
        $("#btn_AccpSubmit").click(function () {
            AccpApplyClick("1");
        });

        //审批转交
        $("#btn_Transfer").click(function () {
            TransferAction();
        });

        //区域的处理
        $("#WORKAREA").attr("onclick", "selectArea(window.document.body, 'WORKAREA,WorkAreaCode');").attr("placeholder", "请选择作业区域");

        $("#btn_Export").click(function () {
            goReport();
        });
    }


    //初始化控件
    function initControl() {
        InitCombox();
        //获取表单
        if (!!keyValue) {
            file_upload.init({
                keyValue: keyValue, extensions: 'jpg,gif,bmp,png', isImage: false, el: '#uploader1'
            });
            file_upload.init({
                keyValue: keyValue+"1", extensions: 'jpg,gif,bmp,png', isImage: false, el: '#uploader2'
            });
            $.SetForm({
                url: "../../HighRiskWork/Safetychange/GetFormJson",
                param: { keyValue: keyValue },
                success: function (data) {
                    $("#form1").formDeserialize(data);
                    if (data.WORKUNITTYPE == "1") {
                        document.getElementById("WorkDeptType2").checked = true;
                        document.getElementById("WorkDeptType1").checked = false;
                        $("#td_title_projectname").show();
                        $("#td_value_projectname").show();
                        $("#PROJECTNAME").attr("checkexpession", "NotNull").attr("isvalid", "yes");
                        GetSpecialty(data.PROJECTID, data.SPECIALTYTYPE);
                      
                    } else {
                        document.getElementById("WorkDeptType1").checked = true;
                        document.getElementById("WorkDeptType2").checked = false;
                        $("#td_title_projectname").hide();
                        $("#td_value_projectname").hide();
                        GetSpecialty(data.WORKUNITID, data.SPECIALTYTYPE);
                    }
                    $("input[name='ISMESSAGE']:eq("+data.ISMESSAGE+")").prop("checked", "checked");
                    $("input[name='ACCISMESSAGE']:eq("+data.ACCISMESSAGE+")").prop("checked", "checked");
                    $("#ACCSPECIALTYTYPE").attr("disabled", "disabled");
                    curflowid = data.NodeId;
                }
            })
            file_upload.bindFiles(editFile, false, keyValue, 'uploader1', editFile);
            file_upload.bindFiles(accEditFile, false, keyValue+"1", 'uploader2', accEditFile);

            if(actiontype=="AccpApply")
            {
                $("#ACCEPDEPT").val(deptname);
                $("#ACCEPDEPTID").val(deptid);
                $("#ACCEPPEOPLEID").val(userid);
                $("#ACCEPPEOPLE").val(username);
                $("#ACCEPTIME").val("@DateTime.Now.ToString("yyyy-MM-dd HH:mm")");
            }
        } else {
            keyValue = "@Guid.NewGuid().ToString()";
            file_upload.init({
                keyValue: keyValue, extensions: 'jpg,gif,bmp,png', isImage: false, el: '#uploader1'
            });

            file_upload.init({
                keyValue: keyValue+"1", extensions: 'jpg,gif,bmp,png', isImage: false, el: '#uploader2'
            });
        }
    }


    function TransferAction() {
        var url = '/HighRiskWork/HighRiskCommonApply/TransferForm?keyValue=' + keyValue + "&FlowId=" + curflowid;
        idx = dialogOpen({
            id: "Transfer",
            title: '审批转交',
            url: url,
            width: ($(top.window).width() * 0.4) + "px",
            height: ($(top.window).height() * 0.4) + "px",
            callBack: function (iframeId) {
                top.document.getElementById(iframeId).contentWindow.AcceptClick();
                //top.layer.close(idx);
                //$.currentIframe().$("#gridTable").trigger("reloadGrid");
            },
            cancel: function (index) {
            }
        });
    }

    //变动申请保存表单;
    function AcceptClick(iscommit) {
        if ($("select").eq(1).val().length == 0 && $("#CHANGENAME").val().length == 0) {
            $("#CHANGENAME").attr("isvalid", "yes");
            $("#CHANGENAME").attr("checkexpession", "NotNull");
        }
        if ($("select").eq(2).val().length == 0 && $("#CHANGETYPE").val().length == 0) {
            $("#CHANGETYPE").attr("isvalid", "yes");
            $("#CHANGETYPE").attr("checkexpession", "NotNull");
        }
        if (!$('#form1').Validform()) {
            return false;
        }
        if (!($("#uploader1 .queueList .filelist").find("tr").length > 1)) {
            dialogMsg('请先上传安全设施图片！', 0);
            return false
        }

        var postData = $("#form1").formSerialize(keyValue);
        postData["ISCOMMIT"] = iscommit;

        var $gridTable = $('#gridAnalyse');
        var risk = $gridTable.jqGrid('getRowData');
        var arr = [];
        var flag = false;
        for (var i = 0; i < risk.length; i++) {
            var dom = risk[i];
            if (($.trim($gridTable.find("textarea[name='atrisk']").eq(i).val()).length == 0 || $.trim($gridTable.find("textarea[name='controls']").eq(i).val()).length == 0 ||$.trim($gridTable.find("textarea[name='worktask']").eq(i).val()).length == 0 ||$.trim($gridTable.find("textarea[name='workprocess']").eq(i).val()).length == 0) && !flag) {
                flag = true;
            } else {
                if ($.trim($gridTable.find("textarea[name='worktask']").eq(i).val()).length <= 500) {
                    arr.push({
                        WorkTask:$gridTable.find("textarea[name='worktask']").eq(i).val(),
                        WorkProcess:$gridTable.find("textarea[name='workprocess']").eq(i).val(),
                        AtRisk: $gridTable.find("textarea[name='atrisk']").eq(i).val(),
                        Controls: $gridTable.find("textarea[name='controls']").eq(i).val(),
                        WorkId: keyValue,
                        Id: newGuid(),
                        CreateDate: formatDate(new Date(), "yyyy-MM-dd hh:mm:ss")
                    });
                } else {
                    dialogMsg("工作任务字符过大,不可超过500个字符！", 2);
                    return false;
                }
            }
        }
        if (flag) {
            dialogMsg("工作任务、工序、风险描述和控制措施都不能为空！", 2);
            return false;
        }
        json = JSON.stringify(arr);
        postData["RiskRecord"] = json;

        //存储作业单位类别
        var unittype = $("input[name='WorkDeptType']:checked").val();
        postData["WORKUNITTYPE"] = unittype;
        var ismessage = $("input[name='ISMESSAGE']:checked").val();
        postData["ISMESSAGE"] = ismessage;
        $.SaveForm({
            url: "../../HighRiskWork/Safetychange/SaveForm?keyValue=" + keyValue,
            param: postData,
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        })
    }
    //验收申请保存表单;
    function AccpApplyClick(isaccpcommit) {
        if (!$('#form1').Validform()) {
            return false;
        }
        if (!($("#uploader2 .queueList .filelist").find("tr").length > 1)) {
            dialogMsg('请先上传安全验收设施图片！', 0);
            return false
        }
        var postData = $("#form1").formSerialize(keyValue);
        postData["ISACCPCOMMIT"] = isaccpcommit;
        //存储作业单位类别
        var unittype = $("input[name='WorkDeptType']:checked").val();
        postData["WORKUNITTYPE"] = unittype;
        var accismessage = $("input[name='ACCISMESSAGE']:checked").val();
        postData["ACCISMESSAGE"] = accismessage;
        $.SaveForm({
            url: "../../HighRiskWork/Safetychange/SaveAccpForm?keyValue=" + keyValue,
            param: postData,
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        })
    }

    function changeFzr() {
        if (!!$("#WORKUNITID").val()) {
            selectUser({ deptId: $('#WORKUNITID').val(), checkMode: 0, mode: 1, winObject: window.document.body, domId: 'WORKFZR,,WORKFZRID' });
        }
        else
        {
            dialogMsg('请先选择作业单位！', 0);
        }
    }

    //选择作业单位
    function selectCompany() {
        var setupcompanytype = $("input[type=radio]:checked").val();
        /**
        1.选择单位内部时，工程名称隐藏,当前角色为“厂级部门”，作业单位为所有单位不包含承包商，否则为作业单位本部门及以下单位。
        2.选择外包单位时，工程名称显示,当前角色为“厂级部门”，作业单位为所有外包单位,否则作业单位为本部门及以下级部门管辖的外包单位。
        3.另工程名称为选择作业单位后单位管辖的工程，选择工程后把作业区域代入文本框。
        **/
        //当前角色为“厂级部门”，作业单位为所有单位，否则为本部门及下及部门单位
        if (setupcompanytype == "0") {
            selectDept('&type=highrisk', 0, 4, '选择作业单位', document.body, 'WORKUNIT,WORKUNITCODE,WORKUNITID', "1",function(){
                $("#WORKFZR,#WORKFZRID").val("");
                var departid=$("#WORKUNITID").val();
                $("#SPECIALTYTYPE").html('');
                $("#SPECIALTYTYPE").append('<option value="">请选择</option>');
                GetSpecialty(departid, "");
            });
        } else {
            selectDept('', 0, 7, '选择作业单位', document.body, 'WORKUNIT,WORKUNITCODE,WORKUNITID', "1", function () {
                $("#PROJECTID,#PROJECTNAME,#WORKFZR,#WORKFZRID").val("");
                $("#SPECIALTYTYPE").html('');
                $("#SPECIALTYTYPE").append('<option value="">请选择</option>');
            });
        }
    }

    //选择工程
    function chooseProject() {
        if (!!$("#WORKUNIT").val()) {
            SelectOutProject(window.document.body, 'PROJECTNAME,PROJECTID', $("#WORKUNITID").val(), function () {
                var projectid = $("#PROJECTID").val()
                $("#SPECIALTYTYPE").html('');
                $("#SPECIALTYTYPE").append('<option value="">请选择</option>');
                GetSpecialty(projectid, "");
                //GetEngineerInfo(projectid);
            });

        }
        else {
            dialogMsg('请先选择作业单位！', 0);
        }

    }

    //获取部门下的专业类别
    function GetSpecialty(departid, stype) {
        var specialtytype = stype;
        if (actiontype == "edit" || actiontype == "add") {
            specialtytype = "";
        }
        var workdepttype = $("input[name='WorkDeptType']:checked").val();
        var flag = false;
        $.ajax({
            url: "../../HighRiskWork/Scaffold/GetSpecialtyToJson?deptid=" + departid + "&specialtytype=" + specialtytype + "&workdepttype=" + workdepttype,
            asycn: true,
            type: 'get',
            success: function (data) {
                if (!!data) {
                    var json = JSON.parse(data);
                    for (var i = 0; i < json.length; i++) {
                        if (stype == json[i].itemvalue) {
                            $("#SPECIALTYTYPE").append('<option value="' + json[i].itemvalue + '" selected="selected">' + json[i].itemname + '</option>');
                            $("#ACCSPECIALTYTYPE").append('<option value="' + json[i].itemvalue + '" selected="selected">' + json[i].itemname + '</option>');
                        }
                        else {
                            $("#SPECIALTYTYPE").append('<option value="' + json[i].itemvalue + '">' + json[i].itemname + '</option>');
                            $("#ACCSPECIALTYTYPE").append('<option value="' + json[i].itemvalue + '" selected="selected">' + json[i].itemname + '</option>');
                        }
                    }
                }
            }
        });
    }

    //获取工程详情
    function GetEngineerInfo(id) {
        $.SetForm({
            url: "../../OutsourcingProject/Outsouringengineer/GetFormJson?keyValue=" + id,
            success: function (data) {
                $("#WORKAREA").val(data.data.ENGINEERAREANAME);
                //$("#WORKAREA").attr("disabled", "disabled");
            }
        })
    }
    //变动申请审核
    function SubmitAction() {
        if (!$('#form1').Validform()) {
            return false;
        }
        var postData = $("#form1").formSerialize(keyValue);
        //审核结果
        var auditresult = $("input[name='AuditState']:checked").val();
        if (auditresult == "" || auditresult == undefined) {
            dialogAlert("审核结果未勾选,无法进行提交!!!", function () {
                return false;
            })
            return false;
        }
        postData["AuditState"] = auditresult;
        postData["AuditSignImg"] = $("#AuditSignImg").attr("src");
        postData["AuditType"] = 0;
        if (document.getElementById("WorkDeptType2").checked) {
            postData["WORKUNITTYPE"] = $("#WorkDeptType2").val();
        } else {
            postData["WORKUNITTYPE"] = $("#WorkDeptType1").val();
        }
        $.SaveForm({
            url: "../../HighRiskWork/Safetychange/SubmitAppLyAudit?keyValue=" + keyValue,
            param: postData,
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
                top.refreshWork();//刷新首页待办事项
            }
        })
    }
    //验收申请审核
    function SubmitAccpApplyAction() {
        if (!$('#form1').Validform()) {
            return false;
        }
        var postData = $("#form1").formSerialize(keyValue);
        //审核结果
        var auditresult = $("input[name='AuditState1']:checked").val();
        if (auditresult == "" || auditresult == undefined) {
            dialogAlert("审核结果未勾选,无法进行提交!!!", function () {
                return false;
            })
            return false;
        }
        postData["AuditState"] = auditresult;
        postData["AuditSignImg"] = $("#AuditSignImg1").attr("src");
        postData["AuditType"] = 1;
        postData["AuditDeptName"] = $("#AuditDeptName1").val();
        postData["AuditDeptId"] = $("#AuditDeptId1").val();
        postData["AuditDeptCode"] = $("#AuditDeptCode1").val();
        postData["AuditUserId"] = $("#AuditUserId1").val();
        postData["AuditUserName"] = $("#AuditUserName1").val();
        postData["AuditDate"] = $("#AuditDate1").val();
        postData["AuditRemark"] = $("#AuditRemark1").val();
        if (document.getElementById("WorkDeptType2").checked) {
            postData["WORKUNITTYPE"] = $("#WorkDeptType2").val();
        } else {
            postData["WORKUNITTYPE"] = $("#WorkDeptType1").val();
        }
        $.SaveForm({
            url: "../../HighRiskWork/Safetychange/SubmitAccpAudit?keyValue=" + keyValue,
            param: postData,
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
                top.refreshWork();//刷新首页待办事项
            }
        })
      
    }

    //导出
    function goReport() {
        location.href = "../../HighRiskWork/Safetychange/ExportDetails?keyValue=" + keyValue;
    }

    function auditCheck(obj,value) {
        var signImg = getUserSignPic(userid);
        if (!!signImg) {
            if(value=="0"){
                $("#AuditSignImg").attr("src", "../.." + signImg);
            }
            else{
                $("#AuditSignImg1").attr("src", "../.." + signImg);
            }
            
        } else {
            $(obj).get(0).checked = false;
        }
    }

    //加载执行信息
    function LoadZxGrid() {
        var selectedRowIndex = 0;
        var $gridTable = $('#conditionGridTable');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/Scaffold/GetConditonToJson?keyvalue=" + keyValue,
            datatype: "json",
            height: "240px",
            postData: {},
            autowidth: true,
            colModel: [
                { label: 'ID', name: 'Id', index: 'Id', width: 500, align: 'center', sortable: false, hidden: true },
                 {
                     label: '作业时间', name: 'ConditionTime', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                         var html = "";
                         if (!!rowObject.LedgerType) {
                             if (rowObject.LedgerType == "0") {
                                 html = "开始时间:" + formatDate(cellvalue, 'yyyy-MM-dd hh:mm');
                             }
                             else {
                                 html = "结束时间:" + formatDate(cellvalue, 'yyyy-MM-dd hh:mm');
                             }
                         }
                         return html;
                     }
                 },
                { label: '执行情况说明', name: 'ConditionContent', index: 'ConditionContent', width: 500, align: 'center', sortable: false },
                {
                    label: '现场图片', name: 'ScenePicPath', index: 'ScenePicPath', width: 300, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        if (!!rowObject.ScenePicPath) {
                            html = "<div id=\"ScenePic_" + rowObject.Id + "\"><img src=\" ../.." + rowObject.ScenePicPath.substring(1, rowObject.ScenePicPath.length) + "\"  data-original=\" ../.." + rowObject.ScenePicPath.substring(1, rowObject.ScenePicPath.length) + "\" alt=\"\"  style=\"width:150px;height:100px;\" /></div>";
                        }
                        return html;
                    }
                },
                {
                    label: '填报人', name: 'CreateUserName', index: 'CreateUserName', width: 150, align: 'center', sortable: false
                },
                {
                    label: '填报时间', name: 'CreateDate', index: 'CreateDate', width: 150, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        return formatDate(cellvalue, 'yyyy-MM-dd hh:mm');
                    }

                }
            ],
            pager: false,
            rowNum: "20",
            rownumbers: true,
            shrinkToFit: false,
            gridview: true,
            ondblClickRow: function (id) {

            },
            gridComplete: function () {
                $("#" + this.id).setSelection(selectedRowIndex, false);
                //获取所有数据
                var datas = $("#" + this.id).jqGrid("getRowData");
                if (!!datas) {
                    $(datas).each(function (i, ele) {
                        viewimg(ele.Id, "#ScenePic_" + ele.Id, ele.ScenePicPath); //现场图片
                    });
                }
            }
        });
    }


    //预览图片
    function viewimg(id, objid, epath) {
        var $obj = $(objid);
        $.post("../../PublicInfoManage/ResourceFile/GetFilesByRecId", { recId: id }, function (data) {
            var files = eval("(" + data + ")");
            if (files.length > 0) {
                $(files).each(function (i, file) {
                    if (!!file.filepath) {
                        var filepath = file.filepath.substring(15, file.filepath.length);
                        if (!!epath && epath.indexOf(filepath) < 0) {
                            var $li = $('<img title="点击查看大图" alt="点击查看大图" style=\"width:0px;height:0px;\" data-original="' + "/" + file.filepath.substring(1, file.filepath.length) + '" src="' + "/" + file.filepath.substring(1, file.filepath.length) + '"  />');
                            $li.appendTo($obj);
                        }
                    }
                });
                $obj.viewer({ url: "data-original" });
            }
        });
    }

    //加载作业安全分析
    function GetRiskGrid() {
        var $gridTable = $('#gridAnalyse');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/HighRiskCommonApply/GetRiskListJson",
            postData: { workId: keyValue },
            datatype: "json",
            height: "200px",
            autowidth: true,
            colModel: [
                { label: '主键', name: 'Id', hidden: true },
                {
                    label: '操作', name: 'Oper', width: 80, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        if (riskFlag) {
                            html += "&nbsp;&nbsp;<a href=javascript:delRow('" + rowObject.Id + "',this)  title='删除'><i class='fa fa-trash-o'></i></a>";
                        }
                        return html;
                    }
                },
                {
                    label: '工作任务', name: 'WorkTask', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="worktask" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:120px;" class="form-control"';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                },
                {
                    label: '工序', name: 'WorkProcess', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="workprocess" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:120px;" class="form-control"> ';
                        if (cellvalue) {
                            html += cellvalue + '</textarea>';
                        }
                        else {
                            html += '</textarea>';
                        }
                        return html;
                    }
                },
                {
                    label: '风险描述', name: 'AtRisk', width: 250, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="atrisk" ' + str + ' role="textbox" maxlength="500"  style="width: 100%;height:120px;" class="form-control" ';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                },
                {
                    label: '风险控制措施', name: 'Controls', width: 200, sortable: false, align: 'center'
                    , formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="controls" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:120px;" class="form-control" ';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                }
            ],
            viewrecords: true,
            rowNum: 100000,
            sortname: 'CreateDate',
            sortorder: 'desc',
            rownumbers: true,
            shrinkToFit: false,
            gridview: true

        });
    }

    //删除数据行
    function delRow(id, obj) {
        var jqTable = $("#gridAnalyse");
        var idx = dialogConfirm("确认删除吗？", function (isSure) {
            if (isSure) {
                jqTable.delRowData(jqTable.getGridParam('selrow'));
                top.layer.close(idx);
            } else {
                top.layer.close(idx);
            }
        });
    }

    //添加行
    function addItems(obj) {
        var rowId = $("#gridAnalyse").jqGrid('getRowData').length;
        $("#gridAnalyse").addRowData(rowId, { ID: newGuid(), WorkTask: "", WorkProcess: "", AtRisk: "", Controls: "" }, "first");
    }

    //从风险库中选择数据
    function selRisk() {
        dialogOpen({
            id: 'SelectRisk',
            title: '选择工作任务',
            url: '/HighRiskWork/HighRiskCommonApply/Select?worktypevale=-3',
            width: ($(window).width() - 200) + 'px',
            height: ($(window).height() - 20) + 'px',
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick(window.document.body);
            }
        })
    }

    function showmore(type) {
        switch (type) {
            case 0:
                if (!!$("#COPYUSERNAMES").val()) {
                    var html = $("#COPYUSERNAMES").val();
                    $("#modalBody").html(html);
                    $("#QdModal").modal('show');
                }
                else {
                    dialogMsg('请选择抄送人！', 0);
                }
                break;
            case 1:
                if (!!$("#ACCCOPYUSERNAMES").val()) {
                    var html = $("#ACCCOPYUSERNAMES").val();
                    $("#modalBody").html(html);
                    $("#QdModal").modal('show');
                }
                else {
                    dialogMsg('请选择抄送人！', 0);
                }
                break;
            default:
        
        }
    }

    //选择抄送人
    function chooseCopyUser(type) {
        switch (type) {
            case 0:
                selectUser({ deptId: '', checkMode: 1, mode: 0, winObject: window.document.body, domId: 'COPYUSERNAMES,,COPYUSERIDS,', userIds: "COPYUSERIDS" });
                break;
            case 1:
                selectUser({ deptId: '', checkMode: 1, mode: 0, winObject: window.document.body, domId: 'ACCCOPYUSERNAMES,,ACCCOPYUSERIDS,', userIds: "ACCCOPYUSERIDS" });
                break;
            default:
                break;
        }
    }
</script>
<div style="margin: 0px; margin-top: 40px; margin-left: 20px; background-color: white;">
    <div class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;变动申请信息</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form" id="apply_tab">
                <tr>
                    <td class="formTitle" style="width: 110px;">申请类型<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYTYPE" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" readonly />
                    </td>
                    <td class="formTitle" style="width: 160px;">申请编号</td>
                    <td class="formValue">
                        <input id="APPLYNO" type="text" class="form-control" disabled="disabled" placeholder="自动生成" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">申请单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYUNIT" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" disabled="disabled" />
                        <input type="hidden" id="APPLYUNITID" value="" />
                        <input type="hidden" id="NodeId" />
                    </td>
                    <td class="formTitle">申请人<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYPEOPLE" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" disabled="disabled" />
                        <input type="hidden" id="APPLYPEOPLEID" value="" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">申请时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYTIME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" disabled="disabled" />
                    </td>
                    <td class="formTitle" id="tddept">作业单位类别<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="WorkDeptType" id="WorkDeptType1" value="0" />单位内部
                            </label>
                        </div>
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="WorkDeptType" id="WorkDeptType2" value="1" />外包单位
                            </label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">作业单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="WORKUNIT" type="text" class="form-control" placeholder="请选择作业单位" isvalid="yes" checkexpession="NotNull" readonly onclick="selectCompany()" />
                        <input type="hidden" id="WORKUNITID" />
                        <input type="hidden" id="WORKUNITCODE" />
                    </td>
                    <td class="formTitle" id="td_title_projectname">工程名称<font face="宋体">*</font></td>
                    <td class="formValue" id="td_value_projectname">
                        <input id="PROJECTNAME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" readonly placeholder="请选择工程" onclick="chooseProject();" />
                        <input id="PROJECTID" type="hidden" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">专业类别<font face="宋体">*</font></td>
                    <td class="formValue">
                        <select id="SPECIALTYTYPE" name="SPECIALTYTYPE" class="form-control" isvalid="yes" checkexpession="NotNull">
                            <option value="">请选择</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">作业区域<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="WORKAREA" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" />
                        <input type="hidden" id="WorkAreaCode" />
                    </td>
                    <td class="formTitle">作业地点<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="WORKPLACE" class="form-control" isvalid="yes" checkexpession="NotNull" maxlength="100" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">作业项目(内容)</td>
                    <td class="formValue" colspan="3">
                        <textarea id="WORKCONTENT" class="form-control" isvalid="yes" checkexpession="LenStrOrNull" length="800" style="min-height: 60px;"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">作业负责人<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="WORKFZR" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" readonly onclick="changeFzr()" />
                        <input type="hidden" id="WORKFZRID" value="" />
                    </td>
                    <td class="formTitle">需变动的安全设施名称<font face="宋体">*</font></td>
                    <td class="formValue">
                        <select id="CHANGENAME" class="form-control">
                            <option value="">请选择或者输入</option>
                            <option value="防护栏杆">防护栏杆</option>
                            <option value="临时栏杆">临时栏杆</option>
                            <option value="楼梯">楼梯</option>
                            <option value="爬梯">爬梯</option>
                            <option value="平台格栅">平台格栅</option>
                        </select>

                    </td>
                </tr>
                <tr>
                    <td class="formTitle">变动形式<font face="宋体">*</font></td>
                    <td class="formValue">
                        <select id="CHANGETYPE" class="form-control">
                            <option value="">请选择或者输入</option>
                            <option value="移动">移动</option>
                            <option value="临时拆除">临时拆除</option>
                            <option value="改变">改变</option>
                            <option value="取消">取消</option>
                        </select>

                    </td>
                    <td class="formTitle">申请变动时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="APPLYCHANGETIME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" class="form-control input-wdatepicker"
                            onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm', maxDate: '#F{$dp.$D(\'RETURNTIME\')}' })" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">预计恢复时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="RETURNTIME" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" class="form-control input-wdatepicker" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm', minDate: '#F{$dp.$D(\'APPLYCHANGETIME\')}' })" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">变动理由及内容<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <textarea id="CHANGEREASON" class="form-control" isvalid="yes" checkexpession="LenStr" length="800" style="min-height: 60px;"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">已采取的防护措施<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <textarea id="PROCEDURES" class="form-control" isvalid="yes" checkexpession="LenStr" length="800" style="min-height: 60px;"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">抄送人</td>
                    <td class="formValue" colspan="2">
                        <input id="COPYUSERNAMES" type="text" class="form-control" placeholder="请选择抄送人" readonly onclick="chooseCopyUser(0)" />
                        <input type="hidden" id="COPYUSERIDS" value="" />
                    </td>
                    <td>
                        <a id="btn_more" class="btn btn-primary" href="javascript:showmore(0);"><i class="fa fa-check"></i>&nbsp;更&nbsp;&nbsp;多</a>
                    </td>
                </tr>
                <tr style="display:none">
                    <td class="formTitle" id="tddept">短信通知审批人<font face="宋体">*</font></td>
                    <td class="formValue" colspan="2">
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="ISMESSAGE" id="ISMESSAGE1" value="0" checked="checked" />否
                            </label>
                        </div>
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="ISMESSAGE" id="ISMESSAGE2" value="1" />是
                            </label>
                        </div>
                    </td>
                </tr>
            </table>
            <div class="ibox">
                <div class="ibox-title">
                    <h5>安全设施图片<font face="宋体" color="red">*</font></h5>
                    <div class="ibox-tools">
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="uploader1" class="uploader" style="border: 1px solid #ccc; margin-top: 10px; min-height: 100px; margin-bottom: 10px;">
                        <div class="queueList">
                            <div id="dndArea" class="placeholder">
                                <div class="filePicker" style="margin-left: 25px; margin-top: 10px;"></div>
                            </div>
                        </div>
                        <div class="statusBar" style="display: none;">
                            <div class="progress">
                                <span class="text">0%</span>
                                <span class="percentage"></span>
                            </div>
                            <div class="info"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-default" id="riskAnalyse">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;作业安全分析</strong>
            <span class="tools pull-right">
                <a href="javascript:selRisk()" id="select" disabled="disabled" class="btn btn-primary btn-xs">选择工作任务</a>&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="javascript:addItems(this)" id="choose1" disabled="disabled" class="btn btn-primary btn-xs">新增工作任务</a>&nbsp;&nbsp;&nbsp;&nbsp; <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table id="gridAnalyse"></table>
            <div id="AnalysePager"></div>
        </div>
    </div>
    <div id="btn_div" class="form-button" style="top: 40px; text-align: left; padding-left: 20px; position: fixed; bottom: auto; z-index: 1000;">
        <div style="float: left;">
            <a id="btn_Save" class="btn btn-primary"><i class="fa fa-check"></i>&nbsp;保&nbsp;&nbsp;存</a>
            &nbsp; &nbsp;
            <a id="btn_Submit" class="btn btn-primary"><i class="fa fa-mail-forward"></i>&nbsp;提&nbsp;&nbsp;交</a>
            &nbsp; &nbsp;
            <a id="btn_Audit" class="btn btn-primary" onclick="SubmitAction()"><i class="fa fa-mail-forward"></i>&nbsp;提&nbsp;&nbsp;交</a>
            &nbsp; &nbsp;
            <a id="btn_Transfer" class="btn btn-primary" onclick="TransferAction()"><i class="fa fa-mail-forward"></i>&nbsp;审&nbsp;&nbsp;批&nbsp;&nbsp;转&nbsp;&nbsp;交</a>
            &nbsp; &nbsp;
        </div>
    </div>
    <div id="btn_Accp" class="form-button" style="top: 40px; text-align: left; padding-left: 20px; position: fixed; bottom: auto; z-index: 1000;">
        <div style="float: left;">
            <a id="btn_AccpSave" class="btn btn-primary"><i class="fa fa-check"></i>&nbsp;保&nbsp;&nbsp;存</a>
            &nbsp; &nbsp;
            <a id="btn_AccpSubmit" class="btn btn-primary"><i class="fa fa-mail-forward"></i>&nbsp;提&nbsp;&nbsp;交</a>
            &nbsp; &nbsp;
            <a id="btn_AccAudit" class="btn btn-primary" onclick="SubmitAccpApplyAction()"><i class="fa fa-mail-forward"></i>&nbsp;提&nbsp;&nbsp;交</a>
            &nbsp; &nbsp;
            <a id="btn_AccTransfer" class="btn btn-primary" onclick="TransferAction()"><i class="fa fa-mail-forward"></i>&nbsp;审&nbsp;&nbsp;批&nbsp;&nbsp;转&nbsp;&nbsp;交</a>
            &nbsp; &nbsp;
        </div>
    </div>
    <div class="form-button" style="top: 40px; text-align: left; padding-left: 20px; position: fixed; bottom: auto; z-index: 1000;" id="btnexport">
        <div style="float: left;">
            <a id="btn_Export" class="btn btn-primary" style="background-color: #2e99d4; border-color: #2e99d4;"><i class="fa fa-download"></i>&nbsp;导&nbsp;&nbsp;出</a>
        </div>
    </div>
    <div class="panel panel-default" id="panel5">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;申请审核信息</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <div style="margin-top: 5px; margin-right: 30px;">
                <table class="form">
                    <tr>
                        <td class="formTitle">审核部门<font face="宋体">*</font></td>
                        <td class="formValue" colspan="2">
                            <input id="AuditDeptName" type="text" class="form-control" readonly checkexpession="NotNull" />
                            <input type="hidden" id="AuditDeptId" />
                            <input type="hidden" id="AuditDeptCode" />
                        </td>
                        <td class="formTitle">审核人<font face="宋体">*</font></td>
                        <td class="formValue" colspan="2">
                            <input id="AuditUserName" type="text" class="form-control" checkexpession="NotNull" readonly />
                            <input type="hidden" id="AuditUserId" />
                        </td>

                    </tr>
                    <tr>
                        <td class="formTitle">审核日期<font face="宋体">*</font></td>
                        <td class="formValue" colspan="2">
                            <input id="AuditDate" type="text" class="form-control" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" disabled="disabled" readonly checkexpession="NotNull" />
                        </td>
                        <td class="formTitle">审核结果<font face="宋体">*</font></td>
                        <td class="formValue" colspan="2">
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="AuditState" id="AUDITSTATE5" value="0" onclick="auditCheck(this,0)" />同意
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="AuditState" id="AUDITSTATE6" value="1" onclick="auditCheck(this,0)" />不同意
                                </label>
                            </div>
                        </td>
                        <td class="formTitle">签名<font face="宋体">*</font></td>
                        <td class="formValue">
                            <img id="AuditSignImg" style="height: 50px;" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">审核意见</td>
                        <td class="formValue" colspan="5">
                            <textarea id="AuditRemark" name="AuditRemark" class="form-control"></textarea>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="panel panel-default" id="panel4">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;申请审核记录</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <div style="margin-top: 5px; margin-right: 30px;">
                <table id="approveGridTable"></table>
            </div>
        </div>
    </div>
    <div class="panel panel-default" id="panel8">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;验收审核信息</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form" id="Accp_tab">
                <tr>
                    <td class="formTitle" style="width: 160px;">安全设施恢复及验收情况<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <textarea id="ACCEPTANCE" class="form-control" isvalid="yes" checkexpession="NotNull" style="min-height: 60px;" maxlength="800"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">申请单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="ACCEPDEPT" type="text" class="form-control" disabled="disabled" />
                        <input type="hidden" id="ACCEPDEPTID" value="" />
                    </td>
                    <td class="formTitle">申请人<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="ACCEPPEOPLE" type="text" class="form-control" disabled="disabled" />
                        <input type="hidden" id="ACCEPPEOPLEID" value="" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">申请时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="ACCEPTIME" type="text" class="form-control" disabled="disabled" />
                    </td>
                    <td class="formTitle">专业类别<font face="宋体">*</font></td>
                    <td class="formValue">
                        <select id="ACCSPECIALTYTYPE" name="ACCSPECIALTYTYPE" class="form-control" isvalid="yes" checkexpession="NotNull">
                            <option value="">请选择</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">抄送人</td>
                    <td class="formValue" colspan="2">
                        <input id="ACCCOPYUSERNAMES" type="text" class="form-control" placeholder="请选择抄送人" readonly onclick="chooseCopyUser(1)" />
                        <input type="hidden" id="ACCCOPYUSERIDS" value="" />
                    </td>
                    <td>
                        <a id="btn_more" class="btn btn-primary" href="javascript:showmore(1);"><i class="fa fa-check"></i>&nbsp;更&nbsp;&nbsp;多</a>
                    </td>
                </tr>
                <tr style="display:none">
                    <td class="formTitle" id="tddept">短信通知审批人<font face="宋体">*</font></td>
                    <td class="formValue" colspan="2">
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="ACCISMESSAGE" id="ACCISMESSAGE1" value="0" checked="checked" />否
                            </label>
                        </div>
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="ACCISMESSAGE" id="ACCISMESSAGE2" value="1" />是
                            </label>
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <div class="ibox">
            <div class="ibox-title">
                <h5>安全验收设施图片<font face="宋体" color="red">*</font></h5>
                <div class="ibox-tools">
                </div>
            </div>
            <div class="ibox-content">
                <div id="uploader2" class="uploader" style="border: 1px solid #ccc; margin-top: 10px; min-height: 100px; margin-bottom: 10px;">
                    <div class="queueList">
                        <div id="dndArea2" class="placeholder">
                            <div class="filePicker" style="margin-left: 25px; margin-top: 10px;"></div>
                        </div>
                    </div>
                    <div class="statusBar" style="display: none;">
                        <div class="progress">
                            <span class="text">0%</span>
                            <span class="percentage"></span>
                        </div>
                        <div class="info"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="panel panel-default" id="panel6">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;验收申请信息</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <div style="margin-top: 5px; margin-right: 30px;">
                <table class="form">
                    <tr>
                        <td class="formTitle">审核部门<font face="宋体">*</font></td>
                        <td class="formValue" colspan="2">
                            <input id="AuditDeptName1" type="text" class="form-control" readonly checkexpession="NotNull" />
                            <input type="hidden" id="AuditDeptId1" />
                            <input type="hidden" id="AuditDeptCode1" />
                        </td>
                        <td class="formTitle">审核人<font face="宋体">*</font></td>
                        <td class="formValue" colspan="2">
                            <input id="AuditUserName1" type="text" class="form-control" checkexpession="NotNull" readonly />
                            <input type="hidden" id="AuditUserId1" />
                        </td>

                    </tr>
                    <tr>
                        <td class="formTitle">审核日期<font face="宋体">*</font></td>
                        <td class="formValue" colspan="2">
                            <input id="AuditDate1" type="text" class="form-control" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" disabled="disabled" readonly checkexpession="NotNull" />
                        </td>
                        <td class="formTitle">审核结果<font face="宋体">*</font></td>
                        <td class="formValue" colspan="2">
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="AuditState1" id="AUDITSTATE3" value="0" onclick="auditCheck(this,1)" />同意
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="AuditState1" id="AUDITSTATE4" value="1" onclick="auditCheck(this,1)" />不同意
                                </label>
                            </div>
                        </td>
                        <td class="formTitle">签名<font face="宋体">*</font></td>
                        <td class="formValue">
                            <img id="AuditSignImg1" style="height: 50px;" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">审核意见</td>
                        <td class="formValue" colspan="5">
                            <textarea id="AuditRemark1" name="AuditRemark1" class="form-control"></textarea>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="panel panel-default" id="panel7">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;验收审核记录</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <div style="margin-top: 5px; margin-right: 30px;">
                <table id="approveGridTable1"></table>
            </div>
        </div>
    </div>
    <div class="panel panel-default" id="panel9">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;作业执行信息</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <div style="margin-top: 5px; margin-right: 30px;">
                <table id="conditionGridTable"></table>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="QdModal">
    <div class="modal-dialog" style="width: 300px; margin-top: 100px;">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h5>人员</h5>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button id="btnModal" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
