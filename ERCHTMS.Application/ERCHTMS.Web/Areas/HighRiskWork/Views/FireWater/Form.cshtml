@{;
  ViewBag.Title = "表单页面";
  Layout = "~/Views/Shared/_Form.cshtml";
}
<script src="~/Content/scripts/business/Common.js" type="text/javascript"></script>

<!--webUploader文件上传组件-->
<link href="~/content/scripts/plugins/webuploader/webuploader.css" rel="stylesheet" />
<link href="~/content/scripts/plugins/webuploader/webuploader-demo.css" rel="stylesheet" />
<script type="text/javascript" src="~/content/scripts/plugins/webuploader/webuploader.min.js"></script>
<script type="text/javascript" src="~/content/scripts/business/fileupload.js"></script>

<style>
    .form .formTitle {
        width: 150px;
    }

    .form .formValue select {
        padding: 0px;
    }
   
</style>
<script>
    var IsHrdl = "@(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetItemValue("IsOpenPassword"))";
    var keyValue = request('keyValue');
    var mode = request('mode');
    var state = request('state');
    var conditionstate = request('conditionstate');

    //获取当前登录人信息
    var deptname = "@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptName";
    var deptid = "@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptId";
    var deptcode = "@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptCode";
    var userid = "@ERCHTMS.Code.OperatorProvider.Provider.Current().UserId";
    var username = "@ERCHTMS.Code.OperatorProvider.Provider.Current().UserName";
    //当前登录人所拥有的角色
    var rolenames = "@ERCHTMS.Code.OperatorProvider.Provider.Current().RoleName";
    var editFile = true;//表示是否可以上传,删除附件
    var riskFlag=false;
    var conditionFile = true;
    var curflowid = "";

    $(function () {
        initControl();
        //加载作业安全分析
        GetRiskGrid();
        //加载审核记录
        loadApproveGrid();
        //加载执行信息
        LoadZxGrid();
       
        if (IsHrdl == "true") {
            $("#SpecialtyType").removeAttr("isvalid").removeAttr("checkexpession");
            $("#tdSpecialtyType").html("专业类别");
        }
    });
    //初始化控件
    function initControl() {
        if (IsHrdl == "true") {
            $("#tdWorkStartTime").html("").html("使用消防水开始时间<font face=\"宋体\">*</font>");
            $("#tdWorkEndTime").html("").html("使用消防水结束时间<font face=\"宋体\">*</font>");
        }
        switch (mode) {
            case "view":
                $("#btn_Save,#btn_Submit,#btn_Transfer,#btn_Audit").attr("style", "display:none");
                $("input,select,textarea").attr("disabled", "disabled");
                $("#panel2").hide();
                editFile = false;
                riskFlag = false;
                conditionFile = false;
                if (IsHrdl == "true") {
                    if (conditionstate == "1") {
                        $("#panel4").show();
                    } else {
                        $("#panel4").hide();
                    }
                    $("#panel6").hide();
                }
                else {
                    $("#panel6").show();
                    $("#panel4").hide();
                }
                //已完结
                if (state == "3") {
                    $("#divexport").show();
                }
                else {
                    $("#divexport").hide();
                }
                break;
            case "add":
                riskFlag = true;
                $("#select,#choose1").removeAttr("disabled");
                $("#btn_Audit").hide();
                $("#btn_Transfer").hide();
                $("#panel2").hide();
                $("#panel3").hide();
                $("#panel4").hide();
                $("#panel6").hide();
                $("#divexport").hide();
                break;
            case "edit":
                riskFlag = true;
                $("#select,#choose1").removeAttr("disabled");
                $("#btn_Audit").hide();
                $("#btn_Transfer").hide();
                $("#panel2").hide();
                $("#panel3").hide();
                $("#panel4").hide();
                $("#panel6").hide();
                $("#divexport").hide();
                break;
            case "approve":
                editFile = false;
                riskFlag=false;
                $("#btn_Save,#btn_Submit,#chooseTool").attr("style", "display:none");
                $("#apply_tab input,#apply_tab textarea,#apply_tab select").each(function (ele, index) {
                    $(this).attr("disabled", "disabled");
                });
                $("#AuditUserId").val(userid);
                $("#AuditUserName").val(username);
                $("#AuditDeptId").val(deptid);
                $("#AuditDeptCode").val(deptcode);
                $("#AuditDeptName").val(deptname);
                $("#divexport").hide();
                $("#panel4").hide();
                $("#panel6").hide();
                break;
            case "condition":
                editFile = false;
                riskFlag = false;
                conditionFile = true;
                $("#panel2").hide();
                $("#btn_Save,#btn_Submit,#btn_Transfer,#btn_Audit,#chooseTool").attr("style", "display:none");
                $("#apply_tab input,#apply_tab textarea,#apply_tab select").each(function (ele, index) {
                    $(this).attr("disabled", "disabled");
                });
                $("#ConditionPersonId").val(userid);
                $("#ConditionPerson").val(username);
                $("#ConditionDeptId").val(deptid);
                $("#ConditionDeptCode").val(deptcode);
                $("#ConditionDept").val(deptname);
                $("#ConditionTime").val("@DateTime.Now.ToString("yyyy-MM-dd HH:mm")");
                $("#divexport").hide();
                $("#panel6").hide();
                break;
        }
       
        if (rolenames.indexOf("承包商") >= 0 || rolenames.indexOf("分包商") >= 0) {
            $("input[name='WorkDeptType']:eq(1)").prop("checked", "checked");
            $("input[name='WorkDeptType']").attr("disabled", "disabled");
            $("#td_title_projectname").show();
            $("#td_value_projectname").show();
          
        }
        else {
            $("input[name='WorkDeptType']:eq(0)").prop("checked", "checked");
            $("#td_title_projectname").hide();
            $("#td_value_projectname").hide();
            $("#EngineeringName").removeAttr("checkexpession").removeAttr("isvalid");
        }

        $("#ApplyDeptName").val(deptname);
        $("#ApplyDeptId").val(deptid);
        $("#ApplyDeptCode").val(deptcode);
        $("#ApplyUserId").val(userid);
        $("#ApplyUserName").val(username);
        $("#CreateDate").val("@DateTime.Now.ToString("yyyy-MM-dd HH:mm")");

        //选择作业单位类别时，控制工程名称显示
        $("input[name='WorkDeptType']").click(function () {
            //0:单位内部,1:外包单位
            if ($(this).val() == "0") {
                $("#td_title_projectname").hide();
                $("#td_value_projectname").hide();
                $("#EngineeringName").removeAttr("checkexpession").removeAttr("isvalid");

            } else {
                $("#td_title_projectname").show();
                $("#td_value_projectname").show();
                $("#EngineeringName").attr("checkexpession", "NotNull").attr("isvalid", "yes");

            }
            //清空文本框(作业单位,工程,作业人员,作业区域)
            $("#WorkDeptName,#WorkDeptId,#WorkDeptCode,#WorkAreaName,#WorkAreaCode,#EngineeringId,#EngineeringName").val("");
            $("#SpecialtyType").html("");
            $("#SpecialtyType").append('<option value="">请选择</option>');
            clearUser();
        });

        //区域的处理
        $("#WorkAreaName").attr("onclick", "selectArea(window.document.body, 'WorkAreaName,WorkAreaCode');").attr("placeholder", "请选择作业区域");

        //保存
        $("#btn_Save").click(function () {
            AcceptClick("0");
        });

        //提交
        $("#btn_Submit").click(function () {
            AcceptClick("1");
        });


        $("#btn_Export").click(function () {
            goReport();
        });

        //审批转交
        $("#btn_Transfer").click(function () {
            TransferAction();
        });

        //获取表单
        if (!!keyValue) {
            $.SetForm({
                url: "../../HighRiskWork/FireWater/GetFormJson",
                param: { keyValue: keyValue },
                success: function (data) {
                    var conditionData = data.conditionData;
                    var data = data.data;
                    $("#form1").formDeserialize(data);
                    if (data.WorkDeptType == "0") {//单位内部
                        $("#td_title_projectname").hide();
                        $("#td_value_projectname").hide();
                        $("input[name='WorkDeptType']:eq(0)").prop("checked", "checked");
                        $("#EngineeringName").removeAttr("checkexpession").removeAttr("isvalid");
                        GetSpecialty(data.WorkDeptId, data.SpecialtyType);
                    }
                    if (data.WorkDeptType == "1") {//外包单位
                        $("input[name='WorkDeptType']:eq(1)").prop("checked", "checked");
                        $("#td_title_projectname").show();
                        $("#td_value_projectname").show();
                        $("#EngineeringName").attr("checkexpession", "NotNull").attr("isvalid", "yes");
                        GetSpecialty(data.EngineeringId, data.SpecialtyType);
                    }
                    $("#form1").formDeserialize(conditionData);
                    //$("input[name='IsMessage']:eq("+data.IsMessage+")").prop("checked", "checked");
                    curflowid = data.FlowId;
                }

            })
        }

        keyValue = keyValue.length == 0 ? "@Guid.NewGuid().ToString()" : keyValue;
        file_upload.init({
            keyValue: keyValue, extensions: 'jpg,png,jpeg,doc,docx,xls,xlsx,pdf,rar,zip', isImage: false, el: '#uploader1'
        });
        file_upload.bindFiles(editFile, false, keyValue, 'uploader1', editFile);
        file_upload.init({
            keyValue: keyValue + "01", extensions: 'jpg,png,jpeg', isImage: true, el: '#uploader2'
        });
        file_upload.bindFiles(conditionFile, true, keyValue + "01", 'uploader2', conditionFile);
    }
    //保存表单;
    function AcceptClick(type) {
        if (!$('#form1').Validform()) {
            return false;
        }
        var postData = $("#form1").formSerialize(keyValue);
        postData["ApplyState"] = type;
        //存储使用消防水单位类别
        var unittype = $("input[name='WorkDeptType']:checked").val();
        postData["WorkDeptType"] = unittype;
        //var ismessage = $("input[name='IsMessage']:checked").val();
        //postData["IsMessage"] = ismessage;
        var $gridTable = $('#gridAnalyse');
        var risk = $gridTable.jqGrid('getRowData');
        var arr = [];
        var flag = false;
        for (var i = 0; i < risk.length; i++) {
            var dom = risk[i];
            if (($.trim($gridTable.find("textarea[name='atrisk']").eq(i).val()).length == 0 || $.trim($gridTable.find("textarea[name='controls']").eq(i).val()).length == 0 ||$.trim($gridTable.find("textarea[name='worktask']").eq(i).val()).length == 0 ||$.trim($gridTable.find("textarea[name='workprocess']").eq(i).val()).length == 0) && !flag) {
                flag = true;
            } else {
                if($.trim($gridTable.find("textarea[name='worktask']").eq(i).val()).length <=500) {
                    arr.push({
                        WorkTask:$gridTable.find("textarea[name='worktask']").eq(i).val(),
                        WorkProcess:$gridTable.find("textarea[name='workprocess']").eq(i).val(),
                        AtRisk: $gridTable.find("textarea[name='atrisk']").eq(i).val(),
                        Controls: $gridTable.find("textarea[name='controls']").eq(i).val(),
                        WorkId: keyValue,
                        Id: newGuid(),
                        CreateDate: formatDate(new Date(), "yyyy-MM-dd hh:mm:ss")
                    });
                }
                else
                {
                    dialogMsg("工作任务字符过大,不可超过500个字符！", 2);
                    return false;
                }
            }
        }
        if (flag) {
            dialogMsg("工作任务、工序、风险描述和控制措施都不能为空！", 2);
            return false;
        }
        postData["RiskRecord"] = arr;

        $.SaveForm({
            url: "../../HighRiskWork/FireWater/SaveForm?keyValue=" + keyValue,
            param: { jsonData: JSON.stringify(postData) },
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        })
    }

    //根据使用消防水单位排除作业人员
    function chooseUser(type) {
        if(type==1){  
            selectUser({ deptId: '', checkMode: 1, mode: 0, winObject: window.document.body, domId: 'CopyUserNames,,CopyUserIds,', userIds: "CopyUserIds" });
        }
        else
        {
            if (!!$("#WorkDeptId").val()) {
                //作业人员
                selectUser({ deptId: $('#WorkDeptId').val(), checkMode: 1, mode: 1, winObject: window.document.body, domId: 'WorkUserNames,,WorkUserIds', userIds: "WorkUserIds" });
            }
            else {
                dialogMsg('请先选择使用消防水单位！', 0);
            }
        }
    }


    function showmore(type) {
        switch (type) {
            case 0:
                if (!!$("#WorkUserNames").val()) {
                    var html = $("#WorkUserNames").val();
                    $("#modalBody").html(html);
                    $("#QdModal").modal('show');
                }
                else {
                    dialogMsg('请选择作业人员！', 0);
                }
                break;
            case 1:
                if (!!$("#CopyUserNames").val()) {
                    var html = $("#CopyUserNames").val();
                    $("#modalBody").html(html);
                    $("#QdModal").modal('show');
                }
                else {
                    dialogMsg('请选择抄送人！', 0);
                }
                break;
        }
    }

    //选择作业单位
    function selectCompany() {
        var setupcompanytype = $("input[type=radio]:checked").val();
        /**
        1.选择单位内部时，工程名称隐藏,当前角色为“厂级部门”，作业单位为所有单位不包含承包商，否则为作业单位本部门及以下单位。
        2.选择外包单位时，工程名称显示,当前角色为“厂级部门”，作业单位为所有外包单位,否则作业单位为本部门及以下级部门管辖的外包单位。
        3.另工程名称为选择作业单位后单位管辖的工程，选择工程后把作业区域代入文本框。
        **/
        //当前角色为“厂级部门”，作业单位为所有单位，否则为本部门及下及部门单位
        if (setupcompanytype == "0") {
            selectDept('&type=highrisk', 0, 4, '选择使用消防水单位', document.body, 'WorkDeptName,WorkDeptCode,WorkDeptId', "1",function(){
                clearUser();
                var departid = $("#WorkDeptId").val();
                $("#SpecialtyType").html('');
                $("#SpecialtyType").append('<option value="">请选择</option>');
                GetSpecialty(departid, "");
            });
           
        } else {
            selectDept('', 0, 7, '选择使用消防水单位', document.body, 'WorkDeptName,WorkDeptCode,WorkDeptId', "1", function () {
                clearUser();
                $("#EngineeringId,#EngineeringName").val("");
                $("#SpecialtyType").html('');
                $("#SpecialtyType").append('<option value="">请选择</option>');
            });
        }
    }

    function clearUser(){
        //清空与之关联的作业人员
        $("#WorkUserNames,#WorkUserIds").val("");
    }

    //选择工程
    function chooseProject() {
        if (!!$("#WorkDeptName").val()) {
            SelectOutProject(window.document.body, 'EngineeringName,EngineeringId', $("#WorkDeptId").val(), function () {
                var engineeringid = $("#EngineeringId").val()
                $("#SpecialtyType").html('');
                $("#SpecialtyType").append('<option value="">请选择</option>');
                GetSpecialty(engineeringid, "");
                //GetEngineerInfo(engineeringid);
            });

        }
        else {
            dialogMsg('请先选择作业单位！', 0);
        }

    }

    //获取工程详情
    function GetEngineerInfo(id) {
        $.SetForm({
            url: "../../OutsourcingProject/Outsouringengineer/GetFormJson?keyValue=" + id,
            success: function (data) {
                $("#WorkAreaName").val(data.data.ENGINEERAREANAME);
            }
        })
    }

    //获取部门下的专业类别
    function GetSpecialty(departid, stype) {
        var specialtytype = stype;
        if (mode == "edit" || mode == "add") {
            specialtytype = "";
        }
        var workdepttype = $("input[name='WorkDeptType']:checked").val();
        var flag = false;
        $.ajax({
            url: "../../HighRiskWork/Scaffold/GetSpecialtyToJson?deptid=" + departid + "&specialtytype=" + specialtytype + "&workdepttype=" + workdepttype,
            asycn: true,
            type: 'get',
            success: function (data) {
                if (!!data) {
                    var json = JSON.parse(data);
                    for (var i = 0; i < json.length; i++) {
                        if (stype == json[i].itemvalue) {
                            $("#SpecialtyType").append('<option value="' + json[i].itemvalue + '" selected="selected">' + json[i].itemname + '</option>');
                        }
                        else {
                            $("#SpecialtyType").append('<option value="' + json[i].itemvalue + '">' + json[i].itemname + '</option>');
                        }
                    }
                }
            }
        });
    }

    //加载执行信息
    function LoadZxGrid() {
        var selectedRowIndex = 0;
        var $gridTable = $('#conditionGridTable');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/Scaffold/GetConditonToJson?keyvalue=" + keyValue,
            datatype: "json",
            height: "400px",
            postData: {},
            autowidth: true,
            colModel: [
                { label: 'ID', name: 'Id', index: 'Id', width: 500, align: 'center', sortable: false, hidden: true },
                {
                    label: '执行信息', name: 'num', index: 'num', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {

                        return "第" + cellvalue + "次作业执行信息";
                    }
                },
                 {
                     label: '作业时间', name: 'ConditionTime', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                         var html = "";
                         if (!!rowObject.LedgerType) {
                             if (rowObject.LedgerType == "0") {
                                 html = "开始时间:" + formatDate(cellvalue, 'yyyy-MM-dd hh:mm');
                             }
                             else {
                                 html = "结束时间:" + formatDate(cellvalue, 'yyyy-MM-dd hh:mm');
                             }
                         }
                         return html;
                     }
                 },
                { label: '执行情况说明', name: 'ConditionContent', index: 'ConditionContent', width: 500, align: 'center', sortable: false },
                {
                    label: '现场图片', name: 'ScenePicPath', index: 'ScenePicPath', width: 300, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        if (!!rowObject.ScenePicPath) {
                            html = "<div id=\"ScenePic_" + rowObject.Id + "\"><img src=\" ../.." + rowObject.ScenePicPath.substring(1, rowObject.ScenePicPath.length) + "\"  data-original=\" ../.." + rowObject.ScenePicPath.substring(1, rowObject.ScenePicPath.length) + "\" alt=\"\"  style=\"width:150px;height:100px;\" /></div>";
                        }
                        return html;
                    }
                },
                {
                    label: '是否有附件', name: 'isannex', index: 'ISANNEX', width: 150, align: 'center', sortable: false,
                    formatter: function (cellvalue, options, rowObject) {

                        if (rowObject.filenum == 0) {
                            html = "否";
                            return html;

                        } else if (rowObject.filenum > 0) {
                            html = "<a href=javascript:btn_Annex('" + rowObject.Id + "_02" + "') style='color:blue; text-decoration:underline;padding-left:0px;' title='修改'>是</a>";
                            return html;

                        }


                    }

                },
                {
                    label: '填报人', name: 'CreateUserName', index: 'CreateUserName', width: 150, align: 'center', sortable: false
                },
                {
                    label: '填报时间', name: 'CreateDate', index: 'CreateDate', width: 150, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        return formatDate(cellvalue, 'yyyy-MM-dd hh:mm');
                    }

                }
            ],

            pager: false,
            rowNum: "100",
            rownumbers: true,
            shrinkToFit: true,
            gridview: true,
            ondblClickRow: function (id) {

            },
            gridComplete: function () {
                $("#" + this.id).setSelection(selectedRowIndex, false);
                //获取所有数据
                var datas = $("#" + this.id).jqGrid("getRowData");
                if (!!datas) {
                    $(datas).each(function (i, ele) {
                        viewimg(ele.Id + "_01", "#ScenePic_" + ele.Id, ele.ScenePicPath); //现场图片
                    });
                }
                Merger('conditionGridTable', new Array('num'));
            }
        });
    }


    //预览图片
    function viewimg(id, objid, epath) {
        var $obj = $(objid);
        $.post("../../PublicInfoManage/ResourceFile/GetFilesByRecId", { recId: id }, function (data) {
            var files = eval("(" + data + ")");
            if (files.length > 0) {
                $(files).each(function (i, file) {
                    if (!!file.filepath) {
                        var filepath = file.filepath.substring(15, file.filepath.length);
                        if (!!epath && epath.indexOf(filepath) < 0) {
                            var $li = $('<img title="点击查看大图" alt="点击查看大图" style=\"width:0px;height:0px;\" data-original="' + "/" + file.filepath.substring(1, file.filepath.length) + '" src="' + "/" + file.filepath.substring(1, file.filepath.length) + '"  />');
                            $li.appendTo($obj);
                        }
                    }
                });
                $obj.viewer({ url: "data-original" });
            }
        });
    }


    //加载作业安全分析
    function GetRiskGrid() {
        var $gridTable = $('#gridAnalyse');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/HighRiskCommonApply/GetRiskListJson",
            postData: { workId: keyValue },
            datatype: "json",
            height: "200px",
            autowidth: true,
            colModel: [
                { label: '主键', name: 'Id', hidden: true },
                {
                    label: '操作', name: 'Oper', width: 80, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        if (riskFlag) {
                            html += "&nbsp;&nbsp;<a href=javascript:delRow('" + rowObject.Id + "',this)  title='删除'><i class='fa fa-trash-o'></i></a>";
                        }
                        return html;
                    }
                },
                {
                    label: '工作任务', name: 'WorkTask', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="worktask" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:120px;" class="form-control"';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                },
                {
                    label: '工序', name: 'WorkProcess', width: 200, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="workprocess" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:120px;" class="form-control" >';
                        if (cellvalue) {
                            html += cellvalue + '</textarea>';
                        }
                        else {
                            html += '</textarea>';
                        }
                        return html;
                    }
                },
                {
                    label: '风险描述', name: 'AtRisk', width: 250, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="atrisk" ' + str + ' role="textbox" maxlength="500"  style="width: 100%;height:120px;" class="form-control" ';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                },
                {
                    label: '风险控制措施', name: 'Controls', width: 200, sortable: false, align: 'center'
                    , formatter: function (cellvalue, options, rowObject) {
                        var str = "";
                        if (!riskFlag) {
                            str = 'disabled = "disable"';
                        }
                        var html = '<textarea type="text"  name="controls" ' + str + ' role="textbox" maxlength="500" style="width: 100%;height:120px;" class="form-control" ';
                        html += '>' + cellvalue + '</textarea>';
                        return html;
                    }
                }
            ],
            viewrecords: true,
            rowNum: 100000,
            sortname: 'CreateDate',
            sortorder: 'desc',
            rownumbers: true,
            shrinkToFit: false,
            gridview: true

        });
    }

    //删除数据行
    function delRow(id, obj) {
        var jqTable = $("#gridAnalyse");
        var idx = dialogConfirm("确认删除吗？", function (isSure) {
            if (isSure) {
                jqTable.delRowData(jqTable.getGridParam('selrow'));
                top.layer.close(idx);
            } else {
                top.layer.close(idx);
            }
        });
    }

    //添加行
    function addItems(obj) {
        var rowId = $("#gridAnalyse").jqGrid('getRowData').length;
        $("#gridAnalyse").addRowData(rowId, { ID: newGuid(),WorkTask:"",WorkProcess:"", AtRisk: "", Controls: "" }, "first");
    }

    //从风险库中选择数据
    function selRisk() {
        dialogOpen({
            id: 'SelectRisk',
            title: '选择工作任务',
            url: '/HighRiskWork/HighRiskCommonApply/Select?worktypevale=-4',
            width: ($(window).width() - 200) + 'px',
            height: ($(window).height() - 20) + 'px',
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick(window.document.body);
            }
        })
    }

    function auditCheck(obj) {
        var signImg = getUserSignPic(userid);
        if (!!signImg) {
            $("#AuditSignImg").attr("src", "../.." + signImg);
        } else {
            $(obj).get(0).checked = false;
        }
    }

    //申请审核
    function SubmitAction() {
        if (!$('#form1').Validform()) {
            return false;
        }
        //审核结果
        var auditresult = $("input[name='AuditState']:checked").val();
        if (auditresult == "" || auditresult == undefined) {
            dialogAlert("审核结果未勾选,无法进行提交!!!", function () {
                return false;
            })
            return false;
        }
        var postData = {
            ScaffoldId: keyValue,//关联id
            AuditUserId: $("#AuditUserId").val(),
            AuditUserName: $("#AuditUserName").val(),
            AuditDeptId: $("#AuditDeptId").val(),
            AuditDeptName: $("#AuditDeptName").val(),
            AuditDeptCode: $("#AuditDeptCode").val(),
            AuditRemark: $("#AuditRemark").val(),
            AuditDate: $("#AuditDate").val(),
            AuditState: $("input[name=AuditState]:checked").val(),
            AuditSignImg: $("#AuditSignImg").attr("src")
        }
        $.SaveForm({
            url: "../../HighRiskWork/FireWater/AuditSubmit?keyValue=" + keyValue,
            param: { jsonData: JSON.stringify({ auditEntity: postData }) },
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
                top.refreshWork();//刷新首页待办事项
            }
        });
    }
    //提交执行情况
    function SubmitCondition() {
        if (!$('#form1').Validform()) {
            return false;
        }
        var postData = {
            FireWaterId: keyValue,//关联id
            ConditionDept: $("#ConditionDept").val(),
            ConditionDeptCode: $("#ConditionDeptCode").val(),
            ConditionDeptId: $("#ConditionDeptId").val(),
            ConditionPerson: $("#ConditionPerson").val(),
            ConditionPersonId: $("#ConditionPersonId").val(),
            ConditionTime: $("#ConditionTime").val(),
            ConditionContent: $("#ConditionContent").val()
        }
        $.SaveForm({
            url: "../../HighRiskWork/FireWater/SubmitCondition?keyValue=",
            param: { jsonData: JSON.stringify({ ConditionEntity: postData }) },
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        });
    }
    //加载审核列表
    function loadApproveGrid() {
        var selectedRowIndex = 0;
        var $gridTable = $('#approveGridTable');
        $gridTable.jqGrid({
            url: "../../HighRiskWork/Scaffold/GetScaffAuditToJson?scaffoldid=" + keyValue,
            datatype: "json",
            height: "200px",
            postData: {},
            autowidth: true,
            colModel: [
                 {
                     label: '审核部门', name: 'AuditDeptName', width: 200, align: 'center', sortable: false
                 },
                { label: '审核人', name: 'AuditUserName', index: 'AuditUserName', width: 120, align: 'center', sortable: false },
                {
                    label: '审核结果', name: 'AuditState', index: 'AuditState', width: 150, align: 'center', sortable: false,
                    formatter: function (cellvalue, options, rowObject) {
                        var html = rowObject.AuditState == 1 ? "同意" : "不同意";
                        return html;
                    }
                },
                {
                    label: '审核意见', name: 'AuditRemark', index: 'AuditRemark', width: 300, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var html = "";
                        if (!!rowObject.AuditRemark) {
                            var content = rowObject.AuditRemark.length > 20 ? rowObject.AuditRemark.substring(0, 20) + "......" : rowObject.AuditRemark;

                            html = "<div title=" + content + ">" + content + "</div>";
                        }
                        return html;
                    }
                },
                {
                    label: '审核时间', name: 'AuditDate', index: 'AuditDate', width: 150, align: 'center', sortable: false, formatter: "date", formatoptions: { srcformat: 'Y-m-d H:i', newformat: 'Y-m-d H:i' }

                },
                {
                    label: '签名', name: 'AuditSignImg', index: 'AuditSignImg', width: 150, align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        var content = !!rowObject.AuditSignImg ? rowObject.AuditSignImg : "";
                        var html = "";
                        if (content == "" || content == undefined) {
                            var html = "<img  style=\"height:50px;\" />&nbsp;";
                        } else {
                            html = "<img style=\"height:50px;\"  src=\"../.." + content + "\"/>&nbsp;";
                        }

                        return html;
                    }
                }
            ],
            pager: false,
            rowNum: "20",
            rownumbers: true,
            shrinkToFit: false,
            gridview: true,
            ondblClickRow: function (id) {

            }
        });
    }


    //导出
    function goReport() {
        location.href = "../../HighRiskWork/FireWater/ExportDetails?keyValue=" + keyValue;
    }

    function TransferAction() {
        var url = '/HighRiskWork/HighRiskCommonApply/TransferForm?keyValue=' + keyValue + "&FlowId=" + curflowid;
        idx = dialogOpen({
            id: "Transfer",
            title: '审批转交',
            url: url,
            width: ($(top.window).width() * 0.4) + "px",
            height: ($(top.window).height() * 0.4) + "px",
            callBack: function (iframeId) {
                top.document.getElementById(iframeId).contentWindow.AcceptClick();
                //top.layer.close(idx);
                //$.currentIframe().$("#gridTable").trigger("reloadGrid");
            },
            cancel: function (index) {
            }
        });
    }

    //查看附件
    function btn_Annex(id) {
        var keyValue = id;
        if (checkedRow(keyValue)) {
            var dlg = dialogOpen({
                id: 'Annex',
                title: '附件列表',
                url: '/OccupationalHealthManage/Occupatioalstaff/FileList?keyValue=' + keyValue,
                width: '600px',
                height: '550px',
                btn: ["关闭"],
                callBack: function (iframeId) {
                    top.layer.close(dlg);
                }
            })
        }
    }

    function chooseTool()
    {
        var idx = dialogOpen({
            id: "Tool",
            url: "/HighRiskWork/FireWater/ToolSelect",
            title: "请选择消防工具",
            width: "500px",
            height: "500px",
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick();
                top.layer.close(idx);
            }
        });
    }
</script>
<div style="margin: 0px; margin-top: 40px; background-color: white;">
    <table class="form" id="apply_tab">
        <tr>
            <td class="formTitle">申请单位<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <input id="ApplyDeptName" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" disabled="disabled" />
                <input type="hidden" id="ApplyDeptId" value="" /><input type="hidden" id="ApplyDeptCode" value="" />
            </td>
            <td class="formTitle">申请人<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <input id="ApplyUserName" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" disabled="disabled" />
                <input type="hidden" id="ApplyUserId" value="" />
            </td>
        </tr>
        <tr>
            <td class="formTitle">申请时间<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <input id="CreateDate" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" disabled="disabled" />
            </td>
            <td class="formTitle">申请编号<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <input id="ApplyNumber" type="text" class="form-control" placeholder="自动生成" disabled="disabled" />
            </td>
        </tr>
        <tr>
            <td class="formTitle" id="tddept">使用消防水单位类别<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <div class="radio-inline">
                    <label>
                        <input type="radio" name="WorkDeptType" id="WorkDeptType1" value="0" />单位内部
                    </label>
                </div>
                <div class="radio-inline">
                    <label>
                        <input type="radio" name="WorkDeptType" id="WorkDeptType2" value="1" />外包单位
                    </label>
                </div>
            </td>
            <td class="formTitle">使用消防水单位<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <input id="WorkDeptName" type="text" class="form-control" placeholder="请选择使用消防水单位" isvalid="yes" checkexpession="NotNull" readonly onclick="selectCompany()" />
                <input type="hidden" id="WorkDeptId" />
                <input type="hidden" id="WorkDeptCode" />
            </td>
        </tr>
        <tr>
            <td class="formTitle" id="td_title_projectname">工程名称<font face="宋体">*</font></td>
            <td class="formValue" id="td_value_projectname" colspan="2">
                <input id="EngineeringName" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" readonly placeholder="请选择工程" onclick="chooseProject();" />
                <input id="EngineeringId" type="hidden" />
            </td>
            <td class="formTitle" id="tdSpecialtyType">专业类别<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <select id="SpecialtyType" name="SpecialtyType" class="form-control" isvalid="yes" checkexpession="NotNull">
                    <option value="">请选择</option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="formTitle">作业人员<font face="宋体">*</font></td>
            <td class="formValue" colspan="4">
                <input id="WorkUserNames" type="text" class="form-control" isvalid="yes" placeholder="请选择作业人员" checkexpession="NotNull" readonly onclick="chooseUser(0)" />
                <input type="hidden" id="WorkUserIds" value="" />
            </td>
            <td>
                <a id="btn_more" class="btn btn-primary" href="javascript:showmore(0);"><i class="fa fa-check"></i>&nbsp;更&nbsp;&nbsp;多</a>
            </td>
        </tr>
        <tr>
            <td class="formTitle" id="tdWorkStartTime">计划使用消防水开始时间<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <input id="WorkStartTime" type="text" isvalid="yes" checkexpession="NotNull" class="form-control input-wdatepicker" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm', maxDate: '#F{$dp.$D(\'WorkEndTime\')}' })">
            </td>
            <td class="formTitle" id="tdWorkEndTime">计划使用消防水结束时间<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <input id="WorkEndTime" type="text" isvalid="yes" checkexpession="NotNull" class="form-control input-wdatepicker" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm', minDate: '#F{$dp.$D(\'WorkStartTime\')}' })">
            </td>
        </tr>
        <tr>
            <td class="formTitle">使用消防水区域<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <input id="WorkAreaName" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" readonly />
                <input id="WorkAreaCode" type="hidden" class="form-control" />
            </td>
        </tr>
        <tr>
            <td class="formTitle">使用消防水地点<font face="宋体">*</font></td>
            <td class="formValue" colspan="5">
                <textarea id="WorkPlace" class="form-control" isvalid="yes" checkexpession="NotNull" style="min-height: 30px;" maxlength="100"></textarea>
            </td>
        </tr>
        <tr>
            <td class="formTitle">使用消防水申请用途</td>
            <td class="formValue" colspan="5">
                <textarea id="WorkUse" class="form-control" style="min-height: 80px;" maxlength="500" placeholder="申请用途"></textarea>
            </td>
        </tr>
        <tr>
            <td class="formTitle">使用消防水工作内容<font face="宋体">*</font></td>
            <td class="formValue" colspan="5">
                <textarea id="WorkContent" class="form-control" isvalid="yes" checkexpession="NotNull" style="min-height: 80px;" maxlength="500" placeholder="请填写具体工作任务和动用消防设施名称、部位、数量"></textarea>
            </td>
        </tr>
        <tr>
            <td class="formTitle" id="tdMeasure">使用中应采取安全措施<font face="宋体">*</font></td>
            <td class="formValue" colspan="5">
                <textarea id="Measure" class="form-control" isvalid="yes" checkexpession="NotNull" style="min-height: 80px;" maxlength="500"></textarea>
            </td>
        </tr>
        <tr>
            <td class="formTitle">使用消防工具</td>
            <td class="formValue" colspan="5">
                <textarea id="Tool" class="form-control" style="min-height: 80px;width:80%;float:left" maxlength="500" placeholder="请选择或者手动输入"></textarea>
                <input type="hidden" id="hdTool" />
                <a id="chooseTool" class="btn btn-primary"  href="javascript:chooseTool();"><i class="fa fa-check"></i>消防工具</a>
            </td>
        </tr>
        <tr>
            <td class="formTitle">抄送人</td>
            <td class="formValue" colspan="4">
                <input id="CopyUserNames" type="text" class="form-control" placeholder="请选择抄送人" readonly onclick="chooseUser(1)" />
                <input type="hidden" id="CopyUserIds" value="" />
            </td>
            <td>
                <a id="btn_more1" class="btn btn-primary" href="javascript:showmore(1);"><i class="fa fa-check"></i>&nbsp;更&nbsp;&nbsp;多</a>
            </td>
        </tr>
        @*<tr>
            <td class="formTitle" id="tddept">短信通知审批人<font face="宋体">*</font></td>
            <td class="formValue" colspan="2">
                <div class="radio-inline">
                    <label>
                        <input type="radio" name="IsMessage" id="IsMessage1" value="0" checked="checked" />否
                    </label>
                </div>
                <div class="radio-inline">
                    <label>
                        <input type="radio" name="IsMessage" id="IsMessage2" value="1" />是
                    </label>
                </div>
            </td>
        </tr>*@
        <tr>
            <td class="formTitle">附件</td>
            <td class="formValue" colspan="5">
                <div class="ibox">
                    <div id="uploader1" class="uploader" style="border: 1px solid #ccc; margin-top: 10px; min-height: 100px; margin-bottom: 10px;">
                        <div class="queueList">
                            <div id="dndArea" class="placeholder">
                                <div class="filePicker" style="margin-left: 25px; margin-top: 10px;"></div>
                            </div>
                        </div>
                        <div class="statusBar" style="display: none;">
                            <div class="progress">
                                <span class="text">0%</span>
                                <span class="percentage"></span>
                            </div>
                            <div class="info"></div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    </table>
</div>
<div class="panel panel-default" id="riskAnalyse">
    <div class="panel-heading">
        <strong>&nbsp;&nbsp;作业安全分析</strong>
        <span class="tools pull-right">
            <a href="javascript:selRisk()" id="select" disabled="disabled" class="btn btn-primary btn-xs">选择工作任务</a>&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="javascript:addItems(this)" id="choose1" disabled="disabled" class="btn btn-primary btn-xs">新增工作任务</a>&nbsp;&nbsp;&nbsp;&nbsp; <a class="fa fa-chevron-down" title="展开/收起"></a>
        </span>
    </div>
    <div class="panel-body">
        <table id="gridAnalyse"></table>
        <div id="AnalysePager"></div>
    </div>
</div>
<div class="panel panel-default" id="panel2">
    <div class="panel-heading">
        <strong>&nbsp;&nbsp;申请审核信息</strong>
        <span class="tools pull-right">
            <a class="fa fa-chevron-down" title="展开/收起"></a>
        </span>
    </div>
    <div class="panel-body">
        <div style="margin-top: 5px; margin-right: 30px;">
        <div class="panel-body">
            <div style="margin-top: 5px; margin-right: 30px;">
                <table class="form">
                    <tr>
                        <td class="formTitle">审核部门<font face="宋体">*</font></td>
                        <td class="formValue">
                            <input id="AuditDeptName" type="text" class="form-control" checkexpession="NotNull" readonly />
                            <input type="hidden" id="AuditDeptId" />
                            <input type="hidden" id="AuditDeptCode" />
                        </td>
                        <td class="formTitle">审核人<font face="宋体">*</font></td>
                        <td class="formValue">
                            <input id="AuditUserName" type="text" class="form-control" checkexpession="NotNull" readonly />
                            <input type="hidden" id="AuditUserId" />
                        </td>
                        <td class="formTitle">审核时间<font face="宋体">*</font></td>
                        <td class="formValue">
                            <input id="AuditDate" type="text" class="form-control" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm:ss' })" value="@DateTime.Now.ToString("yyyy-MM-dd HH:mm")" disabled="disabled" readonly checkexpession="NotNull" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">审核结果<font face="宋体">*</font></td>
                        <td class="formValue" colspan="5">
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="AuditState" id="AuditState1" value="1" onclick="auditCheck(this, 0)"/>同意
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="AuditState" id="AuditState2" value="0" onclick="auditCheck(this, 0)"/>不同意
                                </label>
                            </div>
                        </td>
                        <td class="formTitle">签名<font face="宋体">*</font></td>
                        <td class="formValue">
                            <img id="AuditSignImg" style="height: 50px;" />
                        </td>
                    </tr>
                    <tr>
                        <td class="formTitle">审核意见</td>
                        <td class="formValue" colspan="5">
                            <textarea id="AuditRemark" name="AuditRemark" class="form-control" maxlength="1000"></textarea>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        </div>
    </div>
</div>
<div class="panel panel-default" id="panel3">
    <div class="panel-heading">
        <strong>&nbsp;&nbsp;申请审核记录</strong>
        <span class="tools pull-right">
            <a class="fa fa-chevron-down" title="展开/收起"></a>
        </span>
    </div>
    <div class="panel-body">
        <div style="margin-top: 5px; margin-right: 30px;">
            <table id="approveGridTable"></table>
        </div>
    </div>
</div>
<div class="panel panel-default" id="panel4">
    <div class="panel-heading">
        <strong>&nbsp;&nbsp;执行情况确认</strong>
        <span class="tools pull-right">
            <a class="fa fa-chevron-down" title="展开/收起"></a>
        </span>
    </div>
    <div class="panel-body">
        <div style="margin-top: 5px; margin-right: 30px;">
            <div class="panel-body">
                <div style="margin-top: 5px; margin-right: 30px;">
                    <table class="form">
                        <tr>
                            <td class="formTitle">执行部门<font face="宋体">*</font></td>
                            <td class="formValue">
                                <input id="ConditionDept" type="text" class="form-control" checkexpession="NotNull" readonly />
                                <input type="hidden" id="ConditionDeptId" />
                                <input type="hidden" id="ConditionDeptCode" />
                            </td>
                            <td class="formTitle">执行人<font face="宋体">*</font></td>
                            <td class="formValue">
                                <input id="ConditionPerson" type="text" class="form-control" checkexpession="NotNull" readonly />
                                <input type="hidden" id="ConditionPersonId" />
                            </td>
                            <td class="formTitle">执行时间<font face="宋体">*</font></td>
                            <td class="formValue">
                                <input id="ConditionTime" type="text" class="form-control" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm:ss' })" value="@DateTime.Now.ToString("yyyy-MM-dd HH:mm")" disabled="disabled" readonly checkexpession="NotNull" />
                            </td>
                        </tr>
                        <tr>
                            <td class="formTitle">执行情况</td>
                            <td class="formValue" colspan="5">
                                <textarea id="ConditionContent" name="ConditionContent" class="form-control" maxlength="800"></textarea>
                            </td>
                        </tr>
                    </table>
                    <div id="div_xk" class="ibox">
                        <div class="ibox-title">
                            <h5>执行照片</h5>
                            <div class="ibox-tools">
                            </div>
                        </div>
                        <div class="ibox-content">
                            <div id="uploader2" class="uploader" style="border:1px solid #ccc; margin-top:10px; min-height:80px; margin-bottom:10px;">
                                <div class="queueList">
                                    <div id="File" class="placeholder">
                                        <div class="filePicker" style="margin-left:25px; margin-top:10px;"></div>
                                    </div>
                                </div>
                                <div class="statusBar" style="display:none;">
                                    <div class="progress">
                                        <span class="text">0%</span>
                                        <span class="percentage"></span>
                                    </div>
                                    <div class="info"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
<div class="panel panel-default" id="panel6">
    <div class="panel-heading">
        <strong>&nbsp;&nbsp;作业执行信息</strong>
        <span class="tools pull-right">
            <a class="fa fa-chevron-down" title="展开/收起"></a>
        </span>
    </div>
    <div class="panel-body">
        <div style="margin-top: 5px; margin-right: 30px;">
            <table id="conditionGridTable"></table>
        </div>
    </div>
</div>

<div class="form-button" style="top: 40px; text-align: left; padding-left: 20px; position: fixed; bottom: auto; z-index: 1000;">
    <div style="float: left;">
        <a id="btn_Save" class="btn btn-primary"><i class="fa fa-check"></i>&nbsp;保&nbsp;&nbsp;存</a>
        &nbsp; &nbsp;
        <a id="btn_Submit" class="btn btn-primary"><i class="fa fa-mail-forward"></i>&nbsp;提&nbsp;&nbsp;交</a>
        &nbsp; &nbsp;
        <a id="btn_Audit" class="btn btn-primary" onclick="SubmitAction()"><i class="fa fa-mail-forward"></i>&nbsp;审&nbsp;&nbsp;核</a>
        &nbsp; &nbsp;
        <a id="btn_Transfer" class="btn btn-primary"><i class="fa fa-mail-forward"></i>&nbsp;审&nbsp;&nbsp;批&nbsp;&nbsp;转&nbsp;&nbsp;交</a>
        &nbsp; &nbsp;
    </div>
</div>
<div class="form-button" style="top: 40px; text-align: left; padding-left: 20px; position: fixed; bottom: auto; z-index: 1000;" id="divexport">
    <div style="float: left;">
        <a id="btn_Export" class="btn btn-primary" style="background-color: #2e99d4; border-color: #2e99d4;"><i class="fa fa-download"></i>&nbsp;导&nbsp;&nbsp;出</a>
    </div>
</div>
<div class="modal" id="QdModal">
    <div class="modal-dialog" style="width: 300px; margin-top: 100px;">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h5>人员</h5>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button id="btnModal" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
