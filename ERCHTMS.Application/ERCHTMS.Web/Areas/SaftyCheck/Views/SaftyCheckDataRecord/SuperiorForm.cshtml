@{;
    ViewBag.Title = "表单页面";
    Layout = "~/Views/Shared/_Form.cshtml";
}
<script src="~/Content/scripts/business/Common.js" type="text/javascript"></script>
<script>
    var recid = request('recid');
    var rqaction = request('action');
    var belongdeptid = request('belongdeptid');
    var ctype = request('ctype');
    var cname = request('cname');
    var zj = request('zj');//存在的时候显示的是制定检查计划，不存在的时候显示的是登记检查结果
    var selectedRowIndex = 0;
    var dataRows = [];//返回的所有的选中风险点的IDs   
    var choose = "";//1：选择现有检查表-2：现在部门检查表,保存后需要重新生成一张新的检查表
    var isShow = "@(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetItemValue("IsShowCheckContent").Trim())";
    $(function () {
        if (isShow.length > 0) {
            $(".hidecontent").hide();
        }
        //设置title       
        $("#showTitle").html("&nbsp;&nbsp;安全检查");
        //安全检查类型        
        $("#CheckDataType").ComboBox({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "SaftyCheckType" },
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "200px"            
        });
        var sct = $("#CheckDataType-option");
        var lis = sct.find("li");
        lis.each(function (i) {
            var it = $(this);
            if (it.text() == "日常安全检查") {
                it.remove();
                //it.text("其他安全检查");
                //$(lis[lis.length - 1]).aft    er(it);
            }
        })        
        $.ajax({          
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            data: { EnCode: "SuperiorCheckLevel" },
            type: "GET",
            dataType: "json",
            async: false,
            success: function (data) {
                //data = data.reverse();
                //data.push({ ItemValue: "0", ItemName: "省公司安全检查" });
                //data.reverse();
                //安全检查级别
                var chkLevel = $("#CheckLevel");
                chkLevel.ComboBox({
                    id: "ItemValue",
                    text: "ItemName",
                    description: "==请选择==",
                    height: "200px",
                    data : data
                });
                //chkLevel.attr("data-text", "省公司安全检查");
                //chkLevel.attr("data-value", "0");
                //chkLevel.ComboBoxSetValue("0");
            }
        });
       
        initControl();
        GetGrid();
    });
    function chgCheckDateType(obj) {
        ctype = $(obj).attr("data-value");
    }
    //初始化控件
    function initControl() {
        //$("#CheckDataType").ComboBoxSetValue(ctype);
        //获取表单
        if (!!recid) {
            $.SetForm({
                url: "../../SaftyCheck/SaftyCheckDataRecord/GetFormJson",
                param: { keyValue: recid },
                success: function (data) {
                    $("#form1").formDeserialize(data);
                    if (data.CheckLevel == "0") {
                        $("#CheckLevel").ComboBoxSetValue(data.SJCheckLevel);
                    }
                    //是否同步可见
                    if (data.IsSynView == "1") {
                        $("input[name='IsSynView']:eq(0)").prop("checked", "checked");  //完成
                    }
                    else {
                        $("input[name='IsSynView']:eq(1)").prop("checked", "checked"); //未完成
                    }
                    
                }
            })
        } else {
            $("#Export").attr("disabled", "disabled");
        }

        if (rqaction == "view" || rqaction == "edit") {
            $("#Choose").attr("disabled", "disabled");
            $("#ChooseDept").attr("disabled", "disabled");
           
        }
        if (rqaction == "view") {
            disabledControl();
            $(".btn10").remove();
        }
        if (rqaction == "add") {
            recid = newGuid();
        }
    }
    function getDeptCode() {
        var codes = "";
        $(".ckuser").each(function (i, dom) {
            if ($(dom).attr("ucode") != undefined) {
                var arr = $(dom).attr("ucode").split(',');
                $(arr).each(function (j, code) {
                    if (code.length > 0) {
                        code = code + ",";
                        if (codes.indexOf(code) < 0) {
                            codes += code;
                        }
                    }
                });
            }

        });
        if (codes.length > 0) {
            codes = codes.substring(0, codes.length - 1);
        }
        return codes;
    }
    //新增安全检查表项
    var dofrom = null;
    function addItems(bid) {
        dofrom = dialogOpen({
            id: "PrjectItem",
            title: "新增检查项目",
            url: '/SaftyCheck/SaftyCheckDataDetail/Form?mode=0',
            width: "800px",
            height: "400px",
            callBack: function (iframeId) {
                top.document.getElementById(iframeId).contentWindow.AcceptClick();
                choose = 0;
            }
        });
    };
    //新增检查项目
    function addCheckContent(obj, stid) {
        var title = $(obj).attr("title");
        var li = $("#gridTable").find("li[oname='" + title + "']:last");
        var id = newGuid();
        var nli = "<li pid='" + id + "'><input stid='" + stid + "' style='width:100%;height:30px;' type='text' class='form-control ckuser' placeholder='请选择检查人员' value='" + $("#CheckUsers").val() + "'  onclick=selCheckUsers('" + stid + "',this,1) isvalid='yes' checkexpession='NotNull' uid='" + $("#CheckUserIds").val() + "' ucode='" + $("#CheckDeptCode").val() + "' oname='" + $(obj).attr("title") + "' rid='" + $(obj).parent().prev().prev().text() + "' /></li>";
        if (li != undefined) {
            li.parent().append("<li style='border-bottom:1px solid #ccc' pid='" + id + "'><input style='border: none;width:90%;height:30px;'  type='text'  class='ckcontent' onchange='setChange(this)' /><a onclick=\"removeCheckContent(this)\" title='删除检查内容'><i class='fa fa-minus-circle'></i></a></li>");
            li.parent().parent().next().find("ul").append(nli);
        } else {
            $(obj).parent().next().find("ul").append("<li style='border-bottom:1px solid #ccc' pid='" + id + "'><input style='border: none;width:90%;height:30px;' type='text' class='ckcontent' onchange='setChange(this)' /><a onclick=\"removeCheckContent(this)\" title='删除检查内容'><i class='fa fa-minus-circle'></i></a></li>");
            $(obj).parent().next().next().find("ul").append(nli);
        }
        setInfo();
    }
    //删除检查对象
    function delRow(obj) {
        var idx = dialogConfirm("确认删除吗？", function (isSure) {
            if (isSure) {
                var grid = $("#gridTable");
                var val = $(obj).parent().children().eq(0).attr("title");
                grid.find("span[title='" + val + "']").each(function (j, dom) {
                    grid.delRowData($(dom).parent().parent().attr("id"));
                });
                top.layer.close(idx);
            }
        });
    }
    //选择设备
    var nodeSB = null;
    function selEquipment(obj) {
        nodeSB = $(obj).parent().find("span").eq(0).get(0);
        selectEquipment(window, 'deviceid', "0&from=0");
    }
    var nodeDS = null;
    //选择危险源
    function selDangerSource(obj) {
        nodeDS = $(obj).parent().find("span").eq(0).get(0);
        selectHisrelationhd_qd(window, 'deviceid', "0&from=0");
    }
    //加载表格(检查表详情项)
    function GetGrid() {
        var queryJson = {
            recid: recid,
            isdata: 1
        }
        var hiddenState = false;
        if (zj == "0") {
            hiddenState = true;
        }
        var $gridTable = $("#gridTable");
        $gridTable.jqGrid({
            url: "../../SaftyCheck/SaftyCheckDataDetail/GetTableListJson",
            postData: { queryJson: JSON.stringify(queryJson) },//绑定grid加参数
            datatype: "json",
            height: 350,
            autowidth: true,
            rowNum: 100000,
            colModel: [
                  { label: '主键', name: 'pkid', hidden: true },
                { label: '检查对象type', name: 'checkobjecttype', hidden: true },
                { label: '引用检查项目ID', name: 'rid', hidden: true },
                {
                    label: '风险描述', name: 'content',align: 'left', sortable: false, hidden: true
                },
                  {
                      label: '检查对象', name: 'name', width: 350, align: 'left', sortable: false, headerAlign: 'center', classes: "name1"
                       , formatter: function (cellvalue, options, rowObject) {
                           cellvalue = cellvalue.replace(/？/g, "");
                           var ctype = rowObject.checkobjecttype == null || rowObject.checkobjecttype == undefined || rowObject.checkobjecttype == "undefined" || rowObject.checkobjecttype == "null" ? "3" : rowObject.checkobjecttype;
                           if (rqaction == "view") {
                               return "<span  title='" + rowObject.name + "' id='" + rowObject.stid + "' ctype='" + ctype + "'>" + rowObject.name + '</span>';
                           } else {
                               var innerText = "<span title='" + rowObject.name + "' id='" + rowObject.stid + "' ctype='" + ctype + "'>" + cellvalue + '</span>&nbsp;&nbsp;<i class="fa fa-user" onclick="selCheckUsers(\'' + rowObject.stid + '\',this,0)" title="选择检查人员" style="cursor:pointer;"></i>';
                               innerText += "<a onclick=\"addCheckContent(this,'" + rowObject.stid + "')\"  title='" + rowObject.name + "'><i class='fa fa-plus-circle'></i></a>";
                               innerText += "<a onclick=\"delRow(this)\" title='删除'><i class='fa fa-minus-circle'></i></a>";
                               innerText += "<a onclick=\"selEquipment(this)\" title='选择设备'><i class='fa fa-gavel'></i></a>";
                               innerText += "<a onclick=\"selDangerSource(this)\" title='选择危险源'><i class='fa fa-mixcloud'></i></a>";
                               return innerText;
                           }
                       }
                  },
                {
                    label: '检查内容', name: 'require', width: 400, align: 'left', sortable: false, headerAlign: 'center'
                    , formatter: function (cellvalue, options, rowObject) {
                        if (!!rowObject.require) {
                            if (rowObject.require.indexOf("<ul") < 0) {
                                var innerText = "<ul style='list - style:none; '>";
                                cellvalue = rowObject.require.split('|');
                                $(cellvalue).each(function (i, dom) {
                                    if (rqaction != "view") {
                                        innerText += "<li oname='" + rowObject.name + "' pid='" + rowObject.pkid + "'><input style='border: none;width:90%;height:30px;' type='text' title='" + dom + "' value='" + dom + "' onchange='setChange(this)' class='ckcontent' rowid='" + options.rowId + "' /><a onclick=\"removeCheckContent(this,'" + rowObject.name + "')\"   title='删除检查内容'><i class='fa fa-minus-circle'></i></a></li>";
                                    } else {
                                        innerText += "<li oname='" + rowObject.name + "' pid='" + rowObject.pkid + "'><input style='border: none;width:90%;height:30px;' type='text' title='" + dom + "' value='" + dom + "' onchange='setChange(this)' class='ckcontent' rowid='" + options.rowId + "' /></li>";
                                    }
                                });
                                innerText += "</ul>";
                                return innerText;
                            } else {
                                var content = $.parseHTML(cellvalue);
                                var li = $(content).find("li");
                                var innerText = "<ul style='list - style:none; '>";
                                $(li).each(function (i, dom) {
                                    if (!!$(dom).text()) {
                                        if (rqaction != "view") {
                                            innerText += "<li oname='" + rowObject.name + "' pid='" + rowObject.pkid + "'><input style='border: none;width:90%;height:30px;' type='text' title='" + $(dom).text() + "' value='" + $(dom).text() + "' onchange='setChange(this)' class='ckcontent' rowid='" + options.rowId + "'/><a onclick=\"removeCheckContent(this,'" + rowObject.name + "')\"   title='删除检查内容'><i class='fa fa-minus-circle'></i></a></li>";
                                        } else {
                                            innerText += "<li oname='" + rowObject.name + "' pid='" + rowObject.pkid + "'><input style='border: none;width:90%;height:30px;' type='text' title='" + $(dom).text() + "' value='" + $(dom).text() + "' onchange='setChange(this)' class='ckcontent' rowid='" + options.rowId + "'/></li>";
                                        }
                                    }
                                });
                                innerText += "</ul>";
                                return innerText;

                            }
                        } else {
                            var cellvalue = "<ul style='list-style:none; '></ul>";
                            return cellvalue;
                        }
                    }
                },
                 {
                     label: '检查人员', name: 'checkman',  align: 'left', sortable: false, headerAlign: 'center',
                     formatter: function (cellvalue, options, rowObject) {
                         cellvalue = cellvalue == undefined || cellvalue == null ? "" : cellvalue;
                         var account = rowObject.checkmanid == undefined || rowObject.checkmanid == null ? "" : rowObject.checkmanid;
                         var code = rowObject.belongdept == undefined || rowObject.belongdept == null ? "" : rowObject.belongdept;
                         var innerText = "";
                         if (rqaction == "view") {
                             innerText = !!cellvalue ? cellvalue : "";
                         } else {
                             innerText = "<ul>"
                             innerText += "<li pid='" + rowObject.pkid + "'><input stid='" + rowObject.stid + "' rid='" + (rowObject.rid == undefined ? "" : rowObject.rid) + "'  oname='" + rowObject.name + "' risk='" + (rowObject.content == undefined ? "" : rowObject.content) + "' otype='" + (rowObject.checkobjcttype == undefined ? "" : rowObject.checkobjcttype) + "' style='width:100%;height:30px;' type='text' class='form-control ckuser' placeholder='请选择检查人员' value='" + cellvalue + "'  onclick=selCheckUsers('" + rowObject.stid + "',this,1) isvalid='yes' checkexpession='NotNull' uid='" + account + "' ucode='" + code + "'  class='seluser' /></li>";
                             innerText + "</ul>";
                         }
                         return innerText;
                     }
                 }

            ],
            viewrecords: true,
            onSelectRow: function () {
 
            },
            gridComplete: function () {
     
                Merger('gridTable', new Array('name'));
            }
        });
    }
    //生成guid
    function guid() {
        var s = [];
        var hex = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hex.substr(Math.floor(Math.random() * 100, 1));
        }
        //s[14] = "4";
        //s[19] = hex.substr((s[19] & 0x3) | 0x8, 1);
        //s[8] = s[13] = s[18] = s[23] = "-";
        var uid = s.join("");
        return uid;
    }
    //设置列表当前总记录数
    function setInfo() {
        var $gridTable = $("#gridTable");
        $("#gridPager").html("<b>当前共有&nbsp;" + $gridTable.find(".ckcontent").length + "&nbsp;条记录</b>");
    }
    //标记有更改过的检查内容的文本框并属性标记
    function setChange(obj) {
        $(obj).attr("ischange", "1");
    }
    //保存表单;
    function AcceptClick() {
        if (!$('#form1').Validform()) {
            return false;
        }
        var json = "";
        //主记录信息
        var postData = $("#form1").formSerialize(recid);
        postData["BelongDeptID"] = belongdeptid;
        var checkContent = 0;
        postData["IsSynView"] = $("input[name='IsSynView']:checked").val();
        //检查项目及人员安排
        var arr = new Array();
        var users = $(".ckuser");
        if (users.length > 0) {
            $(users).each(function (j, dom) {
                var pid = $(dom).parent().attr("pid") == undefined ? "-1" : $(dom).parent().attr("pid");
                var account = $(dom).attr("uid") == undefined ? "" : $(dom).attr("uid");
                var domContent = $(dom).parent().parent().parent().prev().find("li[pid='" + pid + "']").find(".ckcontent").eq(0);
                var content = "";
                if (domContent != undefined) {
                    content = domContent.val();
                }
                arr.push({
                    AutoId:j,
                    BelongDept: $(dom).attr("ucode"), //检查项目责任部门（多个逗号分隔）
                    ID: newGuid(), //主键Id
                    CheckDataId: $(dom).attr("rid") == undefined ? "" : $(dom).attr("rid"), //关联检查内容Id（来自安全检查标准）
                    CheckMan: $(dom).val(),//检查人员姓名（多个逗号分隔）
                    CheckManID: account + "," + top.currUserAccount,//检查人员账号（多个逗号分隔）
                    RiskName: $(dom).attr("risk") == undefined ? "" : $(dom).attr("risk"), //风险描述
                    CheckContent: content,//检查内容
                    CheckObject: $(dom).parent().parent().parent().prev().prev().find("span").text(), //检查对象
                    CheckObjectId: $(dom).parent().parent().parent().prev().prev().find("span").attr("id"), //检查对象Id（来自安全检查标准,可以为空）
                    CheckObjectType: $(dom).parent().parent().parent().prev().prev().find("span").attr("ctype"),//检查对象类型（检查对象类型 0为设备 1为危险源）
                    RecID: recid  //关联检查记录Id
                });
                if ($(dom).val().length == 0 || content.length == 0) {
                    checkContent = 1;
                }
            });
            json = JSON.stringify(arr);
            postData["projectItem"] = encodeURIComponent(json);
        } else {
            dialogMsg('检查工作安排不能为空！', 0);
            return false;
        }

        if (checkContent == 1) {
            dialogMsg('检查内容和检查人员不能为空！', 0);
            return false;
        }
        postData["CheckLevel"] = "0";
        postData["SJCheckLevel"] = $("#CheckLevel").ComboBoxGetValue();
        $.SaveForm({
            url: "../../SaftyCheck/SaftyCheckDataRecord/SaveFormForSuperior?keyValue=" + recid,
            param: postData,
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        });

        //if (!$('#form1').Validform()) {
        //    return false;
        //}
        //var json = "";
        //var postData = $("#form1").formSerialize(recid); 
        //postData["BelongDeptID"] = belongdeptid;
        //var checkContent = 0;        
        //postData["IsSynView"] = $("input[name='IsSynView']:checked").val();
        //postData["CheckedDepart"] = $("#CheckedDepartID").text();
        //var projectItem = $("#gridTable").jqGrid('getRowData');
        //if (projectItem.length > 0) {
        //    var arr = [];
        //    $(projectItem).each(function (i, dom) {
        //        //检查人员
        //        var domCheckMan = $("#gridTable").find(".jqgrow").eq(i).find("td[aria-describedby='gridTable_CheckMan']").eq(0).find("li");
        //        var checkCheckManValue = "";
        //        var checkCheckManText = "";
        //        if (domCheckMan.length > 0) {
        //            $(domCheckMan).each(function (m, res) {
        //                var ckName = $(res).find("input[type='text']").eq(0).val();
        //                var ckValue = $(res).find("input[type='hidden']").eq(0).val();
        //                if (ckName == "" || ckName == null || ckName == "undefined") {
        //                    checkContent = 1;
        //                }
        //                checkCheckManText = ckName;
        //                checkCheckManValue= ckValue ;
        //            });
        //        } else checkContent = 1;
        //        dom.CheckMan = checkCheckManText;
        //        dom.CheckManID = checkCheckManValue;
        //        //检查内容
        //        var domCheckContent = $("#gridTable").find(".jqgrow").eq(i).find("td[aria-describedby='gridTable_CheckContent']").eq(0).find("textarea");
        //        var checkContentValue = domCheckContent.val();
        //        //if (domCheckContent.length > 0) {
        //        //   // $(domCheckContent).each(function (m, res) {
        //        //        checkContentValue += $(res).val() + "|";
        //        //    //});
        //        //}
        //        //检查对象
        //        //var domCheckObj = $("#gridTable").find(".jqgrow").eq(i).find("td[aria-describedby='gridTable_CheckObject']").eq(0).text();
        //        var checkobjname = $("#gridTable").find(".jqgrow").eq(i).find("td[aria-describedby='gridTable_CheckObject']").eq(0).find("span").eq(0).text();
        //        var checkobjid = $("#gridTable").find(".jqgrow").eq(i).find("td[aria-describedby='gridTable_CheckObjectId']").eq(0).text();
        //        var checkobjtype = $("#gridTable").find(".jqgrow").eq(i).find("td[aria-describedby='gridTable_CheckObjectType']").eq(0).text();
        //        dom.CheckContent = checkContentValue;
        //        dom.checkobjctname = checkobjname;
        //        dom.checkobjctid = checkobjid;
        //        dom.checkobjcttype = $.trim(checkobjtype);
        //        arr.push({RecID:recid,ID: dom.ID, CheckDataId: dom.CheckDataId, CheckMan: dom.CheckMan, BelongDistrictCode: dom.BelongDistrictCode, CheckManID: dom.CheckManID, BelongDistrict: dom.BelongDistrict, BelongDistrictID: dom.BelongDistrictID, RiskName: dom.RiskName, CheckContent: dom.CheckContent, CheckObject: dom.checkobjctname, CheckObjectId: dom.checkobjctid, CheckObjectType: dom.checkobjcttype });
        //    });
        //    json = JSON.stringify(arr);
        //}
        //postData["projectItem"] = encodeURIComponent(json);
        //if (checkContent == 1) {
        //    dialogMsg('检查人员存在空！', 0);
        //    return false;
        //}

        //$.SaveForm({
        //    url: "../../SaftyCheck/SaftyCheckDataRecord/SaveFormDate?keyValue=" + recid ,
        //    param: postData,
        //    loading: "正在保存数据...",
        //    success: function () {
        //        $.currentIframe().$("#gridTable").trigger("reloadGrid");
        //    }
        //})
    }
    //选择检查表进行新增
    var dofromList1 = null;
    function addProject(obj) {
        if ($("#CheckUsers").val().length==0) {
            dialogMsg('请先选择检查成员！', 0);
            return false;
        } else {
            dofromList1 = dialogOpen({
                id: "Prject",
                title: "选择检查项目",
                url: '/SaftyCheck/SaftyCheckData/Index?isAdd=' + "Add" + "&justData=true&ctype=" + ctype,
                width: "px",
                height: "600px",
                callBack: function (iframeId) {
                    choose = "1";
                    top.document.getElementById(iframeId).contentWindow.AcceptClick();
                }
            });
        }
     
    };
    //操作显示
    function funcAction(action, rowObject) {
        if (action == "count") {
            var url = '/HiddenTroubleManage/HTBaseInfo/Index?SAFETYCHECKOBJECTID=' + rowObject;
            if (checkedRow(rowObject)) {
                dialogOpen({
                    id: 'Details',
                    title: '隐患列表',
                    url: url,
                    width: '800px',
                    height: ($(top.window).height() - 100) + "px",
                    callBack: function (iframeId) {
                        top.document.getElementById(iframeId).contentWindow.AcceptClick();
                    }
                });
            }
        } else if (action == "reg") {
            //如果没有保存检查表就不能登记隐患
            if (!!recid) {
                var url = '/HiddenTroubleManage/HTBaseInfo/Form?SAFETYCHECKOBJECTID=' + rowObject + "&SAFETYCHECKTYPE=" + recid;
                if (checkedRow(rowObject)) {
                    dialogOpen({
                        id: 'HTWindow',
                        title: '登记隐患',
                        url: url,
                        width: '900px',
                        height: ($(top.window).height() - 100) + "px",
                        btn: null,
                        callBack: function (iframeId) {
                            top.document.getElementById(iframeId).contentWindow.AcceptClick();
                        }
                    });
                }
            } else {
                dialogMsg('请选保存检查表！', 0);
            }
        }
    }
    //追加记录
    function addToDetail(obj) {
        gridCount = 1;
        var projectItem = $("#gridTable").jqGrid('getRowData');
        //清空之前选择的安全检查表数据
        $("#gridTable").clearGridData(false);
        //
        var data = eval(JSON.stringify(obj));
        $("#gridTable").jqGrid("setGridParam", {
            datatype: "local",
            data: data,
            rowNums: data.length
        }).trigger("reloadGrid");

        //var projectItem = $("#gridTable").jqGrid('getRowData');
        ////清空之前选择的安全检查表数据
        //$("#gridTable").clearGridData(false);
        ////
        //var ids = $("#gridTable").jqGrid("getDataIDs");
        //for (var i = 0; i < obj.length; i++) {
        //    var rowId = $("#gridTable").jqGrid('getRowData').length + 1;
        //    obj[i]["CheckMan"] = $("#CheckUsers").val();
        //    obj[i]["CheckManID"] = $("#CheckUserIds").val();
        //    $("#gridTable").addRowData(rowId, obj[i]);
        //}
    }
    //标记有更改过的检查内容的文本框并属性标记
    function setChange(obj) {
        $(obj).attr("ischange", "1");
    }
    function setPer() { }
    function setValue() {
        selectUser({ deptId: "", checkMode: 0, mode: 11, callBack: setPer, winObject: document.body, domId: 'CheckManageMan,CheckManageManID' });
    }
    function setPerName(CheckManageMan, CheckManageManID) {        
        selectUser({ deptId: "", checkMode: 1, mode: 11, callBack: setPer, winObject: document.body, domId: CheckManageMan + ',' + CheckManageManID, userIds: $('#' + CheckManageManID).val() });
    }
    //导出
    function ExportDetails() {
        //获取绑定的所有的记录
        var json = "";
        var projectItem = $("#gridTable").jqGrid('getRowData');
        if (projectItem.length > 0) {
            $("#show").empty();
            var table = $($(".ui-jqgrid-bdiv").html());
            var header = $(".ui-jqgrid-htable").html();
            table.find("#gridTable").css({ "background": "black" });
            table.find("#gridTable").attr("cellpadding", "0");
            table.find("#gridTable").attr("cellspacing", "0");
            table.find("#gridTable").attr("border", "1");
            table.find("#gridTable").attr("width", "100%");
            table.find("#gridTable").css({ "width": "100%" });
            table.find("#gridTable").find("td,th").css({ "background": "white" });

            table.find("tbody").before(header);

            table.find("th[id='gridTable_pkid']").remove();
            table.find("th[id='gridTable_checkobjecttype']").remove();
            table.find("th[id='gridTable_rid']").remove();
            table.find("th[id='gridTable_content']").remove();
            table.find("td[aria-describedby='gridTable_pkid']").remove();
            table.find("td[aria-describedby='gridTable_checkobjecttype']").remove();
            table.find("td[aria-describedby='gridTable_rid']").remove();
            table.find("td[aria-describedby='gridTable_content']").remove();

            table.find("tr[class ='jqgfirstrow']").remove();
            table.find("td[hidecol='true']").remove();
            table.find("td[aria-describedby='gridTable_name']").each(function (i, dom) {
                if ($(dom).attr("style").indexOf("none") >= 0) {
                    $(dom).remove();
                }
                $(dom).html($(dom).find("span").eq(0).text());
            });
            table.find("td[aria-describedby='gridTable_require']").each(function (i, dom) {
                $(dom).html($(dom).find(".ckcontent").eq(0).val());
            });
            table.find("th[role='columnheader']").find("span").remove();
            table.find("td,th").css({ "background-color": "white" });
            $("#show").html(table.html())
            json = JSON.stringify(table.html());
        }
        var data = postData = $("#form1").formSerialize(recid);
        data["CheckLevel"] = "0";
        data["SJCheckLevel"] = $("#CheckLevel").ComboBoxGetValue();
        var postData = JSON.stringify(data);
        Loading(true, "正在导出...");
        var ts = $("#CheckDataType").attr("data-text");
        $.ajax({
            url: "../../SaftyCheck/SaftyCheckDataRecord/ExportDetailsZX",
            data: { keyValue: recid, ctype: ts, projectItem: encodeURIComponent(json), entity: encodeURIComponent(postData) },
            type: "post",
            dataType: "JSON",
            async: false,
            success: function (data) {
                window.location.href = "../../Utility/DownloadFile?filePath=~/Resource/temp/" + data.resultdata + "&speed=1024000";
                Loading(false);
            }
        });
    }
    function setStatus(obj, mode) {
        if (mode == 0) {
            top.window.$("#divUsers").find(".chkUser").each(function (i, dom) {
                this.checked = obj.checked;
            });
        }
        if (mode == 1) {
            top.window.$("#divUsers").find(".chkUser").each(function (i, dom) {
                this.checked = !this.checked;
            });
        }
    }
    function setDeptValue() {
        selectDept('', 1, 11, '选择部门', window.document.body, 'CheckDept,CheckDeptID', $('#CheckDeptID').val());
    }
    function selCheckUsers(objId, obj, mode) {
        if ($("#CheckUsers").val().length == 0 || $("#CheckManageMan").val().length == 0) {
            dialogMsg('请先填写检查组长和检查成员信息！', 0);
            return false;
        }
        var html = "<div style='padding:10px;'><input type='checkbox' id='chkAll' onclick=\"top.window.frames['Details'].window.setStatus(this,0)\" /><label for='chkAll'>全选/全不选</label></div>";
        html += "<div style='padding:20px;' id='divUsers'>";
        var names = $("#CheckUsers").val().split(',');
        var accounts = $("#CheckLevelID").val().split(',');
        var codes = $("#CheckDeptCode").val().split(',');
        if ($("#CheckManageManID").val().length > 0) {
            if ($.inArray($("#CheckManageMan").val(), names) < 0) {
                names.push($("#CheckManageMan").val());
                accounts.push($("#CheckManageManID").val());
                codes.push($("#AllotDept").val());
            }
        }
        $(names).each(function (j, name) {
            html += "<div><input type='checkbox'  class='chkUser' value='unknow' id='chk" + j + "' code='-100' name='" + name + "'";
                if ($(obj).val().indexOf(name) >= 0) {
                    html += " checked='true'";
                }
            html += " /><label for='chk" + j + "'>" + name + "</label></div>";
        });
        html += "</div>";
        var dlg = dialogContent({
            id: "seluser",
            content: html,
            title: "选择检查人员",
            width: "300px",
            height: "500px",
            callBack: function (iframeId) {
                var arr = top.window.$("#divUsers").find("input:checked");
                if (arr.length == 0) {
                    dialogMsg("请选择人员！", 0);
                } else {
                    var users = "";
                    var codes = "";
                    var accounts = "";
                    $(arr).each(function (j, dom) {
                        users += $(dom).attr("name") + ",";
                        accounts += $(dom).val() + ",";
                        codes += $(dom).attr("code") + ",";
                    });
                    if (users.length > 0) {
                        users = users.substring(0, users.length - 1);
                        codes = codes.substring(0, codes.length - 1);
                        accounts = accounts.substring(0, accounts.length - 1);
                    }
                    if (mode == 0) {
                        $("input[stid='" + objId + "']").val(users);
                        $("input[stid='" + objId + "']").attr("uid", accounts);
                        $("input[stid='" + objId + "']").attr("ucode", codes);
                    } else {

                        $(obj).val(users);
                        $(obj).attr("uid", accounts);
                        $(obj).attr("ucode", codes);
                    }

                    top.layer.close(dlg);
                }
            }
        });
    }
    //function selCheckUsers(objId) {
    //    selectUser({
    //        deptId: top.currUserOrgId, checkMode: 1, mode: 11, winObject: document.body, domId: 'x', userIds: 'jcdx', callBack: function (userNames, userAccounts, deptCodes) {
    //            $("input[uname='" + objId + "']").val(userNames);
    //            $("input[uid='" + objId + "']").val(userAccounts);
    //            $("input[ucode='" + objId + "']").val(deptCodes);
    //        }
    //    });
    //}
    function addDeptCheckTable() {
        if ($("#CheckDept").val() != "" && $("#CheckDept").val() != null && $("#CheckDept").val() != undefined && !!ctype) {
            $.SetForm({
                url: "../../SaftyCheck/SaftyCheckDataRecord/AddDeptCheckTable",
                param: { DeptCode: $("#CheckDeptID").val(), Type: ctype },
                loading: "正在获取数据...",
                success: function (result) {
                    if (result.length>0) {
                        var arr = [];
                        for (var i = 0; i < result.length; i++) {
                            arr.push({
                                pkid: newGuid(),
                                count: "0",
                                content: result[i].riskname,
                                require: result[i].checkcontent,
                                rid: result[i].checkdataid,
                                name: result[i].checkobject,
                                stid: result[i].checkobjectid,
                                checkobjecttype: result[i].checkobjecttype,
                                createuserdeptcode: result[i].createuserdeptcode,
                                checkman: $("#CheckUsers").val(),
                                checkmanid: $("#CheckLevelID").val(),
                                belongdept: $("#CheckDeptCode").val()
                            });
                        }
                        choose = "2";
                        fillItems(arr);

                    } else {
                        dialogMsg('该部门无检查表!!!', 0);
                    }
                }
            })
            
        } else {
            dialogMsg('请先选择检查类型和检查部门!', 0);
        }
       
    }
    var selIds = "";
    var data = new Array();//存储选择的检查项目
    //选择检查项目,新增项目或选择检查表后动态填充表格
    function fillItems(items, ids) {
        var $gridTable = $("#gridTable");
        
        //data = $.merge(data, items);
        //if (data.length > 0) {
        //    //重新获取检查内容有修改过的数据
        //    $gridTable.find("input:text[ischange='1']").each(function (j, dom) {
        //        var idx = $(dom).attr("rowid");
        //        data[idx - 1].require = $(dom).val();
        //    });
        //}
        //为了考虑性能此处根据新增的数据行记录数做简单处理
        //小于10条则采用逐行新增的方式，其他则采用批量添加的方式
       // if (items.length < 10) {
            var len = $gridTable.find(".jqgrow").length;
            var idx = len == 0 ? 0 : $gridTable.find(".jqgrow:last").attr("id");
            $(items).each(function (j, item) {
                $gridTable.addRowData(parseInt(idx) + j + 1, item);
            });
        //}
        //else {
        //    //注意此方法会覆盖现有记录，不是追加行
        //    $gridTable[0].addJSONData(data);
        //}
        //设置当前记录总数
        setInfo();
        //获取本次操作选择的检查对象（含上级分类）
        if (ids != undefined) {
            top.Details.window.selIds = ids;
        }
        $(".unwritten").html("");
    }
    //检查工作安排
    function setWork() {
        if ($("#gridTable").find(".jqgrow").length == 0) {
            dialogMsg('请先安排检查内容!', 0);
        } else {
            dialogOpen({
                id: "Work",
                title: "检查工作安排",
                url: '/SaftyCheck/SaftyCheckDataRecord/WorkSet',
                width: "800px",
                height: ($(top.window).height() - 50) + "px",
                callBack: function (iframeId) {
                    top.document.getElementById(iframeId).contentWindow.AcceptClick();
                }
            });
        }
    }
    //选择检查项目
    function select() {
        dofromList = dialogOpen({
            id: "Items",
            title: "选择检查项目",
            url: '/RiskDatabase/HtStandard/selectitems?pType=1',
            width: (top.window.$(window).width() - 100) + "px",
            height: ($(top.window).height() - 100) + "px",
            callBack: function (iframeId) {
                choose = 1;
                top.document.getElementById(iframeId).contentWindow.AcceptClick();
            }
        });
    };
    //选择检查成员
    function selUsers(obj) {
        if ($("#CheckDeptID").val().length == 0) {
            dialogMsg('请先选择检查部门!', 0);
        } else {
            selectUser({
                deptId: $("#DeptId").val(), checkMode: 1, mode: 11, callBack: function () {
                    $("#CheckUserIds").val($("#CheckLevelID").val());
                }, winObject: document.body, domId: 'CheckUsers,CheckLevelID,,,CheckDeptCode', userIds: $('#CheckLevelID').val()
            });
        }
    }
    //清空所有记录
    function removeItem() {
        var dlg = dialogConfirm("确定清空吗？", function (isSure) {
            if (isSure) {
                data = new Array();
                selIds = "";
                $("#gridTable").clearGridData();
                top.layer.close(dlg);
            }
        });
    }
</script>
<div style="margin: 10px;">
    <div class="panel panel-default">
        <div class="panel-heading">
            <strong id="showTitle"></strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form">
                <tr>
                    <td class="formTitle">检查名称<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <input id="CheckDataRecordName" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">检查开始时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="CheckBeginTime" type="text" class="form-control input-wdatepicker" onfocus="WdatePicker()" isvalid="yes" checkexpession="NotNull" />
                    </td>
                    <td class="formTitle">检查结束时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="CheckEndTime" type="text" class="form-control input-wdatepicker" onfocus="WdatePicker()" isvalid="yes" checkexpession="NotNull" />
                    </td>

                </tr>
                <tr>
                    <td class="formTitle">检查类型<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="CheckDataType" type="select" class="ui-select" isvalid="yes" onchange="chgCheckDateType(this)" checkexpession="NotNull"></div>
                    </td>
                    <td class="formTitle">检查级别<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="CheckLevel" type="select" class="ui-select" isvalid="yes" checkexpession="NotNull" ></div>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">被检查单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="CheckedDepart" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().OrganizeName" readonly="readonly" />
                        <input type="hidden" id="CheckedDepartID" name="CheckedDepart" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().OrganizeId" />
                    </td>
                    <td class="formTitle" style="display:none;">被检查单位同步可见<font face="宋体">*</font></td>
                    <td class="formValue" style="display:none;">
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="IsSynView" id="IsSynView1" value="1" checked="checked" />是
                            </label>
                        </div>
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="IsSynView" id="IsSynView2" value="0" />否
                            </label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">检查部门<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="CheckDept" type="text" class="form-control" placeholder="请填写部门" isvalid="yes"  checkexpession="NotNull" />
                        <input id="CheckDeptID" type="hidden" /><input id="DeptId" type="hidden" />
                    </td>
                    <td class="formTitle">检查组长<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="CheckManageMan" type="text" class="form-control" placeholder="请填写检查组长"  isvalid="yes" checkexpession="NotNull" />
                        <input id="CheckManageManID" type="hidden" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">检查组成员<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <input id="CheckUsers" type="text" class="form-control" placeholder="请填写检查成员,多个请用英文逗号分隔"  isvalid="yes" checkexpession="NotNull" />
                        <input id="CheckUserIds" type="hidden" /><input id="CheckLevelID" type="hidden" /><input id="CheckDeptCode" type="hidden" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">检查区域</td>
                    <td class="formValue" colspan="3">
                        <div class="input-group" style="width:100%;">
                            <input id="AreaName" type="text" class="form-control" placeholder="输入或选择区域" isvalid="yes" checkexpession="LenStrOrNull" length="1000" maxlength="1000" />
                            <span id="ChooseRiskDesc" class="input-group-addon" onclick="selectArea(window.document.body, 'AreaName',2);" title="选择区域"><i class="fa fa-check"></i></span>
                        </div>
                    </td>
                </tr>
                <tr class="hidecontent">
                    <td class="formTitle">检查目的</td>
                    <td class="formValue" colspan="3">
                        <input id="Aim" type="text" class="form-control" isvalid="yes" checkexpession="LenStrOrNull" length="1000" maxlength="1000" />
                    </td>

                </tr>
               
                <tr class="hidecontent">
                    <td class="formTitle">检查内容</td>
                    <td class="formValue" colspan="3">
                        <textarea id="Remark" class="form-control readonly1" style="height:40px;" rows="3" isvalid="yes" checkexpession="LenStrOrNull" length="1000" maxlength="1000"></textarea>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;检查成员及分工</strong>
            <span class="tools pull-right">
                @*<a href="javascript:setWork()" class="btn btn-primary btn-xs btn10">检查工作安排</a>&nbsp;&nbsp;&nbsp;&nbsp;*@
                <a href="javascript:select()" class="btn btn-primary btn-xs btn10">选择检查项目</a>&nbsp;&nbsp;&nbsp;&nbsp;
                @*<a href="javascript:addDeptCheckTable(this)" id="ChooseDept" class="btn btn-primary btn-xs btn10">选择部门检查表</a>&nbsp;&nbsp;&nbsp;&nbsp;*@
                <a href="javascript:addProject(this)" id="Choose" class="btn btn-primary btn-xs btn10">选择检查表</a>&nbsp;&nbsp;&nbsp;&nbsp;
                <a href="javascript:addItems()" id="choose1" class="btn btn-primary btn-xs btn10">新增项目</a>&nbsp;&nbsp;&nbsp;&nbsp; 
                <a href="javascript:removeItem(this)" id="remove" class="btn btn-primary btn-xs btn10">清空已选项目</a>&nbsp;&nbsp;&nbsp;&nbsp;
                <a href="javascript:ExportDetails(this)" id="Export" class="btn btn-primary btn-xs">导&nbsp;&nbsp;出</a>&nbsp;&nbsp;
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table id="gridTable"></table>
            <div id="gridPager"></div>
        </div>
    </div>
    <div id="show" style="display:none;"></div>
</div>
