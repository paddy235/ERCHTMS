@{
    ViewBag.Title = "用户管理";
    Layout = "~/Views/Shared/_Form.cshtml";
    ERCHTMS.Busines.SystemManage.DataItemDetailBLL di = new ERCHTMS.Busines.SystemManage.DataItemDetailBLL();
    var user = ERCHTMS.Code.OperatorProvider.Provider.Current();
}
<script src="~/Content/scripts/business/Common.js" type="text/javascript"></script>
<link href="~/content/scripts/plugins/icheck/skins/square/_all.css" type="text/css" rel="stylesheet" />
<script src="~/content/scripts/plugins/icheck/js/icheck.min.js" type="text/javascript"></script>
<script src="~/content/scripts/plugins/icheck/js/custom.min.js" type="text/javascript"></script>

<script src="~/Content/scripts/plugins/jquery.md5.js"></script>
<script src="~/Content/scripts/plugins/uploadify/ajaxfileupload.js"></script>


<!--webUploader文件上传组件-->
<link href="~/content/scripts/plugins/webuploader/webuploader.css" rel="stylesheet" />
<link href="~/content/scripts/plugins/webuploader/webuploader-demo.css" rel="stylesheet" />
<script type="text/javascript" src="~/content/scripts/plugins/webuploader/webuploader.min.js"></script>
<script type="text/javascript" src="~/content/scripts/business/fileupload.js"></script>
<script src="~/Content/scripts/plugins/combo-select/jquery.combo.select.js"></script>
<link rel="stylesheet" href="~/Content/scripts/plugins/combo-select/combo.select.css">

<link rel="stylesheet" href="~/content/scripts/plugins/bootstrap-select/bootstrap-select.min.css" type="text/css" />
<script type="text/javascript" src="~/content/scripts/plugins/bootstrap-select/bootstrap-select.min.js"></script>
<link rel="stylesheet" type="text/css" href="~/content/scripts/plugins/city-picker/css/city-picker.css">

<style type="text/css">
    .file {
        position: relative;
        display: inline-block;
        overflow: hidden;
        text-decoration: none;
        text-indent: 0;
        cursor: pointer !important;
    }

        .file input {
            position: absolute;
            font-size: 100px;
            right: 0;
            top: 0;
            opacity: 0;
            cursor: pointer !important;
        }

        .file:hover {
            text-decoration: none;
            cursor: pointer !important;
        }

    #gridPerformance tr th {
        vertical-align: central !important;
    }
</style>
<script>
    var keyValue = request('keyValue');
    var rqaction = request('action');
    var hasAppint = request('hasAppint');
    var trainserviceurl = "@(di.GetItemValue("TrainServiceUrl"))";
    var isHDJL= "@(di.GetItemValue("JLIndex", "JLIndex"))";
    var instanceId = "";
    var formId = "";
    var isClick = true;
    var softName = "@BSFramework.Util.Config.GetValue("SoftName").ToLower()";
    $(function () {
        $.ajaxSetup({ async: false });
        $('#Craft').comboSelect();
        getTrainRole();
        initControl();
        GetGrid();
        buttonOperation();
        if (softName == 'gdhjb' && hasAppint == '0') {
            jQuery("#menjin").hide();
        }
    });
    function getCerts(userId) {
        var $gridTable = $('#gridTableCert');
        $gridTable.jqGrid({
            rowNum: 1000,
            sortname: 'senddate',
            sortorder: 'desc',
            autowidth: true,
            height: $(window).height() - 200,
            url: "../Certificate/GetListJson?userId=" + userId,
            datatype: "json",
            colModel: [
                { label: 'ID', name: 'Id', hidden: true },
                {
                    label: '操作', name: 'Oper', width: 100, align: 'center', sortable: false, formatter: function (cellvalue, options, rowObject) {
                        var html = "<a href=\"javascript:showCert('" + rowObject.Id + "')\" title=\"查看\"><i class=\"fa fa-eye\"></i></a>";
                        if (rqaction != "show") {
                            html += "<a href=\"javascript:edit('" + rowObject.Id + "')\" title=\"修改\"><i class=\"fa fa-pencil-square-o\"></i></a>";
                            html += "<a href=\"javascript:del('" + rowObject.Id + "')\" title=\"删除\"><i class=\"fa fa-trash-o\"></i></a>";
                        }
                        return html;
                    }
                },
                { label: '证件类型', name: 'CertType', index: 'CertType', width: 100, align: 'center', sortable: true },
                { label: '证书编号', name: 'CertNum', index: 'CertNum', width: 100, align: 'center', sortable: true },
                {
                    label: '证书名称', name: 'CertName', width: 160, align: 'center', sortable: false
                    //,formatter: function (value, options, rowObject) {
                    //    if (rowObject.CertType == "特种作业操作证" || rowObject.CertType == "特种设备作业人员证") {
                    //        return rowObject.WorkItem == null ? "" : rowObject.WorkItem;
                    //    } else {
                    //        return rowObject.CertName == null ? "" : rowObject.CertName;
                    //    }
                    //}
                },
                {
                    label: '初领/发证日期',
                    name: 'SendDate',
                    index: 'SendDate',
                    width: 80,
                    align: 'center',
                    sortable: true,
                    formatter: function (value, options, rowObject) {

                        return formatDate(value, 'yyyy-MM-dd');
                    }
                },
                {
                    label: '有效期限',
                    name: 'EndDate',
                    width: 80,
                    align: 'center',
                    sortable: true,
                    formatter: function (value, options, rowObject) {

                        return formatDate(value, 'yyyy-MM-dd');
                    }
                },
                { label: '发证机关', name: 'SendOrgan', index: 'SendOrgan', width: 150, align: 'center', sortable: true },
                { label: '有效期(年)/复审周期(年)', name: 'Years', index: 'Years', align: 'center', sortable: true }
            ],
            gridComplete: function () {
                $('#gridTableCert').setGridWidth(($('.tab-content').width() - 10));
            }


        });
    }

    //获取培训记录
    function getTrain(userId) {
        var way="@(di.GetItemValue("WhatWay"))"
        if (isClick) {
            var uid = userId == undefined ? keyValue : userId;
            var $gridTable = $('#gridTrain');
            $gridTable.jqGrid({
                rowNum: 1000,
                autowidth: true,
                height: $(window).height() - 200,
                url: "../Person/GetTrainRecord?userId=" + uid,
                datatype: "json",
                colModel: [
                    { label: '培训项目', name: way == '1' ? 'project_name' : "TRAINPRJNAME", width: 200, align: 'center' },
                    { label: '培训类型', name: way == '1' ? 'train_type' : "PROJTYPE", width: 100, align: 'center' },
                    {
                        label: '培训开始时间',
                        name: way == '1' ? 'project_start_time' :'TRAINSTARDATE',
                        width: 100,
                        align: 'center',
                        sortable: true,
                        formatter: function(value, options, rowObject) {

                            return formatDate(value, 'yyyy-MM-dd');
                        }
                    },
                    {
                        label: '培训结束时间',
                        name: way == '1' ? 'project_end_time' : 'TRAINENDDATE',
                        width: 100,
                        align: 'center',
                        sortable: true,
                        formatter: function(value, options, rowObject) {
                            if (value.indexOf("0001") >= 0) {
                                return "";
                            } else {
                                return formatDate(value, 'yyyy-MM-dd');
                            }

                        }
                    },
                    {
                        label: '培训学时(min)',
                        name: way == '1' ? 'total_studytime' : 'PAGETIME',
                        width: 100,
                        align: 'center',
                        sortable: true,
                        formatter: function (value, options, rowObject) {
                            if (way == "1") {
                                return value
                            }
                            else {
                                return (value / 60).toFixed(2);
                            }
                        }
                    },
                    {
                        label: '是否考试', name: way == '1' ? 'exam_status' : 'ISEXAM', width: 80, align: 'center',
                        formatter: function (value, options, rowObject) {
                            if (way == "1") {
                                if (value == "1") {
                                    return "否";
                                }
                                else {
                                    return "是";
                                }
                            }
                            else {
                                return value;
                            }
                        }
                    },
                    { label: '考试合格线', name: way == '1' ? 'pass_score' : 'LINE', width: 80, align: 'center' },
                    {
                        label: '考试成绩', name: way == '1' ? 'exam_score' : 'exam_score', width: 100, align: 'center',
                        formatter: function (value, options, rowObject) {
                            if (way == "1") {
                                if (rowObject.exam_status == "1") {
                                    return "";
                                }
                                else {
                                    return value;
                                }
                            }
                            else {
                                return value;
                            }
                        }
                    }
                ],
                gridComplete: function() {
                    $gridTable.setGridWidth(($('.tab-content').width() - 10));
                    isClick = false;
                }
            });
        }
    }


    //获取门禁进出记录
    function getEnterRecord() {
        var $gridTable = $('#gridMJ');
        if (softName == 'gdhjb') {
            $gridTable.jqGrid({
                rowNum: 1000000000,
                autowidth: true,
                height: $(window).height() - 200,
                url: "../Person/GetAttendance?userId=" + keyValue,
                datatype: "json",
                colModel: [
                    { label: '门禁通道名称', name: 'DeviceName', width: 300, align: 'center', sortable: false },
                    {
                        label: '进出时间',
                        name: 'CreateDate',
                        width: 250,
                        align: 'center',
                        sortable: false
                    },
                    {
                        label: '状态', name: 'InOut', width: 100, align: 'center', sortable: false, formatter: function (value, options, rowObject) {
                            if (value == 0) {
                                return "进门";
                            } else if (value == 1) {
                                return "出门";
                            } else {
                                return "";
                            }

                        }
                    }
                ],
                rownumbers: true,
                gridComplete: function () {
                    $gridTable.setGridWidth(($('.tab-content').width() - 10));
                }
            });
        }
        else {
            $gridTable.jqGrid({
                rowNum: 1000000000,
                autowidth: true,
                height: $(window).height() - 200,
                url: "../Person/GetEnterRecord?idCard=" + $("#IdentifyID").attr("idcard"),
                datatype: "json",
                colModel: [
                    { label: '门禁进出通道名称', name: 'entryWay', width: 300, align: 'center', sortable: false },
                    {
                        label: '进出时间',
                        name: 'time',
                        width: 250,
                        align: 'center',
                        sortable: false
                    },
                    {
                        label: '逗留时间(小时)',
                        name: 'hours',
                        width: 100,
                        align: 'center',
                        sortable: true
                    },
                    {
                        label: '状态', name: 'status', width: 100, align: 'center', sortable: false ,formatter: function (value, options, rowObject) {
                            if (value==1) {
                                return "在厂";
                            } else if (value==2) {
                                return "离厂";
                            } else {
                                return "";
                            }

                        }
                    }
                ],
                gridComplete: function () {
                    $gridTable.setGridWidth(($('.tab-content').width() - 10));

                }
            });
        }
    }
    //获取工作记录
    function getWorks(userId) {
        var $gridTable = $('#gridWork');
        $gridTable.jqGrid({
            rowNum: 1000,
            autowidth: true,
            height: $(window).height() - 200,
            url: "../Person/GetPageWorkListJson?userId=" + userId,
            datatype: "json",
            colModel: [
                { label: 'ID', name: 'Id', hidden: true },
                //{
                //    label: '操作', name: 'Oper', width: 160, align: 'center', sortable: false,
                //    formatter: function (cellvalue, options, rowObject) {
                //        var html = "";
                //        html += "<a href=\"javascript:workedit('" + rowObject.Id + "')\" title=\"修改\"><i class=\"fa fa-pencil-square-o\"></i></a>";
                //        html += "<a href=\"javascript:workdel('" + rowObject.Id + "')\" title=\"删除\"><i class=\"fa fa-trash-o\"></i></a>";
                //        return html;
                //    }
                //},
                {
                    label: '工作时间',
                    name: 'EnterDate',
                    width: 300,
                    align: 'center',
                    sortable: true,
                    formatter: function(value, options, rowObject) {
                        var statime = "";
                        if (value.indexOf("0001") >= 0) {
                            statime = "";
                        } else {
                            statime = formatDate(value, 'yyyy-MM-dd');
                        }
                        var endtime = "";
                        if (rowObject.LeaveTime.indexOf("0001") >= 0) {
                            endtime = "至今";
                        } else {
                            endtime = formatDate(rowObject.LeaveTime, 'yyyy-MM-dd');
                        }

                        return statime + "~" + endtime;
                    }
                },
                { label: '公司', name: 'OrganizeName', width: 200, align: 'center', sortable: true },
                { label: '部门', name: 'DeptName', width: 200, align: 'center', sortable: true },
                { label: '岗位', name: 'PostName', width: 200, align: 'center', sortable: true },
                { label: '职务', name: 'JobName', width: 200, align: 'center', sortable: true }
            ],
            rownumbers: true,
            gridComplete: function() {
                $('#gridWork').setGridWidth(($('.tab-content').width() - 10));
            }
        });
    }

    //职业健康信息
    function getHealth(userId) {
        var $gridTable = $('#gridTableHealth');
        $gridTable.jqGrid({
            autowidth: true,
            height: $(window).height() - 300,
            url: "../../OccupationalHealthManage/Occupationalstaffdetail/NewGetUserList?UserId=" + userId,
            datatype: "json",
            colModel: [
                {
                    label: '体检时间',
                    name: 'inspectiontime',
                    width: 220,
                    align: 'center',
                    sortable: true,
                    formatter: function(cellvalue, options, rowObject) {

                        return formatDate(cellvalue, 'yyyy-MM-dd');
                    }
                },
                {
                    label: '体检机构名称',
                    name: 'mechanismname',
                    index: 'MECHANISMNAME',
                    width: 300,
                    align: 'center',
                    sortable: false
                },
                {
                    label: '是否有附件',
                    name: 'isannex',
                    index: 'isannex',
                    width: 200,
                    align: 'center',
                    sortable: false,
                    formatter: function(cellvalue, options, rowObject) {

                        if (rowObject.filenum == 0) {
                            html = "否";
                            return html;

                        } else if (rowObject.filenum > 0) {
                            html = "<a href=javascript:btn_Annex('" +
                                rowObject.occid +
                                "') style='color:blue; text-decoration:underline;padding-left:0px;' title='修改'>是</a>";
                            return html;

                        }


                    }

                },
                { label: '所患职业病', name: 'itemname', width: 400, align: 'center', sortable: true },
                { label: '异常描述', name: 'unusualnote', width: 400, align: 'center', sortable: true }
            ],
            gridComplete: function() {
                $('#gridTableHealth').setGridWidth(($('.tab-content').width() - 10));
            }

        });
    }

    //职业危害接触信息
    function getHazard(userId) {
        var $gridTable = $('#gridTableHazard');
        $gridTable.jqGrid({
            autowidth: true,
            height: 100,
            url: "../../OccupationalHealthManage/Occupationalstaffdetail/GetUserHazardfactor?UserId=" + userId,
            datatype: "json",
            colModel: [
                {
                    label: '序号',
                    name: 'no',
                    width: 220,
                    align: 'center',
                    sortable: true,
                    formatter: function(cellvalue, options, rowObject) {
                        return options.rowId;
                    }
                },
                { label: '接触职业危害因素', name: 'us', index: 'us', width: 300, align: 'center', sortable: false },
            ],
            gridComplete: function() {
                $('#gridTableHealth').setGridWidth(($('.tab-content').width() - 10));
            }

        });
    }


    //查看
    function btn_Annex(occid) {
        var keyValue = occid;
        if (checkedRow(keyValue)) {
            var dlg = dialogOpen({
                id: 'Annex',
                title: '附件列表',
                url: '/OccupationalHealthManage/Occupatioalstaff/FileList?keyValue=' + keyValue,
                width: '600px',
                height: '550px',
                btn: ["关闭"],
                callBack: function(iframeId) {
                    top.layer.close(dlg);
                }
            })
        }
    }
    function showExamInfo(id, qtype) {
        var title = "查看考核信息";
        var frmid = "ExaminIndex";
        var url = '/LllegalManage/LllegalRegister/ExaminIndex?keyValue=' + id;
        if (qtype == 1)
        {
            frmid = "AwardIndex";
            title = "违章奖励信息";
            url = '/LllegalManage/LllegalRegister/AwardIndex?keyValue=' + id;
        }
        var dlg = dialogOpen({
            id: frmid,
            title: title,
            url: url,
            width: ($(window).width() - 200) + 'px',
            height: ($(window).height() - 50) + 'px',
            btn: ["关闭"],
            callBack: function (iframeId) {
                top.layer.close(dlg);
            }
        })
    }
    //违章信息
    function getWZ(userId) {
        var $gridTable = $('#gridTableWZ');
        var queryJson = {
            mode: 0,
            userId: userId
        };
        $gridTable.jqGrid({
            autowidth: true,
            height: $(window).height() - 200,
            postData: { queryJson: JSON.stringify(queryJson) },
            url: "../../PersonManage/Person/GetWZListJson",
            datatype: "json",
            colModel: [
                 {
                     label: 'ID',
                     name: 'id',
                     hidden: true
                },
                {
                    label: '信息类型',
                    name: 'actiontype',
                    width: 80,
                    align: 'center',
                    sortable: true
                },
                {
                    label: '违章类型',
                    name: 'lllegaltypename',
                    width: 80,
                    align: 'center',
                    sortable: true
                },
                {
                    label: '违章级别',
                    name: 'lllegallevelname',
                    width: 80,
                    align: 'center',
                    sortable: true
                },
                {
                    label: '违章时间',
                    name: 'lllegaltime',
                    width: 100,
                    align: 'center',
                    sortable: true,
                    formatter: function(cellvalue, options, rowObject) {

                        return formatDate(cellvalue, 'yyyy-MM-dd');
                    }
                },
                {
                    label: '违章描述',
                    name: 'lllegaldescribe',
                    width: 150,
                    align: 'center',
                    sortable: true
                },
                { label: '整改措施', name: 'reformrequire', width: 100, align: 'center', sortable: true },
                { label: '整改情况描述', name: 'reformmeasure', width: 100, align: 'center', sortable: true },
                { label: '违章单位', name: 'lllegalteam', width: 100, align: 'center', sortable: true },
                {
                    label: '考核情况', width: 80, align: 'center', sortable: true, formatter: function (value, options, rowObject) {
                        if (rowObject.khnum > 0) {
                            return "<a style='color:blue; text-decoration:underline;cursor:pointer;' onclick=\"showExamInfo('" + rowObject.id + "',0)\">查看考核详情</a>";
                        }
                        else
                        {
                            return "无";
                        }
                    }
                },
                {
                    label: '奖励情况', width: 80, align: 'center', sortable: true, formatter: function (value, options, rowObject) {
                        if (rowObject.jlnum > 0) {
                            return "<a style='color:blue; text-decoration:underline;cursor:pointer;' onclick=\"showExamInfo('" + rowObject.id + "',1)\">查看奖励详情</a>";
                        }
                        else {
                            return "无";
                        }
                    }
                },
                {
                    label: '详情',
                    name: 'filepath',
                    width: 70,
                    align: 'center',
                    sortable: true,
                    formatter: function(value, options, rowObject) {

                        var html = "<a href=javascript:viewdata('" +
                            rowObject.id +
                            "','" +
                            rowObject.addtype +
                            "','" +
                            rowObject.flowstate +
                            "')  title='查看' style='color:blue; text-decoration:underline' >查看详情</a>";
                        return html;
                    }
                }
            ],
            viewrecords: true,
            rowNum: 15,
            rowList: [15, 30, 50, 100],
            pager: "#gridPagerWZ",
            sortname: 'lllegaltime desc, createdate',
            sortorder: 'desc',
            rownumbers: true,
            shrinkToFit: true,
            gridview: true,
            onSelectRow: function () {
                selectedRowIndex = $("#" + this.id).getGridParam('selrow');
            },
            gridComplete: function() {
                $('#gridTableWZ').setGridWidth(($('.tab-content').width() - 10));
            }
        });
    }

    //违章登记信息
    //function getGRWZ(userId) {
    //    var $gridTable = $('#gridTableWZ1');
    //    $gridTable.jqGrid({
    //        autowidth: true,
    //        height: $(window).height() - 200,
    //        url: "../../PersonManage/Person/GetWZListJson?mode=0&userId=" + userId,
    //        datatype: "json",
    //        shrinkToFit: true,
    //        rownumbers: true,
    //        colModel: [
    //            {
    //                label: 'ID',
    //                name: 'id',
    //                hidden:true
    //            },
    //            {
    //                label: '信息类型',
    //                name: 'actiontype',
    //                width: 80,
    //                align: 'center',
    //                sortable: true
    //            },
    //            {
    //                label: '违章类型',
    //                name: 'lllegaltypename',
    //                width: 80,
    //                align: 'center',
    //                sortable: true
    //            },
    //            {
    //                label: '违章级别',
    //                name: 'lllegallevelname',
    //                width: 80,
    //                align: 'center',
    //                sortable: true
    //            },
    //          {
    //              label: '违章时间',
    //              name: 'lllegaltime',
    //              width: 100,
    //              align: 'center',
    //              sortable: true,
    //              formatter: function (cellvalue, options, rowObject) {
    //                  return formatDate(cellvalue, 'yyyy-MM-dd');
    //              }
    //          },
    //            {
    //                label: '违章描述',
    //                name: 'lllegaldescribe',
    //                width: 150,
    //                align: 'center',
    //                sortable: true
    //            },
    //            { label: '整改措施', name: 'reformrequire', width: 100, align: 'center', sortable: true },
    //            { label: '整改情况描述', name: 'reformmeasure', width: 100, align: 'center', sortable: true },
    //            { label: '违章单位', name: 'lllegalteam', width: 100, align: 'center', sortable: true },
    //            {
    //                label: '考核情况', width: 80, align: 'center', sortable: true, formatter: function (value, options, rowObject) {
    //                    return "<a style='color:blue; text-decoration:underline;cursor:pointer;' onclick=\"showExamInfo('" + rowObject.id + "')\">查看考核详情</a>";
    //                }
    //            },
    //              {
    //                  label: '登记时间',
    //                  name: 'createdate',
    //                  width: 100,
    //                  align: 'center',
    //                  sortable: true,
    //                  formatter: function (cellvalue, options, rowObject) {
    //                      return formatDate(cellvalue, 'yyyy-MM-dd hh:mm');
    //                  }
    //              },

    //            {
    //                label: '详情',
    //                name: 'filepath',
    //                width:70,
    //                align: 'center',
    //                sortable: true,
    //                formatter: function (value, options, rowObject) {

    //                    var html = "<a href=javascript:viewdata('" +
    //                        rowObject.id +
    //                        "','" +
    //                        rowObject.addtype +
    //                        "','" +
    //                        rowObject.flowstate +
    //                        "')  title='查看' style='color:blue; text-decoration:underline' >查看详情</a>";
    //                    return html;
    //                }
    //            }
    //        ],
    //        gridComplete: function () {
    //            $('#gridTableWZ1').setGridWidth(($('.tab-content').width() - 10));
    //        }

    //    });
    //}
    //查看视图
    function viewdata(obj, atype, flowstate) {
        var rqUrl = "";
        var title = "";

        //未整改隐患的查看页面
        if (flowstate == "违章登记" || flowstate == "违章举报") {
            title = "查看违章";
            rqUrl = '/LllegalManage/LllegalRegister/Form?keyValue=' + obj + '&actiontype=view';
        } else if (flowstate == "违章核准" || flowstate == "违章审核") {
            title = "查看违章";
            rqUrl = '/LllegalManage/LllegalApprove/Form?keyValue=' + obj + '&actiontype=view';
        } else if (flowstate == "违章整改") {
            title = "查看违章";
            rqUrl = '/LllegalManage/LllegalReform/Form?keyValue=' + obj + '&actiontype=view';
        } else if (flowstate == "违章验收") {
            title = "查看违章";
            rqUrl = '/LllegalManage/LllegalAccept/Form?keyValue=' + obj + '&actiontype=view';
        } else {
            if (atype == "0") {
                title = "查看违章";
                rqUrl = '/LllegalManage/LllegalAccept/Form?keyValue=' + obj + '&actiontype=view';
            } else //已整改的查看页面
            {
                title = "已整改违章查看";
                rqUrl = '/LllegalManage/LllegalRegister/NewForm?keyValue=' + obj + '&actiontype=view';
            }
        }

        dialogOpen({
            id: 'LllegalForm',
            title: title,
            url: rqUrl,
            width: ($(top.window).width() - 100) + "px",
            height: ($(top.window).height() - 100) + "px",
            btn: null
        });
    }

    function IntiDuty(organizeId, isOrg) {
        organizeId=organizeId == undefined || organizeId == "undefined" ? "" : organizeId;
        isOrg=isOrg== undefined || isOrg == "undefined" ? "" : isOrg;
        //通用change方法
        $("#DutyId").ComboBox({
            url: top.contentPath + "/BaseManage/Post/GetListJson?organizeId=" + organizeId + "&isOrg=" + isOrg,
            id: "RoleId",
            text: "FullName",
            description: "==请选择==",
            allowSearch: true,
            height:"200px"
        }).bind("change",
            function() {
                $.ajax({
                    url: '../../BaseManage/Post/GetRoleById',
                    data: { id: $(this).attr('data-value') },
                    dataType: "JSON",
                    success: function (result) {
                        if (!!result.RoleNames) {
                            if ($("#DepartmentId").attr('data-isorg') == "1") {
                                $.ajax({
                                    url: '../../BaseManage/Post/GetListByCode',
                                    data: { code: "100103" },
                                    dataType: "JSON",
                                    success: function(vr) {
                                        $("#RoleName").val(vr.FullName + "," + result.RoleNames);
                                        $("#RoleId").val(vr.RoleId + "," + result.RoleIds);
                                    }
                                });

                            } else {
                                $("#RoleName").val(result.RoleNames);
                                $("#RoleId").val(result.RoleIds);
                                if (result.RoleNames.indexOf("专工")>=0) {
                                    $("#zy").show();
                                } else {
                                   // $("#zy").hide();
                                }
                            }
                        }
                    }
                });
            });
        //
    }

    //绑定职务方法
    function IntiPost(organizeId) {
        //通用change方法
        //$("#PostId").ComboBox({
        //    url: top.contentPath + "/BaseManage/Job/NewGetListJson?organizeId=" + organizeId + "&isOrg=" + isOrg,
        //    id: "RoleId",
        //    text: "FullName",
        //    description: "==请选择==",
        //    allowSearch: true
        //});
        //debugger;
        $.ajax({
            url: top.contentPath + "/BaseManage/Job/NewGetListJson?organizeId=" + organizeId,
            type: "GET",
            async: false,
            dataType: "text",
            success: function(data) {
                $("#PostId").html("");
                $("#PostId").append(data);
                $("#PostId").selectpicker('refresh');
                //$("#PostId").html(data);
            }
        });
    }

    function ClearValue() {
        //清空岗位
        $("#DutyId").attr('data-value', '').attr('data-text', '');
        $("#DutyId").find("div").html("==请选择==");
        ////清空职务
        //$("#PostId").attr('data-value', '').attr('data-text', '');
        //$("#PostId").val("");

        //清空角色
        $("#RoleName").val("");
        $("#RoleId").val("");
    }

    //人员上传图片
    function InitUpload() {
        $('#uploadFile').change(function() {
            Upload($(this));
        });
        $('#signFile').change(function() {
            UploadSign($(this));
        });
    }

    //上传签名图片
    function UploadSign(self) {
        var file = self.get(0).files[0];
        if (file.type.indexOf("image") >= 0) {
            var size = file.size;
            var file_id = self.attr("id");
            var img_id = self.attr("img_id");
            //上传应用图标
            $.ajaxFileUpload({
                url: top.contentPath + "/PersonCenter/UploadFile?mode=1",
                secureuri: false,
                fileElementId: file_id,
                dataType: 'json',
                success: function(data) {

                    document.getElementById('signPreview').src = top.contentPath + data.resultdata;
                    $("#SignImg").val(data.resultdata);
                    dialogMsg(data.message, 1);
                    if (window.location.href.indexOf("mode=0") >= 0) {
                        top.layer.close(top.AppForm.window.dlg);
                        top.AppForm.window.reload();
                    }
                },
                complete: function() {

                    $("#signFile").change(function() {
                        UploadSign($(this), file_id, img_id);
                    })
                }
            });
        } else {
            dialogMsg("仅支持上传图片！", 2);
        }
    }

    //人员上传图片
    function Upload(self) {
        var file = self.get(0).files[0];
        if (file.type.indexOf("image") >= 0) {
            var size = file.size;
            var file_id = self.attr("id");
            var img_id = self.attr("img_id");
            //上传应用图标
            $.ajaxFileUpload({
                url: "UploadPhoto",
                secureuri: false,
                fileElementId: file_id,
                dataType: 'json',
                success: function(data) {
                    document.getElementById('uploadPreview').src = top.contentPath + data.resultdata;
                    $("#HeadIcon").val(data.resultdata);
                    dialogMsg(data.message, 1);
                },
                complete: function() {
                    $("#uploadFile").change(function() {
                        Upload($(this), file_id, img_id);
                    })
                }
            });
        } else {
            dialogMsg("仅支持上传图片！", 2);
        }
    }

    //初始化控件
    function initControl() {
        //if (isHDJL.length > 0) {
        //    $(".djwz").show();
        //} else {
        //    $(".djwz").remove();
        //}

        if (softName == "xss" || softName == "gdhjb") {

        } else {
            $("#menjin").remove();
        }
        if (top.currUserRoleName.indexOf("省级") >= 0 || top.currUserRoleName.indexOf("集团") >= 0) {
            $("#isTZ").hide();
            $("#isOut").hide();
            $(".wz").hide();
            $(".health").hide();
            $("#idFour").hide();
        }

        if (keyValue.length == 0) {
            $(".nav-tabs").hide();
        }
        InitUpload();

        if (!!rqaction) {
            $("#btn_finish").remove();
            $("input").attr("readonly", "readonly");
            $("textarea").attr("readonly", "readonly");
            $("#certificate").find(".toolbar").remove();
            $("#work").find(".toolbar").remove();
            $('.icheck').find("input:radio").iCheck('disable');
            $("#divTips").hide();
        }

        //籍贯
        $("#Native").ComboBox({
            url: "../../SystemManage/Area/GetListJson",
            param: { EnCode: "Native" },
            id: "AreaName",
            text: "AreaName",
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        });
        //人员类型
        $("#UserType").ComboBox({
            //url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            //param: { EnCode: "UserType" },
            //id: "ItemValue",
            //text: "ItemName",
            description: "==请选择==",
            height: "200px"
        }).bind("change",
            function () {
                var value = $(this).attr("data-value");
                if (value == "监理人员") {
                    $('.tzzy').find("input:radio").eq(0).removeAttr("checked");
                    $('.tzzy').find("input:radio").eq(1).iCheck("check");
                    $('.tzzy').find("input:radio").iCheck('disable');
                } else {
                    $('.tzzy').find("input:radio").iCheck('enable');
                }
         });
        //民族
        $("#Nation").ComboBox({
            url: "../../SystemManage/DataItemDetail/GetDataItemListSortJson",
            param: { EnCode: "Nation" },
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        });
        //学历
        $("#DegreesID").ComboBox({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "Degrees" },
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        });
        //技术等级
        $("#TechnicalGrade").ComboBox({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "TechnicalGrade" },
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        });
        //职称
        $("#JobTitle").ComboBox({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "JobTitle" },
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        });

        $("#LateDegreesID").ComboBox({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "Degrees" },
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        });
        //政治面貌
        $("#Political").ComboBox({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "Political" },
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        });

        //四种人类别
        //$("#FourPersonType").ComboBox({
        //    description: "==请选择==",
        //    height: "200px"
        //});

        //公司
        $("#OrganizeId").ComboBoxTree({
            url: top.contentPath + "/BaseManage/Organize/GetTreeJson",
            description: "==请选择==",
            height: "200px",
        }).bind("change",
            function () {

                if ($(this).attr('data-isdept')== "0") {
                    dialogAlert("该部门无法选择！");
                    $(this).removeAttr('data-text'); $(this).removeAttr('data-value'); $(this).removeAttr('data-code');
                    $(this).find(".ui-select-text").html("==请选择==");
                    return false;
                }
                //当公司选择发生变化的时候清空岗位和角色
                ClearValue();
                var istrain=$(this).attr('data-istrain');
                var value = $(this).attr('data-value');
                $("#DepartmentId").attr("data-value", value); $("#DepartmentId").removeAttr("data-text"); $("#DepartmentId").removeAttr("data-code");
                $("#DepartmentId").removeAttr("data-isorg"); $("#DepartmentId").removeAttr("data-isdept");
                $("#DepartmentId").find(".ui-select-text").html("=请选择=");
                if (istrain=="1") {
                    $(".trainadmin").show();
                } else {
                    $(".trainadmin").hide();
                }
                //加载部门
                $("#DepartmentId").ComboBoxTree({
                    url: top.contentPath + "/BaseManage/Department/GetTreeJson?organizeId=" + value,
                    description: "==请选择==",
                    allowSearch: true
                });
                //加载岗位
                $("#DutyId").ComboBox({
                    url: top.contentPath + "/BaseManage/Post/GetListJson?organizeId=" + value + '&isOrg=true',
                    id: "RoleId",
                    text: "FullName",
                    description: "==请选择==",
                    height: "200px",
                    allowSearch: true
                });
                //加载职务
                IntiPost(value);
            });
        //部门
        $("#DepartmentId").ComboBoxTree({
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        }).bind("change",
            function () {
                //下属各电厂  区域子公司
                if ($(this).attr('data-isdept')== "0") {
                    dialogAlert("该部门无法选择！");
                    $(this).removeAttr('data-text'); $(this).removeAttr('data-value'); $(this).removeAttr('data-code');
                    $(this).find(".ui-select-text").html("==请选择==");
                    return false;
                }
                ClearValue();
                var value = $(this).attr('data-value') == undefined ? "" : $(this).attr('data-value');
                var isorg = $(this).attr('data-isorg');

                //如果是厂级部门的话，在角色那会自动赋值 “厂级部门用户”
                if (isorg == "1") {
                    $.ajax({
                        url: '../../BaseManage/Post/GetListByCode',
                        data: { code: "100103" },
                        dataType: "JSON",
                        success: function(result) {
                            $("#RoleName").val(result.FullName);
                            $("#RoleId").val(result.RoleId);
                        }
                    });
                }
                var orgId = $("#OrganizeId").attr('data-value') == undefined ? "" : $("#OrganizeId").attr('data-value');
                //加载岗位
                $("#DutyId").ComboBox({
                    url: top.contentPath +
                        "/BaseManage/Post/GetListJson?organizeId=" +
                        orgId +
                        '&isOrg=' +
                        value,
                    id: "RoleId",
                    text: "FullName",
                    description: "==请选择==",
                    height: "200px",
                    allowSearch: true
                });
                //加载职务
                IntiPost(value);
                //外包工程
                $("#ProjectId").ComboBox({
                    url: "../../OutsourcingProject/Outsouringengineer/GetEngineerByDeptId?deptId=" +
                        $("#DepartmentId").attr('data-value'),
                    id: "ID",
                    text: "ENGINEERNAME",
                    description: "==请选择==",
                    height: "200px",
                    allowSearch: true
                });
            });

        //获取表单
        if (!!keyValue) {
            $.SetForm({
                url: top.contentPath + "/BaseManage/User/GetFormJson",
                param: { keyValue: keyValue },
                success: function(json) {
                    var data = json.data;
                    $("#form1").formDeserialize(data);
                    var location = "";
                    if (data.QuickQuery!=null) {
                        location = data.QuickQuery;
                    }
                    if (data.Manager != null) {
                        location += "/"+data.Manager;
                    }
                    if (data.District != null) {
                        location += "/" + data.District;
                    }
                    if (data.Street != null) {
                        location += "/" + data.Street;
                    }
                    if (location.length>0) {
                        $("#Location").val(location);
                    }
                    if (data.RoleName != null) {
                        if (data.RoleName.indexOf("专工") >= 0) {
                            $("#zy").show();
                            if (data.SpecialtyType != null && data.SpecialtyType != undefined) {
                                $("#SpecialtyType").val(data.SpecialtyType);
                                $("#SpecialtyType").find("option").each(function (i, dom) {
                                    data.SpecialtyType = "," + data.SpecialtyType + ",";
                                    if (data.SpecialtyType.indexOf("," + dom.value + ",") >= 0 && dom.value.length > 0) {
                                        $(dom).attr("selected", "selected");
                                    }
                                });
                            }
                        } else {
                            //$("#zy").hide();
                        }
                    }
                    if (data.TrainRoleId != null && data.TrainRoleId != undefined) {
                        $("#TrainRoleId").val(data.TrainRoleId);
                        $("#TrainRole").find("option").each(function (i, dom) {
                            data.TrainRoleId = "," + data.TrainRoleId + ",";
                            if (data.TrainRoleId.indexOf("," + dom.value + ",") >= 0 && dom.value.length > 0) {
                                    $(dom).attr("selected", "selected");
                                }
                            });
                    }
                    if (!!data) {
                        userAccount = data.Account;
                        if (data.Description!=null) {
                            if (data.Description.length>0) {
                                userAccount = data.Description;
                            }
                        }
                        var argValue = "@(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetItemValue("Point"))";
                        if (!!argValue && argValue == "point") {
                            var point = "";
                            $("#trpoint").show();
                            if (trainserviceurl != "" && userAccount != "") {
                                var json = {
                                    Business: "GetQualityObj",
                                    idcard: data.IdentifyID
                                }
                                $.ajax({
                                    url: trainserviceurl,
                                    data: { json: JSON.stringify(json) },
                                    dataType: "JSON",
                                    type: "Post",
                                    async: false,
                                    success: function(data) {
                                        if (data != null || data != undefined) {
                                            if (data.Qualitydata.length > 0) {
                                                point = data.Qualitydata[0].POINT;
                                            } else {
                                                point = "0";
                                            }
                                        } else {
                                            point = "0";
                                        }
                                    }
                                });
                                $("#point").val(point);
                            } else {
                                $("#point").val(0);
                            }
                        } else {
                            $("#trpoint").hide();
                        }
                    }




                    if (json.nature != "集团" && json.nature != "省级") {
                        $("#idFour").show();
                    }
                    if (json.nature == "厂级") {
                        $("#isTZ").show();
                        $("#isOut").show();
                        $(".wz").show();
                        $(".health").show();
                    }

                    //获取人员证书信息
                    getCerts(keyValue);
                    $("#OrganizeId").trigger("change");
                    if (!!$("#DepartmentId").attr('data-value')) {
                        IntiDuty($("#OrganizeId").attr('data-value'), $("#DepartmentId").attr('data-value'));
                        //绑定职务信息
                        IntiPost($("#DepartmentId").attr('data-value'));
                        //外包工程
                        $("#ProjectId").ComboBox({
                            url: "../../OutsourcingProject/Outsouringengineer/GetEngineerByDeptId?deptId=" +
                                $("#DepartmentId").attr('data-value'),
                            id: "ID",
                            text: "ENGINEERNAME",
                            description: "==请选择==",
                            height: "200px",
                            allowSearch: true
                        });
                    } else {
                        IntiDuty($("#OrganizeId").attr('data-value'), "true");
                        IntiPost($("#OrganizeId").attr('data-value'));
                    }
                    if (data.ProjectId != null) {
                        $("#ProjectId").ComboBoxSetValue(data.ProjectId);
                    }
                    $("#DepartmentId").ComboBoxTreeSetValue(data.DepartmentId);
                    $("#DepartmentId").trigger("change");
                    $("#DutyId").ComboBoxSetValue(data.DutyId);

                    if (data.FOURPERSONTYPE != null && data.FOURPERSONTYPE != undefined) {
                        // $(".filter-option").html(data.FOURPERSONTYPE);
                        $("#FourPersonType").find("option").each(function (i, dom) {
                            if (data.FOURPERSONTYPE.indexOf(dom.value) >= 0 && dom.value.length > 0) {
                                $(dom).attr("selected", "selected");
                            }
                        });
                    }

                    //将入场时间格式化
                    if (data.EnterTime != "") {
                        var newDate = /\d{4}-\d{1,2}-\d{1,2}/g.exec(data.EnterTime);
                        $("#EnterTime").val(newDate);
                    }

                    //$("#FourPersonType").ComboBoxSetValue(data.FOURPERSONTYPE);
                    //二维码
                    $("#code").attr("src", "../../Utility/BuilderImage?keyValue=" + keyValue + "|人员");
                    //照片
                    if (data.HeadIcon) {
                        document.getElementById('uploadPreview').src = top.contentPath + data.HeadIcon;
                    }
                    //签名图片
                    if (data.SignImg) {
                        if (data.SignImg.indexOf("http") >= 0) {
                            document.getElementById('signPreview').src = data.SignImg;
                        } else {
                            document.getElementById('signPreview').src = top.contentPath + data.SignImg;
                        }

                    }
                    //性别
                    if (data.Gender == "男") {
                        $("#man").attr("checked", true);
                    }
                    if (data.Gender == "女") {
                        $("#woman").attr("checked", true);
                    }
                    //是否特种作业人员
                    if (data.IsSpecial == "是") {
                        $("#IsSpecial1").attr("checked", true);
                    }
                    else {
                        $("#IsSpecial0").attr("checked", true);
                    }
                    //是否特种设备作业人员
                    if (data.IsSpecialEqu == "是") {
                        $("#IsSpecialEqu1").attr("checked", true);
                    }
                    else {
                        $("#IsSpecialEqu0").attr("checked", true);
                    }
                    //是否为四种人
                    if (data.ISFOURPERSON == "是")
                        $("#IsFourPerson1").attr("checked", true);
                    else
                        $("#IsFourPerson2").attr("checked", true);
                    $("#DegreesID").ComboBoxSetValue(data.DegreesID);
                    $("#LateDegreesID").ComboBoxSetValue(data.LateDegreesID);
                    $("#Political").ComboBoxSetValue(data.Political);

                    $("#Birthday").val(formatDate(data.Birthday, "yyyy-MM-dd"));
                    $("#Password").val("******").attr('disabled', 'disabled');
                    $("#Account").attr('disabled', 'disabled');

                    $("#IdentifyID").attr("disabled", "disabled")
                    if (data.IdentifyID != null && data.IdentifyID!=undefined) {
                        if (data.IdentifyID.length > 0) {
                            var value = $("#IdentifyID").val();
                            var sta = value.substring(0, 4);
                            var end = value.substring(value.length - 4, value.length);
                            $("#IdentifyID").attr("idcard", data.IdentifyID);
                            $("#IdentifyID").val(sta + "**********" + end);
                        }
                    }

                    //2019-03-04 Fwz 修改 查看状态隐藏身份证中间敏感信息
                    if (rqaction == "show") {
                        $("#spanCard").remove();
                        $("#IdentifyID").parent().removeClass("input-group");
                        disabledControl();
                    }
                    //这里由于会有change事件再一次进行赋值角色
                    $("#RoleName").val(data.RoleName);
                    $("#RoleId").val(data.RoleId);
                    $("#OrganizeId").attr('readonly', 'readonly');



                    //是否外包
                    if (data.IsEpiboly == "1") {
                        $("input[name='IsEpiboly']:eq(0)").prop("checked", "checked");
                        $(".project").show();
                    }
                    else {
                        $("input[name='IsEpiboly']:eq(1)").prop("checked", "checked");
                        $(".project").hide();
                    }
                    if (data.ProjectId != null) {
                        $("#ProjectId").ComboBoxSetValue(data.ProjectId);
                    }
                    //是否培训管理员

                    if (data.IsTrainAdmin == 1) {
                        $("input[name='IsTrain']:eq(0)").prop("checked", "checked");

                    }
                    else {
                        $("input[name='IsTrain']:eq(1)").prop("checked", "checked");

                    }
                    //是否在场
                    if (data.IsPresence == "0") {
                        $("input[name='IsPresence']:eq(1)").prop("checked", "checked");
                        $("#DepartureTime").show();
                        $("#DepartureTime").parent().prev().show();
                        $("#DepartureTime").attr("isvalid", "yes");

                    }
                    else {
                        $("input[name='IsPresence']:eq(0)").prop("checked", "checked");
                        $("#DepartureTime").hide();
                        $("#DepartureTime").parent().prev().hide();
                        $("#DepartureTime").removeAttr("isvalid");
                    }
                    if (!(top.currUserRoleName.indexOf("省级") >= 0 || top.currUserRoleName.indexOf("集团") >= 0)) {

                        getHealth(keyValue);
                        getHazard(keyValue);
                        getWZ(keyValue);
                        //if (isHDJL.length > 0) {
                        //    getGRWZ(keyValue);
                        //}
                    }
                    //getTrain(keyValue);
                    getWorks(keyValue);
                    $("#DepartureTime").val(formatDate(data.DepartureTime, "yyyy-MM-dd"));
                    //职务赋值
                    if (data.PostId != null && data.PostId != undefined) {
                        $("#PostId").val(data.PostName);
                        $("#PostId").find("option").each(function (i, dom) {
                            if (data.PostId.indexOf(dom.value) >= 0 && dom.value.length > 0) {
                                $(dom).attr("selected", "selected");
                            }
                        });
                        $("#PostId").selectpicker('refresh');
                    }
                }
            });
            isEnadble();
        } else {
            $("#spanCard").remove();
            $("#IdentifyID").parent().removeClass("input-group");
            keyValue = newGuid();
            $("#tdCode").hide();
            $("#tdCode").prev().attr("colspan", "2");
            IntiDuty($("#OrganizeId").attr('data-value'), $("#DepartmentId").attr('data-value'));
            IntiPost('-1');
            //新增时默认为男
            $("#man").attr("checked", true);
            document.getElementById("IsFourPerson2").checked = true;
            var isSystem = "@ERCHTMS.Code.OperatorProvider.Provider.Current().IsSystem";
            if (isSystem == "False") {
                var orgId = "@ERCHTMS.Code.OperatorProvider.Provider.Current().OrganizeId";
                $("#OrganizeId").ComboBoxSetValue(orgId);
                $("#OrganizeId").trigger("change");
                $("#OrganizeId").attr('readonly', 'readonly');
                $("#RoleName").attr('disabled', 'disabled');
            };
            if ($.currentIframe().window._deptId.length > 0) {
                $("#DepartmentId").ComboBoxTreeSetValue($.currentIframe().window._deptId);
                $("#DepartmentId").trigger("change");
            }
        }

        $('.icheck input').iCheck({
            checkboxClass: 'icheckbox_square-blue',
            radioClass: 'iradio_square-blue',
            increaseArea: '20%'
        });
        $("input[name='IsPresence']").on('ifChecked', function (event) {
            var checkValue = $(this).val();
            if (checkValue == "0") {
                $("#DepartureTime").show();
                $("#DepartureTime").parent().prev().show();
                $("#DepartureTime").attr("isvalid", "yes");
            }
            else {
                $("#DepartureTime").parent().prev().hide();
                $("#DepartureTime").hide();
                $("#DepartureTime").removeAttr("isvalid");
            }
        });



        var isPresence = $("input[name='IsPresence']:checked").val();
        if (isPresence == "0") {
            $("#DepartureTime").parent().prev().show();
            $("#DepartureTime").show();
            $("#DepartureTime").attr("isvalid", "yes");
        }
        else {
            $("#DepartureTime").parent().prev().hide();
            $("#DepartureTime").hide();
            $("#DepartureTime").removeAttr("isvalid");

        }
        //根据是否外包绑定外包工程

        $("input[name='IsEpiboly']").on('ifChecked', function (event) {
            var checkValue = $(this).val();
            if (checkValue == "1") {
                $(".project").show();
                $("#ProjectId").attr("isvalid", "yes");
            }
            else {
                $(".project").hide();
                $("#ProjectId").removeAttr("isvalid");
            }
        });
        isPresence = $("input[name='IsEpiboly']:checked").val();
        if (isPresence == "1") {
            $(".project").show();
            $("#ProjectId").attr("isvalid", "yes");
        }
        else {
            $(".project").hide();
            $("#ProjectId").removeAttr("isvalid");

        }

        //选择是否为四种人
        $("input[name='IsFourPerson']").on('ifChecked', function (event) {
            var checkValue = $(this).val();
            if (checkValue == "1") {
                $(".four").show();
                $("#FourPersonType").attr("isvalid", "yes");
            }
            else {
                $(".four").hide();
                $("#FourPersonType").removeAttr("isvalid");
            }
        });
        var IsFourPerson = $("input[name='IsFourPerson']:checked").val();

        if (IsFourPerson == "1") {
            $(".four").show();
            $("#FourPersonType").attr("isvalid", "yes");
        }
        else {
            $(".four").hide();
            $("#FourPersonType").removeAttr("isvalid");
        }

        if (top.currUserRoleName.indexOf("省级") >= 0 || top.currUserRoleName.indexOf("集团") >= 0) {
            $("#FourPersonType").removeAttr("isvalid");
        }
    }
    function isEnadble() {
        var isSystem = "@ERCHTMS.Code.OperatorProvider.Provider.Current().IsSystem";
        if (isSystem == "False") {
            $("#RoleName").attr('disabled', 'disabled');
        }
    }

    //按钮操作
    function buttonOperation() {
        var $finish = $("#btn_finish");
        var $close = $("#btn_close");
        //完成提交保存
        $finish.click(function () {
            AcceptClick();
        });

        $close.click(function () {
            dialogClose();
        })
    }

    //加载表格
    function GetGrid() {
        var queryJson = {
            keyword: keyValue
        };
        var selectedRowIndex = 0;
        var $gridTable = $('#gridTable');
        $gridTable.jqGrid({
            autowidth: true,
            height: $(window).height() - 136.5,
            autowidth: true,
            url: "../../HiddenTroubleManage/HTBaseInfo/GetRulerPageListJson",
            postData: { queryJson: JSON.stringify(queryJson) },
            datatype: "json",
            colModel: [
                { label: '主键', name: 'id', hidden: true },
                {
                    label: '违章日期',
                    name: 'checkdate',
                    index: 'checkdate',
                    width: 150,
                    align: 'left',
                    sortable: true,
                    formatter: function (cellvalue, options, rowObject) {
                        return formatDate(cellvalue, 'yyyy-MM-dd');
                    }
                },
                {
                    label: '违章描述',
                    name: 'hiddescribe',
                    index: 'hiddescribe',
                    width: 250,
                    align: 'left',
                    sortable: true,
                    formatter: function (cellvalue, options, rowObject) {
                        var html = "<a href=javascript:funcLoadOpen('" +
                            rowObject.id +
                            "') style='color:blue; text-decoration:underline'>" +
                            cellvalue +
                            "</a>";
                        return html;
                    }
                },
                {
                    label: '处理措施',
                    name: 'changemeasure',
                    index: 'changemeasure',
                    width: 300,
                    align: 'left',
                    sortable: true
                }
            ],
            viewrecords: true,
            rowNum: 30,
            rowList: [30, 50, 100],
            pager: "#gridPager",
            sortname: 'checkdate',
            sortorder: 'desc',
            rownumbers: true,
            shrinkToFit: false,
            gridview: true,
            onSelectRow: function () {
                selectedRowIndex = $('#' + this.id).getGridParam('selrow');
            },
            gridComplete: function () {
                $('#' + this.id).setSelection(selectedRowIndex, false);
            }
        });

    }

    //保存表单
    function AcceptClick() {
        getTrainRoleId();
        var idCard = $("#IdentifyID").val();
        if (idCard.length > 0) {
            if (idCard.indexOf("**********") >= 0) {
                $("#IdentifyID").removeAttr("isvalid");
            }
        }
        if (!$('#form1').Validform()) {
            var $li = $(".nav-tabs").find("li").eq(0);
            if (!$li.hasClass("active")) {
                $li.find("a").eq(0).get(0).click();
                $('#form1').Validform();
            }
            return false;
        }
        var postData = $("#form1").formSerialize(keyValue);
        postData.Birthday = postData.Birthday == "&nbsp;" ? null : postData.Birthday;
        postData["DutyName"] = $("#DutyId").attr('data-text');

        var postids = $("#PostId").selectpicker('val');
        var postid = "";
        if (postids != null && postids != "") {

            for (var i = 0; i < postids.length; i++) {
                if (i == 0) {
                    postid = postids[i];
                } else {
                    postid += "," + postids[i];
                }
            }
            postData["PostName"] = $("button[data-id='PostId']").attr("title").replace(/\s+/, "");
        } else {
            postData["PostName"] = "";
        }
        if ($("#IdentifyID").val().length>0) {
            postData["IdentifyID"] = $("#IdentifyID").attr("idcard");
        }else{
            postData["IdentifyID"] = "";
        }
        postData["PostId"] = postid;
        postData["Degrees"] = $("#DegreesID").attr('data-text');
        postData["LateDegrees"] = $("#LateDegreesID").attr('data-text');
        postData["Political"] = $("#Political").attr('data-text');
        //性别
        if (document.getElementById("man").checked) {
            postData["Gender"] = "男";
        }
        if (document.getElementById("woman").checked) {
            postData["Gender"] = "女";
        }
        //特种作业人员
        if (document.getElementById("IsSpecial1").checked) {
            var userType = $("#UserType").attr("data-value");
            postData["IsSpecial"] = userType == "监理人员" ? "否" : "是";
        }
        if (document.getElementById("IsSpecial0").checked) {
            postData["IsSpecial"] = "否";
        }
        //特种设备操作人员
        if (document.getElementById("IsSpecialEqu1").checked) {
            postData["IsSpecialEqu"] = "是";
        }
        if (document.getElementById("IsSpecialEqu0").checked) {
            postData["IsSpecialEqu"] = "否";
        }

        //是否四种人
        if (document.getElementById("IsFourPerson1").checked) {
            postData["IsFourPerson"] = "是";
        }
        if (document.getElementById("IsFourPerson2").checked) {
            postData["IsFourPerson"] = "否";
        }
        //是否培训管理员
        if (document.getElementById("IsTrain1").checked) {
            postData["IsTrainAdmin"] = "1";
        }
        if (document.getElementById("IsTrain2").checked) {
            postData["IsTrainAdmin"] = "0";
        }

        //是否是三种人
        var fourtypes = $("#FourPersonType").selectpicker('val');
        if (fourtypes != null && fourtypes != "") {
            postData["FourPersonType"] = $("button[data-id='FourPersonType']").attr("title").replace(/\s+/, "");
        } else {
            postData["FourPersonType"] = "";
        }



        //是否外包
        var isEpiboly = $("input[name='IsEpiboly']:checked").val();
        postData["IsEpiboly"] = isEpiboly;

        postData.DepartureTime = postData.DepartureTime == "&nbsp;" ? null : postData.DepartureTime;
        //是否在场
        var isPresence = $("input[name='IsPresence']:checked").val();
        postData["IsPresence"] = isPresence;

        postData["OrganizeCode"] = $("#OrganizeId").attr('data-code');
        if (!!$("#DepartmentId").attr('data-value') == false) {
            postData["DepartmentCode"] = $("#OrganizeId").attr('data-code');
        } else {
            postData["DepartmentCode"] = $("#DepartmentId").attr('data-code');
        }

        var moduleFormInstanceEntity = { "FormId": formId, "FormInstanceJson": "" };
        var arr = $("#Location").parent().find(".select-item");
        if (arr.length>0) {
            postData["QuickQuery"] = arr.eq(0).text();
            postData["SimpleSpelling"] = arr.eq(0).data("code");
        }
        else {
            postData["QuickQuery"] = " ";
            postData["SimpleSpelling"] = " ";
        }
        if (arr.length >1) {
            postData["Manager"] = arr.eq(1).text();
            postData["ManagerId"] = arr.eq(1).data("code");
        } else {
            postData["Manager"] = " ";
            postData["ManagerId"] = " ";
        }
        if (arr.length > 2) {
            postData["District"] = arr.eq(2).text();
            postData["DistrictCode"] = arr.eq(2).data("code");
        } else {
            postData["District"] =" ";
            postData["DistrictCode"] = " ";
        }
        if (arr.length > 3) {
            postData["Street"] = arr.eq(3).text();
        }
        else {
            postData["Street"] = " ";
        }

        $.SaveForm({
            url: top.contentPath + "/BaseManage/User/SaveForm",
            param: {
                "keyValue": keyValue,
                "strUserEntity": JSON.stringify(postData),
                "FormInstanceId": instanceId,
                "strModuleFormInstanceEntity": JSON.stringify(moduleFormInstanceEntity)
            },
            loading: "正在保存数据...",
            success: function (data) {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        })
    }

    //查看违章
    function funcLoadOpen(id) {
        var url = '/HiddenTroubleManage/HTBaseInfo/Form?keyValue=' + id + '&actiontype=view';
        var idx = dialogOpen({
            id: 'HTWindow',
            title: '查看违章',
            url: url,
            btns: 1,
            btn: ["关闭"],
            width: ($(top.window).width() - 200) + "px",
            height: ($(top.window).height() - 100) + "px",
            callBack: function (iframeId) {
                top.layer.close(idx);
            }
        });
    }

    //新增证书
    function add() {
        dialogOpen({
            id: 'CertForm',
            title: '添加人员证书',
            url: '/PersonManage/Certificate/Form?action=add&userId=' + keyValue,
            width: '900px',
            height: ($(window).height() - 30) + 'px',
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick();
            }
        });
    }

    //编辑证书
    function edit() {
        var keyValue = $('#gridTableCert').jqGridRowValue('Id');
        if (checkedRow(keyValue)) {
            dialogOpen({
                id: 'CertForm',
                title: '编辑人员证书',
                url: '/PersonManage/Certificate/Form?keyValue=' + keyValue,
                width: '900px',
                height: ($(window).height() - 100) + 'px',
                callBack: function (iframeId) {
                    top.frames[iframeId].AcceptClick();
                }
            })
        }
    }
    function showCert() {
        var keyValue = $('#gridTableCert').jqGridRowValue('Id');
        if (checkedRow(keyValue)) {
            var dlg=dialogOpen({
                id: 'CertForm',
                title: '查看人员证书',
                url: '/PersonManage/Certificate/Form?action=show&keyValue=' + keyValue,
                width: '900px',
                height: ($(window).height() - 100) + 'px',
                btn:["关闭"],
                callBack: function (iframeId) {
                    top.layer.close(dlg);
                }
            })
        }
    }

    //新增工作记录
    function workadd() {
        dialogOpen({
            id: 'WorkForm',
            title: '添加工作经历',
            url: '/PersonManage/WorkRecord/Form?userId=' + keyValue,
            width: '600px',
            height: ($(window).height() - 200) + 'px',
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick();
            }
        });
    }

    //编辑工作记录
    function workedit() {
        var keyValue = $('#gridWork').jqGridRowValue('Id');
        if (checkedRow(keyValue)) {
            dialogOpen({
                id: 'WorkForm',
                title: '编辑工作经历',
                url: '/PersonManage/WorkRecord/Form?keyValue=' + keyValue,
                width: '600px',
                height: ($(window).height() - 200) + 'px',
                callBack: function (iframeId) {
                    top.frames[iframeId].AcceptClick();
                }
            })
        }
    }

    //删除工作记录
    function workdel() {
        var keyValue = $('#gridWork').jqGridRowValue('Id');
        if (keyValue) {
            $.RemoveForm({
                url: '../../PersonManage/WorkRecord/RemoveForm',
                param: { keyValue: keyValue },
                success: function (data) {
                    $('#gridWork').trigger('reloadGrid');
                }
            })
        } else {
            dialogMsg('请选择要删除的工作经历！', 0);
        }

    }

    //删除证书
    function del() {
        var keyValue = $('#gridTableCert').jqGridRowValue('Id');
        if (keyValue) {
            $.RemoveForm({
                url: '../../PersonManage/Certificate/RemoveForm',
                param: { keyValue: keyValue },
                success: function (data) {
                    $('#gridTableCert').trigger('reloadGrid');
                }
            })
        } else {
            dialogMsg('请选择需要删除的人员证书！', 0);
        }
    }

    function exportData() {
        window.location.href = "ExportUserInfo?userId=" + keyValue;
    }

    //离开事件增加生日生成
    function IdCardonblur() {
        $.ExistField('IdentifyID', '../../BaseManage/User/ExistIdentifyID');

        var idc = $("#IdentifyID").val();
        var year = idc.substring(6, 10);
        var month = idc.substring(10, 12);
        var day = idc.substring(12, 14);
        //如果没有填写生日则自动生成生日
        //if ($("#Birthday").val() == "") {

        if (IsDate(year + "-" + Number(month) + "-" + Number(day)))
            $("#Birthday").val(year + "-" + month + "-" + day);
        //}
        if (IsDate(year + "-" + Number(month) + "-" + Number(day))) {
            //如果没有填写年龄 则自动生成年龄
            var Age = GetAge(year + "-" + month + "-" + day);
            $("#Age").val(Age);
        }
    }

    function IsDate(sBirthday) {
        var d = new Date(sBirthday.replace(/-/g, "/"));
        var newday = d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
        if (sBirthday != (d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate())) {
            return false;
        } else {
            return true;
        }
    }

    function GetAge(strBirthday) {
        var returnAge;
        var strBirthdayArr = strBirthday.split("-");
        var birthYear = strBirthdayArr[0];
        var birthMonth = strBirthdayArr[1];
        var birthDay = strBirthdayArr[2];
        if (birthYear == "") {
            return "";
        }
        d = new Date();
        var nowYear = d.getFullYear();
        var nowMonth = d.getMonth() + 1;
        var nowDay = d.getDate();

        if (nowYear == birthYear) { //出生日期和当前同一年
            returnAge = 0;
        } else {
            var ageDiff = nowYear - birthYear;
            if (ageDiff > 0) {
                if (nowMonth == birthMonth) {
                    var dayDiff = nowDay - birthDay;
                    if (dayDiff < 0) {
                        returnAge = ageDiff - 1;
                    } else {
                        returnAge = ageDiff;
                    }
                } else {
                    var monthDiff = nowMonth - birthMonth;
                    if (monthDiff < 0) {
                        returnAge = ageDiff - 1;
                    } else {
                        returnAge = ageDiff;
                    }
                }
            } else {
                returnAge = -1;
            }
        }
        return returnAge;
    }
    function showCard(obj) {
        var idCard = $("#IdentifyID").attr("idcard");
        $("#IdentifyID").val(idCard);
        $("#IdentifyID").removeAttr("disabled");
    }
    function setCard(obj) {
        $("#IdentifyID").attr("idcard",obj.value);
    }
    function clearAddr(obj) {
        $('#Location').citypicker('reset');
    }
    function getTrainRole() {
        $.get("GetTrainRole", function (data) {
            var json = $.parseJSON(data);
            if (json.type == 1) {
                var html = "";
                $(json.resultdata).each(function (j,item) {
                    html += '<option value="'+item.intTrainRoleId+'">'+item.varRoleName+'</option>';
                });
                $("#TrainRole").append(html);
            }
        });
    }
    function getTrainRoleId() {
        var ids = "";
        var names = "";
        $("#tdRole").find("li[class='selected']").each(function (j,li) {
            var idx = $(li).attr("data-original-index");
            ids += $("#TrainRole").find("option").eq(idx).val() + ",";
            names += $("#TrainRole").find("option").eq(idx).text() + ",";
        })
        if (ids.length>0) {
            ids = ids.substring(0, ids.length - 1);
            names = names.substring(0, names.length - 1);
        }
        $("#TrainRoleId").val(ids);
        $("#TrainRoleName").val(names);
    }


    //导出个人反违章档案
    function exportWz() {
        window.location.href = "../../LllegalManage/LllegalRegister/ExportPersonWzRecord?userId=" + keyValue;
    }
</script>
<div style="margin-left: 10px; margin-right: 10px;">
    <ul class="nav nav-tabs">
        <li class="active"><a href="#BaseInfo" data-toggle="tab">基本信息</a></li>
        <li><a href="#certificate" data-toggle="tab">证书信息</a></li>
        <li class="wz"><a href="#wz" data-toggle="tab">(反)违章档案</a></li>
        @*<li class="djwz" style="display:none;"><a href="#djwz" data-toggle="tab">违章登记档案</a></li>*@
        <li class="health"><a href="#health" data-toggle="tab">职业健康</a></li>
        <li onclick="getTrain()"><a href="#TrainData" data-toggle="tab">培训信息</a></li>
        <li><a href="#work" data-toggle="tab">工作经历</a></li>
        @if (ViewBag.isShow)
        {
            <li><a href="#Performance" data-toggle="tab">绩效档案</a></li>
        }
        <li onclick="getEnterRecord()" id="menjin"><a href="#mjjl" data-toggle="tab">门禁进出记录</a></li>
    </ul>
    <div class="tab-content" style="padding-top: 15px;">
        <div id="BaseInfo" class="tab-pane active" style="padding-right: 30px;">
            <table class="form">
                <tr>
                    <td class="formTitle" style="width:130px;">
                        <input type="button" onclick="readIDCard()" id="btnReadIDCard" style="display:none;" value="读取身份证" />
                    </td>
                    <td colspan="3"></td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:130px;">姓名<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="RealName" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" />
                    </td>
                    <td align="right" rowspan="4">
                        <div style="margin-top: 10px; text-align: right;">
                            <div class="file" title="点击上传照片">
                                <img id="uploadPreview" style="width: 115px; height: 115px;" src="~/Content/images/App.png" />
                                <input type="file" name="uploadFile" id="uploadFile">
                                <input type="hidden" id="HeadIcon" />
                            </div>
                            <div style="line-height: 14px; color: #75777A; text-align: right;" id="divTips">
                                点击图片可上传新的照片
                            </div>
                        </div>

                    </td>
                    <td align="center" rowspan="5" valign="top" id="tdCode">
                        <div style="margin-top: 10px; ">
                            <img src="" id="code" />
                        </div>
                        <div style="line-height: 14px; color: #75777A; text-align: center;">
                            二维码
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:130px;">账号<font face="宋体">*</font></td>
                    <td class="formValue icheck">
                        <input type="text" id="Account" name="Accunt" isvalid="yes" checkexpession="NotNull" class="form-control" onblur="$.ExistField(this.id,top.contentPath + '/BaseManage/User/ExistAccount')" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:130px;">性别<font face="宋体">*</font></td>
                    <td class="formValue icheck">
                        <input type="radio" value="男" id="man" name="Gender" />&nbsp;<label for="man">男</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" value="女" id="woman" name="Gender" />&nbsp;<label for="woman">女</label>

                    </td>
                </tr>
                <tr>
                    <td class="formTitle">单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="OrganizeId" type="selectTree" class="ui-select" isvalid="yes" checkexpession="NotNull"></div>
                    </td>
                </tr>
                <tr>


                    <td class="formTitle">部门</td>
                    <td class="formValue">
                        <div id="DepartmentId" type="selectTree" class="ui-select"></div>
                    </td>
                </tr>

                <tr>
                    <td class="formTitle">岗位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="DutyId" type="select" class="ui-select" isvalid="yes" checkexpession="NotNull"></div>
                    </td>
                    <td class="formTitle">职务</td>
                    <td class="formValue">
                        <select id="PostId" class="selectpicker show-menu-arrow form-control" multiple placeholder="请选择职务"></select>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">人员类型<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="UserType" type="select" class="ui-select" multiple isvalid="yes" checkexpession="NotNull">
                            <ul>
                                <li data-value="" class="" style="padding: 0px 5px;">==请选择==</li>
                                <li data-value="公司领导" title="" class="" style="padding: 0px 5px;">公司领导</li>
                                <li data-value="部门负责人" title="" class="" style="padding: 0px 5px;">部门负责人</li>
                                <li data-value="安全管理人员" title="" class="" style="padding: 0px 5px;">安全管理人员</li>
                                <li data-value="监理人员" title="" class="" style="padding: 0px 5px;">监理人员</li>
                                <li data-value="专业负责人" title="" class="" style="padding: 0px 5px;">专业负责人</li>
                                <li data-value="一般管理人员" title="" style="padding: 0px 5px;" class="">一般管理人员</li>
                                <li data-value="班组负责人" title="" class="" style="padding: 0px 5px;">班组负责人</li>
                                <li data-value="普通员工" title="" class="" style="padding: 0px 5px;">普通员工</li>
                                <li data-value="项目负责人" title="" style="padding: 0px 5px;" class="">项目负责人</li>
                                <li data-value="现场负责人" title="" style="padding: 0px 5px;" class="">现场负责人</li>
                                <li data-value="一般作业人员" title="" style="padding: 0px 5px;" class="">一般作业人员</li>
                            </ul>
                        </div>
                    </td>
                    <td class="formTitle">政治面貌</td>
                    <td class="formValue">
                        <div id="Political" type="select" class="ui-select"></div>
                    </td>


                </tr>

                <tr>
                    <td class="formTitle">身份证号<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div class="input-group">
                            <input id="IdentifyID" length="18" type="text" class="form-control" isvalid="yes" checkexpession="IDCard" onchange="setCard(this)" onblur="IdCardonblur()" />
                            <span class="input-group-addon" onclick="showCard(this)" title="查看完整身份证号" id="spanCard"><i class="fa fa-eye"></i></span>
                        </div>
                    </td>
                    <td class="formTitle">手机号码</td>
                    <td class="formValue">
                        <input id="Mobile" type="text" class="form-control" isvalid="yes" checkexpession="MobileOrNull" />
                    </td>

                </tr>

                <tr id="isTZ">
                    <td class="formTitle">是否为特种作业人员<font face="宋体">*</font></td>
                    <td class="formValue icheck tzzy">
                        <input type="radio" value="是" id="IsSpecial1" name="IsSpecial" />&nbsp;<label for="IsSpecial1">是</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" value="否" id="IsSpecial0" name="IsSpecial" checked="checked" />&nbsp;<label for="IsSpecial0">否</label>
                    </td>
                    <td class="formTitle">是否为特种设备作业人员<font face="宋体">*</font></td>
                    <td class="formValue icheck tzsb">
                        <input type="radio" value="是" id="IsSpecialEqu1" name="IsSpecialEqu" />&nbsp;<label for="IsSpecialEqu1">是</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" value="否" id="IsSpecialEqu0" name="IsSpecialEqu" checked="checked" />&nbsp;<label for="IsSpecialEqu0">否</label>
                    </td>
                </tr>

                <tr id="idFour">
                    <td class="formTitle">是否为三种人<font face="宋体">*</font></td>
                    <td class="formValue icheck">
                        <input type="radio" value="1" id="IsFourPerson1" name="IsFourPerson" />&nbsp;<label for="IsFourPerson1">是</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" value="0" id="IsFourPerson2" name="IsFourPerson" />&nbsp;<label for="IsFourPerson2">否</label>
                    </td>
                    <td class="formTitle four">三种人类别<font face="宋体">*</font></td>
                    <td class="formValue four">
                        <select class="selectpicker show-menu-arrow form-control" multiple placeholder="请选择类别" id="FourPersonType" checkexpession="NotNull">
                            @Html.Raw(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetOptionsString("threepeople"))
                        </select>

                    </td>
                </tr>



                <tr>
                    <td class="formTitle">出生日期</td>
                    <td class="formValue">
                        <input id="Birthday" type="text" class="form-control input-wdatepicker" onfocus="WdatePicker({readOnly:true})" />
                    </td>
                    <td class="formTitle">年龄<font face="宋体"></font></td>
                    <td class="formValue">
                        <input id="Age" type="text" class="form-control" isvalid="yes" checkexpession="PositiveNumOrNull" maxlength="2" />
                    </td>

                </tr>



                <tr>
                    <td class="formTitle">民族</td>
                    <td class="formValue">
                        <div id="Nation" type="select" class="ui-select"></div>
                    </td>
                    <td class="formTitle">籍贯</td>
                    <td class="formValue">
                        <div id="Native" type="select" class="ui-select"></div>
                    </td>

                </tr>

                <tr>
                    <td class="formTitle">工种</td>
                    <td class="formValue">
                        <select id="Craft" class="form-control">
                            <option value="">请选择或者输入</option>
                            @Html.Raw(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetDataItemListOption("PersonWrokType"))
                        </select>
                        @*<input id="Craft" type="text" class="form-control" />*@
                    </td>
                    <td class="formTitle">技术等级</td>
                    <td class="formValue">
                        <div id="TechnicalGrade" type="select" class="ui-select"></div>
                    </td>
                </tr>
                <tr>

                    <td class="formTitle">工种工龄</td>
                    <td class="formValue">
                        <input id="CraftAge" type="text" class="form-control" isvalid="yes" checkexpession="PositiveNumOrNull" maxlength="2" />
                    </td>

                    <td class="formTitle">职称</td>
                    <td class="formValue">
                        <div id="JobTitle" type="select" class="ui-select"></div>
                    </td>

                </tr>
                <tr>
                    <td class="formTitle">原始学历</td>
                    <td class="formValue">
                        <div id="DegreesID" type="select" class="ui-select"></div>
                    </td>
                    <td class="formTitle">后期学历</td>
                    <td class="formValue">
                        <div id="LateDegreesID" type="select" class="ui-select"></div>
                    </td>

                </tr>
                <tr>
                    <td class="formTitle">工号</td>
                    <td class="formValue">
                        <input id="EnCode" type="text" class="form-control" />
                    </td>
                    <td class="formTitle">健康状况</td>
                    <td class="formValue">
                        <select id="HealthStatus" class="form-control">
                            <option value="">请选择</option>
                            @Html.Raw(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetDataItemListOption("HealthStatus"))
                        </select>
                        @*<input id="Craft" type="text" class="form-control" />*@
                    </td>
                </tr>
                <tr id="trpoint">
                    <td class="formTitle">素质意识值</td>
                    <td class="formValue" colspan="3">
                        <input id="point" type="text" class="form-control" disabled="disabled" />
                    </td>

                </tr>
                <tr>
                    <td class="formTitle">座机电话</td>
                    <td class="formValue">
                        <input id="Telephone" type="text" class="form-control" isvalid="yes" checkexpession="PhoneOrNull" placeholder="格式区号-电话号码" />
                    </td>
                    <td class="formTitle">入厂(职)时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="EnterTime" type="text" class="form-control input-wdatepicker" value="@DateTime.Now.ToString("yyyy-MM-dd")" onfocus="WdatePicker()" isvalid="yes" checkexpession="NotNull" />
                    </td>

                </tr>
                <tr>
                    <td class="formTitle">地址(<a onclick="clearAddr(obj)" title="清除地址" id="btnClearAddr" style="cursor:pointer;">Ⅹ</a>)</td>
                    <td class="formValue">
                        <input id="Location" type="text" class="form-control" style="width:90%;" data-toggle="city-picker" placeholder="点击从下拉面板中选择省/市/区(县)/镇(街道)">
                    </td>
                    <td class="formTitle">详细地址</td>
                    <td class="formValue">
                        <input id="Address" type="text" class="form-control" maxlength="64" />
                    </td>

                </tr>

                <tr id="isOut">
                    <td class="formTitle">是否外包<font face="宋体">*</font></td>
                    <td class="formValue icheck">
                        <input type="radio" value="1" id="IsEpiboly1" name="IsEpiboly" />&nbsp;<label for="IsEpiboly1">是</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" value="0" id="IsEpiboly2" name="IsEpiboly" checked="checked" />&nbsp;<label for="IsEpiboly2">否</label>
                    </td>
                    <td class="formTitle project" style="display:none;">外包工程名称</td>
                    <td class="formValue project" style="display:none;">
                        <div id="ProjectId" type="select" class="ui-select"></div>
                    </td>
                </tr>

                <tr>
                    <td class="formTitle">是否在厂(职)<font face="宋体">*</font></td>
                    <td class="formValue icheck">

                        <input type="radio" value="1" id="IsPresence1" name="IsPresence" checked="checked" />&nbsp;<label for="IsPresence1">是</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" value="0" id="IsPresence2" name="IsPresence" />&nbsp;<label for="IsPresence2">否</label>
                    </td>
                    <td class="formTitle">离厂(职)时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="DepartureTime" type="text" class="form-control input-wdatepicker" onfocus="WdatePicker()" isvalid="yes" checkexpession="NotNull" />
                    </td>
                </tr>
                <tr id="zy">
                    <td class="formTitle" id="td_title_specialtytype">专业类别</td>
                    <td class="formValue" id="td_value_specialtytype">
                        <select id="SpecialtyType" class="form-control selectpicker show-menu-arrow" multiple placeholder="请选择专业类别">
                            @Html.Raw(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetOptionsString("SpecialtyType"))
                        </select>
                    </td>
                    <td class="formTitle">排序号</td>
                    <td class="formValue">
                        <input id="SortCode" type="text" class="form-control" isvalid="yes" checkexpession="PositiveNumOrNull" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">邮箱</td>
                    <td class="formValue">
                        <input id="Email" type="text" class="form-control" isvalid="yes" checkexpession="EmailOrNull" length="64" maxlength="64" />
                    </td>
                    <td class="formTitle">请假类型</td>
                    <td class="formValue">
                        <select id="Description" class="form-control">
                            <option value=" "></option>
                            <option value="长假">长假</option>
                            <option value="短假">短假</option>
                        </select>
                    </td>
                </tr>
                <tr id="tdRole" class="trainadmin" style="display:none;">
                    <td class="formTitle">受训角色</td>
                    <td class="formValue" colspan="3">
                        <select id="TrainRole" class="form-control selectpicker show-menu-arrow" multiple placeholder="请选择受训角色"></select>
                        <input type="hidden" id="TrainRoleId" /><input type="hidden" id="TrainRoleName" />
                    </td>

                </tr>
                <tr>
                    <th class="formTitle" valign="top" style="padding-top: 4px;">
                        签名
                    </th>
                    <td class="formValue">
                        <div style="margin-top: 10px; ">
                            <div class="file" title="点击上传照片">
                                <img id="signPreview" style="width: 200px; height: 115px;" src="~/Content/images/no.png" />
                                <input type="file" name="signFile" id="signFile">
                                <input type="hidden" id="SignImg" />
                            </div>
                            <div style="line-height: 14px; color: #75777A; text-align: right;" id="divTips">
                                @*点击图片可上传新的照片*@
                            </div>
                        </div>
                    </td>
                    <td class="formTitle trainadmin" style="display:none;">是否培训管理员</td>
                    <td class="formValue icheck trainadmin" style="display:none;">
                        <input type="radio" value="1" id="IsTrain1" name="IsTrain" />&nbsp;<label for="IsPresence1">是</label>&nbsp;&nbsp;&nbsp;
                        <input type="radio" value="0" id="IsTrain2" name="IsTrain" />&nbsp;<label for="IsPresence2">否</label>
                    </td>
                </tr>


                <!--以下信息隐藏不显示-->

                <tr style="display:none;">
                    <td class="formTitle">账户<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="Account" type="text" class="form-control" />
                    </td>
                    <td class="formTitle">密码<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="Password" type="text" class="form-control" placeholder="请输入密码" />
                    </td>
                </tr>
                <tr style="display:none;">
                    <td class="formTitle">角色<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <input id="RoleName" type="text" class="form-control" placeholder="请选择角色" readonly onclick="if (!!$('#OrganizeId').attr('data-value') == true) { selectRole($('#RoleId').val(), $('#OrganizeId').attr('data-value'), 1, 2, window.document.body, 'RoleName,RoleId'); } else { dialogMsg('请先选择所属公司！', 0); }" />
                        <input id="RoleId" type="hidden" /><input id="DeptId" type="hidden" />
                    </td>
                </tr>
            </table>
        </div>
        <div id="certificate" class="tab-pane">

            <div class="toolbar">
                <div class="btn-group">
                    <a id="add" class="btn btn-default" onclick="add()"><i class="fa fa-plus"></i>新增</a>
                    <a id="edit" class="btn btn-default" onclick="edit()"><i class="fa fa-pencil-square-o"></i>编辑</a>
                    <a id="delete" class="btn btn-default" onclick="del()"><i class="fa fa-trash-o"></i>删除</a>
                </div>
            </div>

            <div class="gridPanel" style="margin-top:10px;">
                <table id="gridTableCert"></table>
            </div>

        </div>
        <div id="wz" class="tab-pane">
            <div class="gridPanel">

                <div class="toolbar">
                    <div class="btn-group">
                        <a id="exportWz" class="btn btn-default" onclick="exportWz()"><i class="fa fa-file-word-o"></i>导出</a>
                    </div>
                </div>
                <div class="gridPanel" style="margin-top:10px;">
                    <table id="gridTableWZ"></table>
                    <div id="gridPagerWZ"></div>
                </div>
            </div>
        </div>
        @*<div id="djwz" class="tab-pane">
                <div class="gridPanel">
                    <table id="gridTableWZ1"></table>
                    <div id="gridPagerWZ1"></div>
                </div>
            </div>*@
        <div id="TrainData" class="tab-pane">
            <div class="gridPanel">
                <table id="gridTrain"></table>

            </div>
        </div>

        <div id="health" class="tab-pane">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <strong>&nbsp;&nbsp;职业危害因素接触记录</strong>
                    <span class="tools pull-right">
                        <a class="fa fa-chevron-down" title="展开/收起"></a>
                    </span>
                </div>
                <div class="panel-body">
                    <div class="gridPanel">
                        <table id="gridTableHazard"></table>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <strong>&nbsp;&nbsp;职业健康体检记录</strong>
                    <span class="tools pull-right">
                        <a class="fa fa-chevron-down" title="展开/收起"></a>
                    </span>
                </div>
                <div class="panel-body">
                    <div class="gridPanel">
                        <table id="gridTableHealth"></table>
                    </div>
                </div>
            </div>
        </div>
        <div id="work" class="tab-pane">
            <div class="toolbar">
                <div class="btn-group">
                    <a id="Workadd" class="btn btn-default" onclick="workadd()"><i class="fa fa-plus"></i>新增</a>
                    <a id="workedit" class="btn btn-default" onclick="workedit()"><i class="fa fa-pencil-square-o"></i>编辑</a>
                    <a id="workdelete" class="btn btn-default" onclick="workdel()"><i class="fa fa-trash-o"></i>删除</a>
                </div>
            </div>
            <div class="gridPanel" style="margin-top: 10px;">
                <table id="gridWork"></table>
            </div>
        </div>
        <div id="Performance" class="tab-pane">
            <div class="titlePanel">
                <div class="title-search">


                </div>
                <div class="toolbar">
                    <div class="btn-group">
                        <div class="form-group">
                            <select class="form-control" id="Pyear" onchange="yearChange(this)">
                                @{
                                    var YearCount = 0;
                                    while (YearCount < 5)
                                    {
                                        <option value="@Html.Raw(DateTime.Now.Year-YearCount)">@Html.Raw(DateTime.Now.Year - YearCount)</option>
                                        YearCount++;
                                    }
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="gridPanel" s>
                <table id="gridPerformance" class="table table-bordered text-center"></table>
            </div>
        </div>
        <div id="mjjl" class="tab-pane">
            <div class="gridPanel">
                <table id="gridMJ"></table>

            </div>
        </div>
    </div>
</div>
<script src="~/content/scripts/plugins/city-picker/js/city-picker.data.js"></script>
<script type="text/javascript" src="~/content/scripts/plugins/city-picker/js/city-picker.js"></script>
<!--绩效档案-->
<script type="text/javascript">
    var isShow = '@ViewBag.isShow'
    $(function () {
        if (isShow=='True')
        {
        var year = $("#Pyear").val();
        BuildJXTable(year);//页面加载调用
        }

    })

    function yearChange(elemt) {
        //$gridTable.jqGrid('setGridParam', {
        //    postData: { year: $(elemt).val(), userid: keyValue },
        //}).trigger('reloadGrid');

        BuildJXTable($(elemt).val());//页面加载调用
    }
  function getcolModel(year) {
        var colModel = new Array();
      $.ajax({
          url: "@Url.Action("GetPerformanceList")?userid=" + keyValue + "&year" + year,
            type: "get",
            dataType: "json",
            async: false,
            success: function (data) {
                if (data) {
                    colModel[0] = {
                        label: '姓名', name: 'username', width: 140, align: 'center', sortable: false

                    };
                    colModel[1] = {
                        label: '职务', name: 'quarters', width: 140, align: 'center', sortable: false

                    };
                    for (var i = 0; i < data.length; i++) {
                        colModel[i + 2] = {
                            label: data[i], name: 'title' + i, width: 140, align: 'center', sortable: false

                        };
                    }
                }
            }
        });
        return colModel;
    }


    function BuildJXTable(year) {
          $.ajax({
          url: "@Url.Action("GetPerformanceList")?userid=" + keyValue + "&year=" + year,
            type: "get",
            dataType: "json",
            async: false,
              success: function (data) {
                  var theadStr = "";
                  if (!!data && data.length>0) {

                      $.each(data, function (index, item) {
                          theadStr += "<tr>";
                          theadStr += "<th name='th_month' rowspan=\"2\" style=' vertical-align: central !important;'>" + item.Month + "</th>"
                          var titles = item.Title.split(",");
                          $.each(titles, function (i, title) {
                              theadStr += "<th>" + title + "</th>"
                          })
                          theadStr += "</tr><tr>"
                          var Scores = item.Score.split(",");
                          $.each(Scores, function (j, score) {
                              theadStr += "<td>" + score + "</td>"
                          })
                      })
                  } else {
                       theadStr = " <tr><th>暂无数据</th></tr>"
                  }
                  $("#gridPerformance").html(theadStr);
                  $("#gridPerformance tr th").css({ "vertical-align": "central !important" });
              },
              error: function (error) {
                  var str = " <tr><th>暂无数据</th></tr>"
                  $("#gridPerformance").html(str);

              }
        });
        //var colModel = getcolModel(year);
        //var $gridTable = $('#gridPerformance');


        @*$gridTable.jqGridEx({
            url: "@Url.Action("GetPerformanceList")",
            postData: { year: year, userid: keyValue },
            datatype: "json",
            height: $(window).height() - 180,
            autowidth: true,
            colModel: [
                { label: '主键', name: 'Id', hidden: true },
                {
                    label: '功能名称', name: 'ModuleName', index: 'ModuleName', width: 400, align: 'center'
                },
                { label: '编码', name: 'ModuleCode', index: 'ModuleCode', width: 400, align: 'center' },
                {
                    label: '角色授权', name: 'AuthorizeName', index: 'AuthorizeName', width: 400, align: 'center'
                },
                {
                    label: '排序字段', name: 'Sort', index: 'Sort', width: 400, align: 'center'
                },
                {
                    label: '备注', name: 'Remark', index: 'Remark', width: 400, align: 'center'
                },
            ],
            viewrecords: true,
            rowNum: 30,
            rowList: [30, 50, 100],
            pager: false,//禁止分页
            sortname: 'Sort',
            sortorder: 'asc',
            rownumbers: true,
            shrinkToFit: false,
            gridview: true,
            onSelectRow: function () {
                selectedRowIndex = $("#" + this.id).getGridParam('selrow');
            }
        });*@
    }

    //自动读取身份证信息
    var socket;
    if (rqaction == "" && keyValue == "" && softName=="gdhjb") {
        jQuery("#btnReadIDCard").css({"display":"block"});

        var host = "ws://127.0.0.1:10003";
        socket = new WebSocket(host);
        try {
            socket.onopen = function () {
                console.log("已初始化");
            };
            socket.onclose = function () {
                console.log("读卡服务已断开")
            };
            socket.onmessage = function (e) {
                if (e.data) {
                    var card = JSON.parse(e.data);
                    jQuery("#RealName").val(card.Name);
                    $("#Address").val(card.Address);
                    $("#Birthday").val(card.Birth);
                    $("#Nation").ComboBoxSetValue(card.National + "族");
                    //var year = card.Birth.split('-')[0];
                    //var newData = new Date();
                    //$("#Age").val(parseInt(newData.getFullYear() - Number(year)));
                    $("#UserType").ComboBoxSetValue("一般作业人员");
                    //性别
                    if (card.Sex == "男") {
                        $("#man").attr("checked", true);
                        $("#man").parent().addClass("checked");
                        $("#woman").parent().removeClass("checked");
                    }
                    else {
                        $("#woman").attr("checked", true);
                        $("#woman").parent().addClass("checked");
                        $("#man").parent().removeClass("checked");
                    }
                    var idNumber = jQuery.trim(card.Number);
                    $.get("../../BaseManage/User/ExistIdentifyID", { IdentifyID: idNumber }, function (data) {
                        if (data) {
                            if (data == 'True') {                               
                                jQuery("#IdentifyID").val(idNumber);
                                var year = idNumber.substring(6, 10);
                                var month = idNumber.substring(10, 12);
                                var day = idNumber.substring(12, 14);                          
                                if (IsDate(year + "-" + Number(month) + "-" + Number(day))) {
                                    //如果没有填写年龄 则自动生成年龄
                                    var Age = GetAge(year + "-" + month + "-" + day);
                                    $("#Age").val(Age);
                                }
                            }
                            else
                                dialogMsg("身份证号已存在！", 0);
                        }
                    });

                    $.get("../../BaseManage/User/ExistAccount", { Account: idNumber }, function (data) {
                        if (data) {
                            if (data == 'True')
                                jQuery("#Account").val(idNumber);
                            else
                                dialogMsg("账号已存在！", 0);
                        }

                    });
                }
            };
        } catch (ex) {

        }

    }
    function readIDCard() {
        if (socket.readyState == 1) {
            socket.send("readIDCard");
        }
        else
        dialogMsg('连接设备失败！请刷新页面！', 0);
    }
</script>
