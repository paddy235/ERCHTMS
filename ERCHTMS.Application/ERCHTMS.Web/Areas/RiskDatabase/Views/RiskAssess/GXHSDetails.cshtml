@{
    ViewBag.Title = "区域管理";
    Layout = "~/Views/Shared/_Index.cshtml";
}

<link rel="stylesheet" href="~/content/scripts/plugins/bootstrap-select/bootstrap-select.min.css" type="text/css" />
<script type="text/javascript" src="~/content/scripts/plugins/bootstrap-select/bootstrap-select.min.js"></script>
<script src="~/Content/scripts/plugins/combo-select/jquery.combo.select.js"></script>
<link rel="stylesheet" href="~/Content/scripts/plugins/combo-select/combo.select.css">
<script src="~/Content/scripts/business/Common.js"></script>
<script>
    var orgId = "@ERCHTMS.Code.OperatorProvider.Provider.Current().OrganizeId";
    var keyValue = request('keyValue');
    var parentId = request('parentId');
    var mode = request('mode');
    var areaId = request('areaId');
    var planId = request('planId');
    var areaName = request('areaName');
    var tCode = ""; var tName = ""; var tContent = ""; var postId = "";
    var dName = "";
    var node = null;
    var score = 0;
    var idx = null;
    var mark = false;
    var action = request("action"); //跳转方式 add：新增  edit：编辑 show：查看
    var ListingId = request("ListingId");//作业活动/设备设施清单评价
    var mode = request("mode");//历史记录跳转 值为history 旧版本 
    $(function () {
        initControl();
    })
    //初始化控件
    function initControl() {
        if (mode == "history") {
            action = "show"
        }
        if (action=="show") {
            $("#container").find("input,textarea,.ui-select,.ui-select-text,.ui-select-option-content").each(function (ele, index) {
                $(this).attr("disabled", "disabled");
                $(this).attr("readonly", "readonly");
            })
        }

        var url = top.contentPath + "/BaseManage/District/GetTreeJson";
        if (top.Risk != undefined) {
            if (top.Risk.areaIds != undefined) {
                areaId = top.Risk.areaIds;
            }
        }
        //加载风险类型
        $("#RiskType").ComboBox({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "RiskType" },
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "150px",
            allowSearch: true
        }).bind("change", function () {
            selRiskType(this);
        });
        var equdata = [{ ItemName: "是", ItemValue: 0 }, { ItemName: "否", ItemValue: 1 }];
        //加载是否特种设备
        $("#IsSpecialEqu").ComboBox({
            data: equdata,
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "150px",
            allowSearch: true
        });
        var AdoptData = [{ ItemName: "采纳", ItemValue: 0 }, { ItemName: "不采纳", ItemValue: 1 }];
        //加载是否采纳
        $("#IsAdopt").ComboBox({
            data: AdoptData,
            id: "ItemValue",
            text: "ItemName",
            description: "==请选择==",
            height: "150px",
            allowSearch: true
        });

        if (!!ListingId) {
            $.SetForm({
                url: "../../RiskDatabase/BaseListing/GetFormJson",
                param: { keyValue: ListingId },
                success: function (data) {
                    $("#container").formDeserialize(data);
                    if (data.AreaName != null && data.AreaName != "" && data.AreaName != undefined) {
                        $("#DistrictName").val(data.AreaName);
                        $("#DistrictId").val(data.AreaId);
                        $("#AreaCode").val(data.AreaCode);
                    }
                    
                    if (data.Type == 0) {

                        $("#RiskType").ComboBoxSetValue("作业活动");
                    }
                    else if (data.Type == 1)
                    { 
                        $("#RiskType").ComboBoxSetValue("设备设施");
                    }
                    selRiskType(document.getElementById("RiskType"));
                    if (data.ActivityStep != null && data.ActivityStep != undefined) {
                        $("#WorkContent").val(data.ActivityStep);
                    }
                    $("#ListingId").val(ListingId);
                    $("#RiskType").attr("disabled", "disabled");
                    $("#Status").val("1");
                }
            });
        }
        //获取表单
        if (!!keyValue) {
            $.SetForm({
                url: mode == "history" ? "../../RiskDatabase/RiskAssess/GetHistoryFormJson" : "../../RiskDatabase/RiskAssess/GetFormJson",
                param: { keyValue: keyValue },
                success: function (data) {
                    $("#Way").val(data.Way);
                    $("#Way").trigger("change");
                    $("#container").formDeserialize(data);
                    dName = data.DeptName;
                    postId = data.PostId;
                    if (data.LevelName != null && data.LevelName != undefined) {
                        $("#LevelName").val(data.LevelName);
                        $("#LevelName").find("option").each(function (i, dom) {
                            if (data.LevelName.indexOf(dom.value) >= 0 && dom.value.length > 0) {
                                $(dom).attr("selected", "selected");
                            }
                        });
                    }
                    if (data.RiskType != null && data.RiskType != undefined) {
                        $("#RiskType").ComboBoxSetValue(data.RiskType);
                        selRiskType(document.getElementById("RiskType"));
                    }
                    if (data.HazardType != null && data.HazardType != undefined) {
                        $("#HazardType").val(data.HazardType);

                        $("#HazardType").find("option").each(function (i, dom) {
                            if (("," + data.HazardType + ",").indexOf("," + $(dom).val() + ",") >= 0 && dom.value.length > 0) {
                                $(dom).attr("selected", "selected");
                            }
                        });
                    }
                    $("#DistrictId").trigger("change");
                    $("#PostId").ComboBoxSetValue(data.PostId);

                    if ($.currentIframe().window.document.getElementById("itemTree") == null) {
                        $("#tab101").find(".form-control").removeAttr("isvalid", "yes").removeAttr("checkexpession", "NotNull");
                        $("#tab101").find(".form-control").removeAttr("checkexpession", "NotNull");
                        $("#tab101").find(".form-control").parent().prev().find("font").remove();
                    } else {
                        $("#Status").val("1");
                    }
                    if ($.currentIframe().window.pgusers != undefined) {
                        if ($.currentIframe().window.pgusers.indexOf(top.currUserAccount) >= 0) {
                            $("#tab101").find(".form-control").attr("isvalid", "yes");
                            $("#tab101").find(".form-control").attr("checkexpession", "NotNull");
                            $("#tab101").find(".form-control").parent().prev().append('<font face="宋体">*</font>');
                        }
                    }
                }
            });

        } else {
            if (ListingId == "" || ListingId == null || ListingId == undefined) {
                $("#RiskType").ComboBoxSetValue("作业活动");
                selRiskType(document.getElementById("RiskType"));
                if ($.currentIframe().window.document.getElementById("itemTree") == null) {
                    $("#tab101").find(".form-control").removeAttr("isvalid", "yes").removeAttr("checkexpession", "NotNull");
                    $("#tab101").find(".form-control").removeAttr("checkexpession", "NotNull");
                    $("#tab101").find(".form-control").parent().prev().find("font").remove();
                } else {
                    $("#Status").val("1");
                }
            }
        }

        if (!!planId) {
            $("#PlanId").val(planId);
        }
    }
    //保存表单
    function AcceptClick() {
        if (!$('#tab9').Validform()) {
            return false;
        }
        var json = "";
        var postData = $("#container").formSerialize(keyValue);
        if (!$('#tab101').Validform()) {
            return false;
        }
        //postData["AccidentName"] = $(".filter-option").text().replace("请选择", "");
        //postData["DistrictId"] = $("#DistrictId").attr("data-value");
        //postData["DistrictName"] = $("#DistrictId").attr("data-text");
        //postData["AreaCode"] = $("#DistrictId").attr("data-code");
        //postData["PostName"] = $("#PostId").attr("data-text");
        //postData["PostId"] = $("#PostId").attr("data-value");
        var HazardType = "";
        $("#tr_HazardType").find("li[class='selected']").each(function (i, dom) {
            HazardType += $("#HazardType").find("option").eq($(dom).attr("data-original-index")).val() + ",";
        });
        postData["HazardType"] = HazardType.substring(0, HazardType.length-1);
        postData["AreaName"] = $("#DistrictName").val();
        postData["AreaId"] = $("#DistrictId").val();
        postData["RiskType"] = $("#RiskType").attr("data-value");
        $.SaveForm({
            url: "../../RiskDatabase/RiskAssess/SaveForm?keyValue=" + keyValue,
            param: postData,
            loading: "正在保存数据...",
            success: function () {
                if (top.Risk != undefined) {
                    top.Risk.$("#gridTable").jqGrid('setGridParam', {
                        postData: { areaId: areaId }
                    }).trigger('reloadGrid');

                } else {
                    if (typeof ($.currentIframe().window.initControl) != "undefined") {
                        $.currentIframe().window.initControl();
                    }
                }
                $.currentIframe().window.$("#gridTable").trigger('reloadGrid');
            }
        })
    }

    function ChooseDutyDept() {
        var orgCode = $("#DeptCode").val();
        var isOrg = orgCode.length > 3 ? $("#DeptId").val() : "true";
        $("#PostId").html("");
        //绑定岗位
        $("#PostId").ComboBox({
            url: top.contentPath + "/BaseManage/Post/GetPostListJson?orgCode=" + orgCode + "&isOrg=" + isOrg,
            id: "RoleId",
            height: "300px",
            text: "FullName",
            allowSearch: true,
            description: "==请选择=="
        })

    }
    function selRiskType(obj) {
        var val = $(obj).attr("data-value");
        switch (val) {
            case "作业活动":
                $("#td_name_title").html("作业活动<font face=\"宋体\">*</font>");
                $("#tr_DistrictName,#tr_IsSpecialEqu,#tr_CheckprojectName,#tr_CheckStandard,#tr_Consequences").hide();
                $("#tr_WorkContent,#tr_HarmName,#tr_HazardType,#tr_HarmDescription,#tr_ExposedRisk").show();
                break;
            case "设备设施":
                $("#td_name_title").html("设备名称<font face=\"宋体\">*</font>");
                $("#tr_DistrictName,#tr_IsSpecialEqu,#tr_CheckprojectName,#tr_CheckStandard,#tr_Consequences").show();
                $("#tr_WorkContent,#tr_HarmName,#tr_HazardType,#tr_HarmDescription,#tr_ExposedRisk").hide();
                break;
        }
    }

    function ChooseTypesOfRisk() {
        if (!!$("#RiskType").attr("data-value")) {
            var dlg = dialogOpen({
                id: 'TypesOfRisk',
                title: '请选择风险种类',
                url: "/RiskDatabase/RiskAssess/TypesOfRiskForm?risktype=" + $("#RiskType").attr("data-value") + "风险",
                width: "1000px",
                height: "800px",
                callBack: function (iframeId) {
                    top.frames[iframeId].AcceptClick();
                }
            })
        }
        else
        {
            dialogMsg("请先选择风险种类！", 0);
            return;

        }

    }
    //根据风险类型与风险评估方法获取后台配置数据
    function setNewScore(obj, typename, cls, way, itemtype) {
        if (way == "风险矩阵法") {
            way = "jzf";
        }
        var clsName = "";
        var divtab = "";
        var riskname = typename + "风险";
        switch (typename) {
            case "设备":
                clsName = "sb" + way + cls;
                divtab = "divsb" + way + cls;
                break;
            case "管理":
                clsName = "gl" + way + cls;
                divtab = "divgl" + way + cls;
                break;
            case "区域":
                clsName = "qy" + way + cls;
                divtab = "divqy" + way + cls;
                break;
            case "作业":
                clsName = "zy" + way + cls;
                divtab = "divzy" + way + cls;
                break;
            case "岗位":
                clsName = "gw" + way + cls;
                divtab = "divgw" + way + cls;
                break;
            case "工器具及危化品":
                clsName = "gqj" + way + cls;
                divtab = "divgqj" + way + cls;
                break;
            case "作业活动":
                clsName = "zyhd" + way + cls;
                divtab = "divzyhd" + way + cls;
                break;
            case "设备设施":
                clsName = "sbss" + way + cls;
                divtab = "divsbss" + way + cls;
                break;
            default:
        }
        $("#" + divtab).html("");
        GetData(riskname, $("#Way").val(), itemtype, divtab, "1");
        node = obj;
        idx = dialogContent({
            id: "win1",
            title: $(obj).parent().prev().text(),
            btns: 1,
            btn: ["关闭"],
            content: $("." + clsName).html(),
            width: "1000px",
            height: "600px",
            callBack: function (iframeId) {
                top.layer.close(idx);
            }
        });
    }
    //获取控制措施的有效性、措施的成本因素
    function setMeasuresScore(obj, typename, cls, configtype) {
        var clsName = "";
        var divtab = "";
        var riskname = typename + "风险";
        switch (typename) {
            case "作业活动":
                clsName = "zyhd"  + cls;
                divtab = "divzyhd"  + cls;
                break;
            case "设备设施":
                clsName = "sbss"  + cls;
                divtab = "divsbss" + cls;
                break;
            default:
        }
        $("#" + divtab).html("");
        GetData(riskname, configtype, "", divtab, "1");
        node = obj;
        idx = dialogContent({
            id: "win1",
            title: $(obj).parent().prev().text(),
            btns: 1,
            btn: ["关闭"],
            content: $("." + clsName).html(),
            width: "1000px",
            height: "600px",
            callBack: function (iframeId) {
                top.layer.close(idx);
            }
        });
    }
    /*
    *RiskLevel：风险等级
    *MinValue:最小值
    *MinSymbol:最小值配置符号
    *MaxValue:最大值
    *MaxSymbol:最大值配置符号
    *result：算法结果
    *return compareFlag 比较结果 false  true
    *根据算法结果判断属于什么等级
    */
    function CompareRiskGrade(RiskLevel, MinValue, MinSymbol, MaxValue, MaxSymbol, compareFlag, result) {
        var flag1 = false;
        var flag2 = false;
        if (MinValue > 0) {
            switch (MinSymbol) {
                case "0":
                    if (MinValue < result) {
                        flag1 = true;
                    } else {
                        flag1 = false;
                    }
                    break;
                case "1":
                    if (MinValue > result) {
                        flag1 = true;
                    } else {
                        flag1 = false;
                    }
                    break;
                case "2":
                    if (MinValue == result) {
                        flag1 = true;
                    } else {
                        flag1 = false;
                    }
                    break;
                case "3":
                    if (MinValue <= result) {
                        flag1 = true;
                    } else {
                        flag1 = false;
                    }
                    break;
                case "4":
                    if (MinValue >= result) {
                        flag1 = true;
                    } else {
                        flag1 = false;
                    }
                    break;
                default:
                    break;
            }
        } else {
            flag1 = true;
        }
        if (MaxValue > 0) {
            switch (MaxSymbol) {
                case "0":
                    if (result < MaxValue) {
                        flag2 = true;
                    } else {
                        flag2 = false;
                    }
                    break;
                case "1":
                    if (result > MaxValue) {
                        flag2 = true;
                    } else {
                        flag2 = false;
                    }
                    break;
                case "2":
                    if (result == MaxValue) {
                        flag2 = true;
                    } else {
                        flag2 = false;
                    }
                    break;
                case "3":
                    if (result <= MaxValue) {
                        flag2 = true;
                    } else {
                        flag2 = false;
                    }
                    break;
                case "4":
                    if (result >= MaxValue) {
                        flag2 = true;
                    } else {
                        flag2 = false;
                    }
                    break;
                default:
                    break;
            }
        } else {
            flag2 = true;
        }
        if (flag2 && flag1) {
            compareFlag = true;
        }
        return compareFlag;
    }
    //根据风险类型与风险评估方法获取配置算法进行计算
    function getNewScore(score) {
        $(node).val(score);
        var riskType = $("#RiskType").attr("data-value");
        var waytype = $("#Way").val();

        var v1 = $.trim($("#tab101 #ItemA").val());
        var v2 = $.trim($("#tab101 #ItemB").val());
        var v3 = $.trim($("#tab101 #ItemC").val());
        var r = $("#ItemR");
        var g = $("#Grade");
        var result = 0;
        var ajaxFlag = false;
        if (waytype == "风险矩阵法") {
            if (v1.length > 0 && v2.length > 0) {
                ajaxFlag = true;
            }
        } else {
            if (v1.length > 0 && v2.length > 0 && v3.length > 0) {
                ajaxFlag = true;
            }
        }
        if (ajaxFlag) {
            $.ajax({
                url: "../../RiskDataBaseConfig/Riskwayconfig/GetDataByType",
                data: { RiskType: (riskType + "风险"), WayType: waytype },
                type: "get",
                dataType: "json",
                async: false,
                success: function (data) {
                    //debugger;
                    if (data.length > 0) {
                        //debugger;
                        var data = data[0];
                        for (var i = 0; i < data.DetaileList.length; i++) {
                            if (waytype == "风险矩阵法") {
                                result = v1 * v2;
                                result = result.toFixed(2);
                                r.val(result);

                            } else {
                                result = v1 * v2 * v3;
                                result = result.toFixed(2);
                                r.val(result);
                            }
                            var detail = data.DetaileList[i];
                            var compareFlag = false;
                            switch (detail.RiskLevel) {
                                case "重大风险":
                                    compareFlag = CompareRiskGrade(detail.RiskLevel, detail.MinValue, detail.MinSymbol, detail.MaxValue, detail.MaxSymbol, compareFlag, result);
                                    if (compareFlag) {
                                        g.val("一级风险");
                                        g.next().val("1");
                                    }
                                    break;
                                case "较大风险":
                                    compareFlag = CompareRiskGrade(detail.RiskLevel, detail.MinValue, detail.MinSymbol, detail.MaxValue, detail.MaxSymbol, compareFlag, result);
                                    if (compareFlag) {
                                        g.val("二级风险");
                                        g.next().val("2");
                                    }
                                    break;
                                case "一般风险":
                                    compareFlag = CompareRiskGrade(detail.RiskLevel, detail.MinValue, detail.MinSymbol, detail.MaxValue, detail.MaxSymbol, compareFlag, result);
                                    if (compareFlag) {
                                        g.val("三级风险");
                                        g.next().val("3");
                                    }
                                    break;
                                case "低风险":
                                    compareFlag = CompareRiskGrade(detail.RiskLevel, detail.MinValue, detail.MinSymbol, detail.MaxValue, detail.MaxSymbol, compareFlag, result);
                                    if (compareFlag) {
                                        g.val("四级风险");
                                        g.next().val("4");
                                    }
                                    break;
                                default:
                                    break;
                            }
                        }

                        if (g.val() == "" || g.val() == undefined) {
                            dialogMsg("配置风险取值不正确,请联系管理员进行修改配置！！", 0);
                            return;
                        }

                    } else {
                        dialogMsg("未配置风险取值,请联系管理员进行配置！！", 0);
                        return;
                    }
                }
            })
        }
        top.layer.close(top.frames[top.frames.length - 1].window.idx);

    }

    //控制措施有效性和措施的成本因素判断后果
    function getMeasureScore(score) {
        $(node).val(score);

        var v1 = $.trim($("#Effectiveness").val());
        var v2 = $.trim($("#CostFactor").val());
        var r = $("#MeasuresResult");
        var g = $("#MeasuresResultVal");
        var result = 0;
        var ajaxFlag = false;
        if (v1.length > 0 && v2.length > 0) {
            ajaxFlag = true;
        }
        if (ajaxFlag) {
            result = v1 * v2;
            result = result.toFixed(2);
            g.val(result);
            if (result >= 10) {
                r.val("预期的控制措施的费用支出恰当；")
            }
            else
            {
                r.val("预期的控制措施的费用支出不恰当。")
            }
        }
        top.layer.close(top.frames[top.frames.length - 1].window.idx);

    }
    //切换风险评估方法
    function ChangeWay(obj) {
        var value = $(obj).val()
        switch (value) {
            case "LEC":
                $("#trple").show();
                $("#ItemC").attr("isvalid", "yes").attr("checkexpession", "NotNull");
                if ($.currentIframe().window.document.getElementById("itemTree") == null) {
                    $("#tab101").find(".form-control").removeAttr("isvalid", "yes").removeAttr("checkexpession", "NotNull");
                    $("#tab101").find(".form-control").removeAttr("checkexpession", "NotNull");
                    $("#tditemc").html("").append("发生伤害后果的严重程度C");
                    $("#tditemc1").html("").append("暴露于危险环境的频繁程度E");
                    $("#tditemc2").html("").append("事故发生的可能性L");
                } else {
                    $("#Status").val("1");
                    $("#tditemc").html("").append("发生伤害后果的严重程度C<font face='宋体'>*</font>");
                    $("#tditemc1").html("").append("暴露于危险环境的频繁程度E<font face='宋体'>*</font>");
                    $("#tditemc2").html("").append("事故发生的可能性L<font face='宋体'>*</font>");
                    $("#tab101").find(".form-control").attr("isvalid", "yes");
                    $("#tab101").find(".form-control").attr("checkexpession", "NotNull");
                }
                if ($.currentIframe().window.pgusers != undefined) {
                    if ($.currentIframe().window.pgusers.indexOf(top.currUserAccount) >= 0) {
                        $("#tab101").find(".form-control").attr("isvalid", "yes");
                        $("#tab101").find(".form-control").attr("checkexpession", "NotNull");
                        $("#tab101").find(".form-control").parent().prev().append('<font face="宋体">*</font>');
                    }
                }
                break;
            case "风险矩阵法":
                $("#trple").hide();

                if ($.currentIframe().window.document.getElementById("itemTree") == null) {
                    $("#tab101").find(".form-control").removeAttr("isvalid", "yes").removeAttr("checkexpession", "NotNull");
                    $("#tab101").find(".form-control").removeAttr("checkexpession", "NotNull");
                    $("#tditemc").html("").append("发生伤害后果的严重程度S")
                    $("#tditemc2").html("").append("事故发生的可能性L")
                } else {
                    $("#Status").val("1");
                    $("#tditemc").html("").append("发生伤害后果的严重程度S<font face='宋体'>*</font>")
                    $("#tditemc2").html("").append("事故发生的可能性L<font face='宋体'>*</font>")
                    $("#tab101").find(".form-control").attr("isvalid", "yes");
                    $("#tab101").find(".form-control").attr("checkexpession", "NotNull");
                }
                if ($.currentIframe().window.pgusers != undefined) {
                    if ($.currentIframe().window.pgusers.indexOf(top.currUserAccount) >= 0) {
                        $("#tab101").find(".form-control").attr("isvalid", "yes");
                        $("#tab101").find(".form-control").attr("checkexpession", "NotNull");
                        $("#tab101").find(".form-control").parent().prev().append('<font face="宋体">*</font>');
                    }
                }
                $("#ItemC").removeAttr("isvalid").removeAttr("checkexpession");
                break;
            case "PSE":
                $("#trple").show();
                $("#ItemC").attr("isvalid", "yes").attr("checkexpession", "NotNull");
                if ($.currentIframe().window.document.getElementById("itemTree") == null) {
                    $("#tab101").find(".form-control").removeAttr("isvalid", "yes").removeAttr("checkexpession", "NotNull");
                    $("#tab101").find(".form-control").removeAttr("checkexpession", "NotNull");
                    $("#tditemc").html("").append("事故后果严重程度S")
                    $("#tditemc1").html("").append("事故暴露的可能性E")
                    $("#tditemc2").html("").append("事故发生的可能性P")
                } else {
                    $("#Status").val("1");
                    $("#tditemc").html("").append("事故后果严重程度S<font face='宋体'>*</font>")
                    $("#tditemc1").html("").append("事故暴露的可能性E<font face='宋体'>*</font>")
                    $("#tditemc2").html("").append("事故发生的可能性P<font face='宋体'>*</font>")
                    $("#tab101").find(".form-control").attr("isvalid", "yes");
                    $("#tab101").find(".form-control").attr("checkexpession", "NotNull");
                }
                if ($.currentIframe().window.pgusers != undefined) {
                    if ($.currentIframe().window.pgusers.indexOf(top.currUserAccount) >= 0) {
                        $("#tab101").find(".form-control").attr("isvalid", "yes");
                        $("#tab101").find(".form-control").attr("checkexpession", "NotNull");
                        $("#tab101").find(".form-control").parent().prev().append('<font face="宋体">*</font>');
                    }
                }
                break;
            default:
                break;
        }
        $("#ItemA").val("");
        $("#ItemB").val("");
        $("#ItemC").val("");
        $("#ItemR").val("");
        $("#Grade").val("");
    }
    function ChooseBaseListing()
    {
        if (!!$("#RiskType").attr("data-value")) {
            var risktype = 0;
            switch ($("#RiskType").attr("data-value")) {

                case "作业活动":
                    risktype = 0;
                    break;
                case "设备设施":
                    risktype = 1;
                    break;
                default:
            }
            var options = { winObject: window.document.body, domId: 'Name,ListingId,WorkContent,DistrictName,DistrictId,AreaCode,IsSpecialEqu,IsConventional' };
            var dlg = dialogOpen({
                id: 'BaseListing',
                title: '请选择清单',
                url: "/RiskDatabase/BaseListing/Select?type=" + risktype,
                width: "1000px",
                height: "800px",
                callBack: function (iframeId) {
                    top.frames[iframeId].AcceptClick(options);
                }
            })
        }
        else
        {
            dialogMsg("请先选择风险种类！", 0);
            return;
        }

    }
</script>
<div style="margin:10px;" id="container">

    <div class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;风险辨识</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form" id="tab9">

                <tr id="tr">
                    <td class="formTitle" style="width:180px;">风险类别<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="RiskType" class="ui-select" isvalid="yes" checkexpession="NotNull">
                        </div>
                        <input type="hidden" id="DeptCode" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptCode" />
                        <input type="hidden" id="DeptName" value="@ERCHTMS.Code.OperatorProvider.Provider.Current().DeptName" />
                        <input type="hidden" id="Status" />
                        <input type="hidden" id="PlanId" />
                    </td>
                </tr>   
                <tr>
                    <td class="formTitle" style="width:180px;" id="td_name_title">作业活动<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div class="input-group" style="width:100%">
                            <input type="text" id="Name" readonly="readonly" isvalid="yes" checkexpession="NotNull" class="form-control" />
                            <input type="hidden" id="ListingId" />
                            <span id="ChooseBaseListing" class="input-group-addon" onclick="ChooseBaseListing()" title="请选择清单" style="display: table-cell;"><i class="fa fa-gavel"></i></span>
                        </div>
                    </td>
                </tr>
                <tr id="tr_WorkContent">
                    <td class="formTitle" style="width:180px;">活动步骤<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input type="text" id="WorkContent" class="form-control" isvalid="yes" checkexpession="NotNull" readonly="readonly" />
                        <input type="hidden" id="IsConventional" />
                        <input type="hidden" id="PostId" />
                        <input type="hidden" id="Post" />
                    </td>
                </tr>
                <tr id="tr_DistrictName">
                    <td class="formTitle" style="width:180px;">所在地点<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input type="text" id="DistrictName" class="form-control" isvalid="yes" checkexpession="NotNull" readonly="readonly" />
                        <input type="hidden" id="DistrictId" class="form-control" />
                        <input type="hidden" id="AreaCode" />
                    </td>
                </tr>
                <tr id="tr_IsSpecialEqu">
                    <td class="formTitle" style="width:180px;">是否特种设备<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="IsSpecialEqu" type="select" class="ui-select" isvalid="yes" checkexpession="NotNull" readonly="readonly"></div>
                    </td>
                </tr>
                <tr id="tr_HarmName">
                    <td class="formTitle" style="width:180px;">危害名称</td>
                    <td class="formValue">
                        <input type="text" id="HarmName" class="form-control" />
                    </td>
                </tr>
                <tr id="tr_HazardType">
                    <td class="formTitle" style="width:180px;">危害种类</td>
                    <td class="formValue">
                        <select id="HazardType" class="form-control selectpicker show-menu-arrow" multiple placeholder="请选择危害种类">
                            @Html.Raw(new ERCHTMS.Busines.SystemManage.DataItemDetailBLL().GetOptionsString("HazardType"))
                        </select>
                    </td>
                </tr>
                <tr id="tr_HarmDescription">
                    <td class="formTitle" style="width:180px;">危害及有关信息描述</td>
                    <td class="formValue">
                        <input type="text" id="HarmDescription" class="form-control" />
                    </td>
                </tr>
                <tr id="tr_CheckprojectName">
                    <td class="formTitle" style="width:180px;">检查项目名称</td>
                    <td class="formValue">
                        <input type="text" id="CheckProjectName" class="form-control" />
                    </td>
                </tr>
                <tr id="tr_CheckStandard">
                    <td class="formTitle" style="width:180px;">检查标准</td>
                    <td class="formValue">
                        <input type="text" id="CheckStandard" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:180px;">风险描述</td>
                    <td class="formValue">
                        <input type="text" id="RiskDesc" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:180px;">风险种类<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div class="input-group" style="width:100%">
                            <input type="text" id="TypesOfRisk" class="form-control" isvalid="yes" checkexpession="NotNull" readonly="readonly" />
                            <span id="ChooseTypesOfRisk" class="input-group-addon" onclick="ChooseTypesOfRisk()" title="请选择风险种类" style="display: table-cell;"><i class="fa fa-gavel"></i></span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:180px;">风险范畴<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input type="text" id="RiskCategory" class="form-control" isvalid="yes" checkexpession="NotNull" readonly="readonly" />
                    </td>
                </tr>
                <tr id="tr_ExposedRisk">
                    <td class="formTitle" style="width:180px;">暴露于风险的人员、设备信息</td>
                    <td class="formValue">
                        <input type="text" id="ExposedRisk" class="form-control" />
                    </td>
                </tr>
                <tr id="tr_Consequences">
                    <td class="formTitle" style="width:180px;">不符合标准情况及后果</td>
                    <td class="formValue">
                        <input type="text" id="Consequences" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:180px;">现有的控制措施</td>
                    <td class="formValue">
                        <textarea type="text" id="ExistingMeasures" class="form-control"></textarea>
                    </td>
                </tr>
            </table>
        </div>

    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;风险控制效果评估</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form" id="tab101">
                <tr>
                    <td class="formTitle" style="width:180px;">风险评估方法</td>
                    <td class="formValue" colspan="3">
                        <select id="Way" onchange="ChangeWay(this)" class="form-control">
                            @*<option value="LEC">LEC</option>
                            <option value="风险矩阵法">风险矩阵法</option>*@
                            <option value="PSE">PSE</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td id="tditemc2" class="formTitle Way1">事故发生的可能性P<font face='宋体'>*</font></td>
                    <td class="formValue">
                        <input id="ItemA" type="text" class="form-control" placeholder="请选择" isvalid="yes" checkexpession="NotNull" readonly onclick="setNewScore(this, $('#RiskType').attr('data-value'), 'knx', $('#Way').val(),'可能性')" />
                    </td>
                    <td id="tditemc" class="formTitle Way2">事故后果严重程度S<font face='宋体'>*</font></td>
                    <td class="formValue">
                        <input id="ItemB" type="text" class="form-control" placeholder="请选择" isvalid="yes" checkexpession="NotNull" readonly onclick="setNewScore(this, $('#RiskType').attr('data-value'), 'yzx', $('#Way').val(), '严重程度')" />
                    </td>
                </tr>
                <tr id="trple">
                    <td id="tditemc1" class="formTitle Way2">事故暴露的可能性E<font face='宋体'>*</font></td>
                    <td class="formValue">
                        <input id="ItemC" type="text" class="form-control" placeholder="请选择" isvalid="yes" checkexpession="NotNull" readonly onclick="setNewScore(this, $('#RiskType').attr('data-value'), 'plx', $('#Way').val(), '暴露性')" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle Way4">风险值R<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="ItemR" type="text" class="form-control" placeholder="结果自动计算" readonly />
                    </td>
                    <td class="formTitle Way5" style="width:150px;">风险等级<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="Grade" type="text" class="form-control" placeholder="自动获取" readonly />
                        <input id="GradeVal" type="hidden" />
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;控制措施</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form">
                <tr>
                    <td class="formTitle" style="width:180px;">建议采取的控制措施</td>
                    <td class="formValue">
                        <textarea type="text" class="form-control" id="AdviceMeasures"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:180px;">控制措施的有效性</td>
                    <td class="formValue">
                        <input type="text" class="form-control" id="Effectiveness" placeholder="请选择" readonly onclick="setMeasuresScore(this, $('#RiskType').attr('data-value'), 'yxx', '控制措施的有效性')" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:180px;">措施的成本因素</td>
                    <td class="formValue">
                        <input type="text" class="form-control" id="CostFactor" placeholder="请选择" readonly onclick="setMeasuresScore(this, $('#RiskType').attr('data-value'), 'cbys','措施的成本因素')" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:180px;">控制措施判断后果</td>
                    <td class="formValue">
                        <input type="text" class="form-control" id="MeasuresResult" readonly />
                        <input type="hidden" id="MeasuresResultVal" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle" style="width:180px;">措施的采纳</td>
                    <td class="formValue">
                        <div type="select" class="ui-select" id="IsAdopt"></div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>

<!--作业风险选择标准-->
<div id="divL" style="margin:0px; display:none;" class="table1 zyLECknx">
    <div style="margin:10px;" id="divzyLECknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyLECyzx">
    <div style="margin:10px;" id="divzyLECyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyLECplx">
    <div style="margin:10px;" id="divzyLECplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 zyPSEknx">
    <div style="margin:10px;" id="divzyPSEknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyPSEyzx">
    <div style="margin:10px;" id="divzyPSEyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyPSEplx">
    <div style="margin:10px;" id="divzyPSEplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 zyjzfknx">
    <div style="margin:10px;" id="divzyjzfknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyjzfyzx">
    <div style="margin:10px;" id="divzyjzfyzx">
    </div>
</div>

<!--管理风险选择标准-->
<div id="divL" style="margin:0px; display:none;" class="table1 gljzfknx">
    <div style="margin:10px;" id="divgljzfknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gljzfyzx">
    <div style="margin:10px;" id="divgljzfyzx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 glPSEknx">
    <div style="margin:10px;" id="divglPSEknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 glPSEyzx">
    <div style="margin:10px;" id="divglPSEyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 glPSEplx">
    <div style="margin:10px;" id="divglPSEplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 glLECknx">
    <div style="margin:10px;" id="divglLECknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 glLECyzx">
    <div style="margin:10px;" id="divglLECyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 glLECplx">
    <div style="margin:10px;" id="divglLECplx">
    </div>
</div>

<!--工器具及危化品风险选择标准-->
<div id="divL" style="margin:0px; display:none;" class="table1 gqjjzfknx">
    <div style="margin:10px;" id="divgqjjzfknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gqjjzfyzx">
    <div style="margin:10px;" id="divgqjjzfyzx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 gqjPSEknx">
    <div style="margin:10px;" id="divgqjPSEknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gqjPSEyzx">
    <div style="margin:10px;" id="divgqjPSEyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gqjPSEplx">
    <div style="margin:10px;" id="divgqjPSEplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 gqjLECknx">
    <div style="margin:10px;" id="divgqjLECknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gqjLECyzx">
    <div style="margin:10px;" id="divgqjLECyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gqjLECplx">
    <div style="margin:10px;" id="divgqjLECplx">
    </div>
</div>

<!--岗位风险选择标准-->
<div id="divL" style="margin:0px; display:none;" class="table1 gwjzfknx">
    <div style="margin:10px;" id="divgwjzfknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gwjzfyzx">
    <div style="margin:10px;" id="divgwjzfyzx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 gwPSEknx">
    <div style="margin:10px;" id="divgwPSEknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gwPSEyzx">
    <div style="margin:10px;" id="divgwPSEyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gwPSEplx">
    <div style="margin:10px;" id="divgwPSEplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 gwLECknx">
    <div style="margin:10px;" id="divgwLECknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gwLECyzx">
    <div style="margin:10px;" id="divgwLECyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 gwLECplx">
    <div style="margin:10px;" id="divgwLECplx">
    </div>
</div>

<!--设备风险选择标准-->
<div id="divL" style="margin:0px; display:none;" class="table1 sbjzfknx">
    <div style="margin:10px;" id="divsbjzfknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbjzfyzx">
    <div style="margin:10px;" id="divsbjzfyzx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 sbPSEknx">
    <div style="margin:10px;" id="divsbPSEknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbPSEyzx">
    <div style="margin:10px;" id="divsbPSEyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbPSEplx">
    <div style="margin:10px;" id="divsbPSEplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 sbLECknx">
    <div style="margin:10px;" id="divsbLECknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbLECyzx">
    <div style="margin:10px;" id="divsbLECyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbLECplx">
    <div style="margin:10px;" id="divsbLECplx">
    </div>
</div>

<!--区域风险选择标准-->
<div id="divL" style="margin:0px; display:none;" class="table1 qyLECknx">
    <div style="margin:10px;" id="divqyLECknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 qyLECyzx">
    <div style="margin:10px;" id="divqyLECyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 qyLECplx">
    <div style="margin:10px;" id="divqyLECplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 qyPSEknx">
    <div style="margin:10px;" id="divqyPSEknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 qyPSEyzx">
    <div style="margin:10px;" id="divqyPSEyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 qyPSEplx">
    <div style="margin:10px;" id="divqyPSEplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 qyjzfknx">
    <div style="margin:10px;" id="divqyjzfknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 qyjzfyzx">
    <div style="margin:10px;" id="divqyjzfyzx">

    </div>
</div>

<!--作业活动风险选择标准-->
<div id="divL" style="margin:0px; display:none;" class="table1 zyhdLECknx">
    <div style="margin:10px;" id="divzyhdLECknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyhdLECyzx">
    <div style="margin:10px;" id="divzyhdLECyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyhdLECplx">
    <div style="margin:10px;" id="divzyhdLECplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 zyhdPSEknx">
    <div style="margin:10px;" id="divzyhdPSEknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyhdPSEyzx">
    <div style="margin:10px;" id="divzyhdPSEyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyhdPSEplx">
    <div style="margin:10px;" id="divzyhdPSEplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 zyhdjzfknx">
    <div style="margin:10px;" id="divzyhdjzfknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyhdjzfyzx">
    <div style="margin:10px;" id="divzyhdjzfyzx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyhdyxx">
    <div style="margin:10px;" id="divzyhdyxx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 zyhdcbys">
    <div style="margin:10px;" id="divzyhdcbys">

    </div>
</div>

<!--作业活动风险选择标准-->
<div id="divL" style="margin:0px; display:none;" class="table1 sbssLECknx">
    <div style="margin:10px;" id="divsbssLECknx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbssLECyzx">
    <div style="margin:10px;" id="divsbssLECyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbssLECplx">
    <div style="margin:10px;" id="divsbssLECplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 sbssPSEknx">
    <div style="margin:10px;" id="divsbssPSEknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbssPSEyzx">
    <div style="margin:10px;" id="divsbssPSEyzx">
    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbssPSEplx">
    <div style="margin:10px;" id="divsbssPSEplx">
    </div>
</div>

<div id="divL" style="margin:0px; display:none;" class="table1 sbssjzfknx">
    <div style="margin:10px;" id="divsbssjzfknx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbssjzfyzx">
    <div style="margin:10px;" id="divsbssjzfyzx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbssyxx">
    <div style="margin:10px;" id="divsbssyxx">

    </div>
</div>
<div id="divL" style="margin:0px; display:none;" class="table1 sbsscbys">
    <div style="margin:10px;" id="divsbsscbys">

    </div>
</div>
