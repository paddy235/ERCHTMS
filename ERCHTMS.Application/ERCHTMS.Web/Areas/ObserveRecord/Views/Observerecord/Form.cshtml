@{;
ViewBag.Title = "表单页面";
Layout = "~/Views/Shared/_Form.cshtml";
}
<link href="~/Content/scripts/plugins/jqgrid/jqgrid.css" rel="stylesheet" />
<link href="~/content/scripts/plugins/dialog/dialog.css" rel="stylesheet" />
<script src="~/Content/scripts/plugins/layout/jquery.layout.js"></script>
<script src="~/Content/scripts/business/Common.js" type="text/javascript"></script>
<script src="~/Content/scripts/plugins/jqgrid/grid.locale-cn.js"></script>
<script src="~/Content/scripts/plugins/jqgrid/jqgrid.min.js"></script>
<link href="~/content/scripts/plugins/icheck/skins/square/_all.css" type="text/css" rel="stylesheet" />
<script src="~/content/scripts/plugins/icheck/js/icheck.min.js" type="text/javascript"></script>
<script src="~/content/scripts/plugins/icheck/js/custom.min.js" type="text/javascript"></script>
<!--webUploader文件上传组件-->
<link href="~/content/scripts/plugins/webuploader/webuploader.css" rel="stylesheet" />
<link href="~/content/scripts/plugins/webuploader/webuploader-demo.css" rel="stylesheet" />
<script type="text/javascript" src="~/content/scripts/plugins/webuploader/webuploader.min.js"></script>
<script type="text/javascript" src="~/content/scripts/business/fileupload.js"></script>
<script>
    var orgId = "@ERCHTMS.Code.OperatorProvider.Provider.Current().OrganizeId";//当前用户所属机构id
    var currUserId = "@ERCHTMS.Code.OperatorProvider.Provider.Current().UserId";
    var keyValue = request('keyValue');
    var mode = request('mode');
    var PlanId = request('PlanId');//观察计划Id
    var PlanFjId = request('PlanFjId');//观察计划分解Id
    var PlanMonth = request('Month');//观察计划月份
    $(function () {
        $("#btnExport").hide();
        GetObsType();
        initControl();
        InitGrid();
        InitCheckList();

        $("#btngroup").show();

        if (mode == "view") {
            $(".safetyAdd").each(function (i, item) {
                item.setAttribute("disabled", "true");
            })
            $("input").attr("disabled", "disabled");
            $("textarea").attr("disabled", "disabled");
            $(".ui-select").attr("disabled", "disabled");
            $("#btngroup").hide();
        }
    });
    /*
    *
    *观察类别事件
    */
    function InitCheckList() {
        $('.icheck input').iCheck({
            checkboxClass: 'icheckbox_square-blue',
            radioClass: 'iradio_square-blue',
            increaseArea: '20%'
        });
        $(".icheck input").on('ifChecked', function (event) {
            if ($(this).attr("ck") == "0") {//此处选择存在问题
                var c = $(this).attr("class");
                $("#obssafety .div_" + c)[0].style.display = "none";
                $("#obsNotsafety .div_" + c)[0].style.display = "";
                $("." + $(this).attr("class")).eq(0).iCheck('uncheck');
            } else {//此处选择全部安全
                var c = $(this).attr("class");

                $("#obssafety .div_" + c)[0].style.display = "";
                $("#obsNotsafety .div_" + c)[0].style.display = "none";
                $("." + $(this).attr("class")).each(function () {
                    if ($(this).attr("ck") == "0") {
                        $(this).iCheck('uncheck');
                    }
                })
            }
        });
    }
    //观察计划页面跳转时给对应空间赋值
    function PlanSkipInit() {
        $.SetForm({
            url: "../../Observerecord/Obsplan/GetPlanById",
            param: { PlanId: PlanId, PlanFjId: PlanFjId, PlanMonth: PlanMonth },
            success: function (data) {
                //$("#form1").formDeserialize(data[0]);
                $("#WorkAreaId").ComboBoxSetValue(data[0].workareaid);
                $("#WorkName").val(data[0].workname);
                $("#WorkUnit").val(data[0].workunit);
                $("#WorkUnitId").val(data[0].workunitid);
                $("#WorkUnitCode").val(data[0].workunitcode);
                $("#ObsPerson").val(data[0].obsperson);
                $("#ObsPersonId").val(data[0].obspersonid);
                $("#ObsStartTime").val(data[0].obsstarttime);
                $("#ObsEndTime").val(data[0].obsendtime);
                $("#ObsPlanId").val(PlanId);
                $("#ObsPlanfjid").val(PlanFjId);
            }
        })
    }
    /*
    *
    *初始化安全行为表格与不安全行为表格
    */
    function InitGrid() {
        $.SetForm({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "ObsType" },
            success: function (data) {
                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        GetGrid(data[i].ItemValue, 1, i);
                        GetGrid(data[i].ItemValue, 0, i);
                    }
                }
            }
        })
    }
    /*
    *
    *动态获取观察类别和动态生产安全行为与不安全行为表格
    */
    function GetObsType() {
        $.SetForm({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "ObsType" },
            success: function (data) {
                if (data.length > 0) {
                    var html = "";
                    var safegrid = "";
                    var notsafe = "";
                    for (var i = 0; i < data.length; i++) {
                        safegrid += " <div class='div_" + data[i].ItemValue + "' style='display:none;'>";
                        safegrid += " <div class='ibox-title'>";
                        safegrid += " <h5>" + data[i].ItemName + "</h5>";
                        safegrid += " <div class='ibox-tools'><a  class='btn btn-default  safetyAdd' onclick=\"addSafety('" + data[i].ItemValue + "',1)\"><i class='fa fa-plus'></i>新增</a></div></div>";
                        safegrid += " <div class='ibox-content'>";
                        safegrid += " <div class='gridPanel'>";
                        safegrid += " <table id='gridTable_" + data[i].ItemValue + "'></table>";
                        safegrid += " <div id='gridPager_" + data[i].ItemValue + "'></div></div></div></div>";

                        notsafe += " <div class='div_" + data[i].ItemValue + "' style='display:none;'>";
                        notsafe += " <div class='ibox-title'>";
                        notsafe += " <h5>" + data[i].ItemName + "</h5>";
                        notsafe += " <div class='ibox-tools'><a  class='btn btn-default  safetyAdd' onclick=\"addSafety('" + data[i].ItemValue + "',0)\"><i class='fa fa-plus'></i>新增</a></div> </div>";
                        notsafe += " <div class='ibox-content'>";
                        notsafe += " <div class='gridPanel'>";
                        notsafe += " <table id='gridNotTable_" + data[i].ItemValue + "'></table>";
                        notsafe += " <div id='gridNotPager_" + data[i].ItemValue + "'></div></div></div></div>";

                        html += "<li style='float:left;width:13%;padding-left: 30px;'>";
                        html += "<ul><li style='font-weight: bold;font-size:16px;padding-bottom: 20px'>" + (i + 1) + "、" + data[i].ItemName + "</li>";
                        html += "<li><div class='radio-inline icheck'> <label> <input type='checkbox' typename='" + data[i].ItemName + "' name='" + data[i].ItemValue + "' id='" + data[i].ItemValue + "' ck='1' class='" + data[i].ItemValue + "' value='0' />&nbsp;&nbsp;全部安全</label> </div>";
                        html += "<li>存在问题</li> </li> ";
                        $.SetForm({
                            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
                            param: { EnCode: data[i].ItemValue },
                            success: function (result) {
                                if (result.length > 0) {
                                    for (var j = 0; j < result.length; j++) {
                                        html += "<li><div class='radio-inline icheck'><label>";
                                        html += "<input type='checkbox' name='" + (result[j].Description + j) + "' typename='" + data[i].ItemName + "' id='" + (result[j].Description + j) + "'ck='0' class='" + result[j].Description + "' value='" + result[j].ItemValue + "' />&nbsp;&nbsp;" + result[j].ItemName + " </label> </div></li>"
                                    }
                                }
                            }
                        })
                        html += "</ul></li>";
                    }
                    $("#typeList").html(html);
                    $("#notSafetyData").html(notsafe);
                    $("#safetyData").html(safegrid);
                }
            }
        })
    }
    /*
    *
    *新增行为描述
    */
    function addSafety(type, issafety) {
        dialogOpen({
            id: 'SafetyForm',
            title: '新增详情',
            url: '/Observerecord/Observerecord/SafetyForm?recordid=' + keyValue + '&issafety=' + issafety + '&type=' + type + '&mode=add',
            width: ($(top.window).width() - 300) + "px",
            height: ($(top.window).height() - 300) + "px",
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick();
            }
        })
    }
    function showSafty(id, type, issafety) {
        //var keyValue = id;
        if (checkedRow(id)) {
            var dlg = dialogOpen({
                id: 'SafetyForm',
                title: '查看详情',
                url: '/Observerecord/Observerecord/SafetyForm?keyValue=' + id + '&recordid=' + keyValue + '&issafety=' + issafety + '&type=' + type + '&mode=view',
                width: ($(top.window).width() - 300) + "px",
                height: ($(top.window).height() - 300) + "px",
                btn: ["关闭"],
                callBack: function (iframeId) {
                    top.layer.close(dlg);
                }
            })
        }
    }
    function editSafty(id, type, issafety) {
        dialogOpen({
            id: 'SafetyForm',
            title: '编辑详情',
            url: '/Observerecord/Observerecord/SafetyForm?keyValue=' + id + '&recordid=' + keyValue + '&issafety=' + issafety + '&type=' + type + '&mode=edit',
            width: ($(top.window).width() - 300) + "px",
            height: ($(top.window).height() - 300) + "px",
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick();
            }
        })
    }
    function delSafety(id, type, issafety) {
        var keyValue = id;
        if (keyValue) {
            $.RemoveForm({
                url: '../../Observerecord/Observerecord/RemoveSafetyForm',
                param: { keyValue: keyValue },
                success: function (data) {
                    if (issafety == "1") {
                        $('#gridTable_' + type).trigger('reloadGrid');
                    } else {
                        $('#gridNotTable_' + type).trigger('reloadGrid');
                    }
                }
            })
        } else {
            dialogMsg('请选择需要删除的信息！', 0);
        }
    }
    /*
    *
    *根据类型,行为安全生产表格
    */
    function GetGrid(type, issafety, i) {
        var queryJson = {
            type: type,
            issafety: issafety,
            recordid: keyValue
        };
        var colList = new Array();
        colList.push(
            { label: 'id', name: 'id', hidden: true },
                 {
                     label: '操作', name: 'oper', width: 200, align: 'center', sortable: false,
                     formatter: function (cellvalue, options, rowObject) {
                         var html = "<a href=javascript:showSafty('" + rowObject.id + "','" + rowObject.observetype + "','" + rowObject.issafety + "')  title='查看'><i class='fa fa-eye'></i></a>";
                         if (rowObject.createuserid == currUserId && mode != "view") {
                             html += "<a href=javascript:editSafty('" + rowObject.id + "','" + rowObject.observetype + "','" + rowObject.issafety + "')  title='修改'><i class='fa fa-pencil-square-o'></i></a>";
                             html += "<a href=javascript:delSafety('" + rowObject.id + "','" + rowObject.observetype + "','" + rowObject.issafety + "')  title='删除'><i class='fa fa-trash-o'></i></a>";
                         }
                         return html;
                     }
                 });
        if (issafety == "1") {
            colList.push(
                //{ label: '安全行为分类', name: 'observetypename', hidden:true },
                { label: '安全行为描述', name: 'behaviordesc', index: 'behaviordesc', width: 1200, align: 'center', sortable: false }
                );
        } else {
            colList.push(
                    //{ label: '问题分类', name: 'observetypename', hidden: true },
                    { label: '问题描述', name: 'behaviordesc', index: 'behaviordesc', width: 220, align: 'center', sortable: false },
                    { label: '直接原因', name: 'immediatecause', index: 'immediatecause', width: 220, align: 'center', sortable: false },
                    { label: '间接原因', name: 'remotecause', index: 'remotecause', width: 220, align: 'center', sortable: false },
                    { label: '纠正措施', name: 'remedialaction', index: 'remedialaction', width: 220, align: 'center', sortable: false },
                    { label: '预防措施', name: 'preventivemeasures', index: 'preventivemeasures', width: 220, align: 'center', sortable: false },
                    { label: '整改责任人', name: 'personresponsible', index: 'personresponsible', width: 150, align: 'center', sortable: false },
                    { label: '整改期限', name: 'reformdeadline', index: 'reformdeadline', width: 150, align: 'center', sortable: false }
                );
        }
        var selectedRowIndex = 0;
        var $gridTable = issafety == "1" ? $('#' + ('gridTable_' + type)) : $('#' + ('gridNotTable_' + type));
        $gridTable.jqGrid({
            autowidth: true,
            height: 200,
            url: "../../ObserveRecord/Observerecord/GetSafetyPageList",
            postData: { queryJson: JSON.stringify(queryJson) },
            datatype: "json",
            colModel: colList,
            viewrecords: true,
            rowNum: 30,
            rowList: [30, 50, 100],
            pager: issafety == "1" ? "#" + ("gridPager_" + type) : "#" + ("gridNotPager_" + type),
            sortname: 'createdate',
            sortorder: 'desc',
            rownumbers: true,
            shrinkToFit: false,
            gridview: true,
            onSelectRow: function () {
                selectedRowIndex = $('#' + this.id).getGridParam('selrow');
            },
            gridComplete: function () {
                $('#' + this.id).setSelection(selectedRowIndex, false);
            }
        });
    }
    //初始化控件
    function initControl() {
        $("#WorkAreaId").ComboBoxTree({
            url: "../../BaseManage/District/GetTreeJson",
            param: { orgID: orgId, areaIds: "", planId: "" },
            id: "DistrictID",
            text: "DistrictName",
            description: "==请选择==",
            height: "200px",
            allowSearch: true
        });
        //获取表单
        if (!!keyValue) {
            file_upload.init({
                keyValue: keyValue,
                extensions: '',
                isImage: false,
                el: '#uploader1',
                fileDir: 'ObserveRecord'
            });
            $.SetForm({
                url: "../../Observerecord/Observerecord/GetFormJson",
                param: { keyValue: keyValue },
                success: function (data) {
                    $("#form1").formDeserialize(data);
                    $("#WorkAreaId").ComboBoxSetValue(data.WorkAreaId);
                    checkObstype();
                    var obsgist;
                    var obsgistValue;
                    if (data.ObsGist != null && data.ObsGist != "") {
                        obsgist = data.ObsGist.substring(0, data.ObsGist.length - 1).split(',');
                    } else {
                        obsgist = "";
                    }
                    if (data.ObsGistValue != null && data.ObsGistValue != "") {
                        obsgistValue = data.ObsGistValue.substring(0, data.ObsGistValue.length - 1).split(',');
                    } else {
                        obsgistValue = "";
                    }
                    if (obsgist.length > 0) {
                        for (var i = 0; i < obsgist.length; i++) {
                            if ($("#obsgist1").val() == obsgist[i]) {
                                document.getElementById("obsgist1").checked = true;
                                $("#div_obsgist1").show();
                                $("#obsgistvalue1").val(obsgistValue[i])
                            }
                            if ($("#obsgist2").val() == obsgist[i]) {
                                document.getElementById("obsgist2").checked = true;
                                $("#div_obsgist2").show();
                                $("#obsgistvalue2").val(obsgistValue[i])
                            }
                            if ($("#obsgist3").val() == obsgist[i]) {
                                document.getElementById("obsgist3").checked = true;
                                $("#div_obsgist3").show();
                                $("#obsgistvalue3").val(obsgistValue[i])
                            }
                        }
                    }
                    if (data.IsCommit == 1) {
                        $("#btnExport").show();
                    } else {
                        $("#btnExport").hide();
                    }
                    file_upload.bindFiles((mode == "view" ? false : true), false, keyValue, 'uploader1', (mode == "view" ? false : true));
                }
            })
        } else {
            keyValue = keyValue.length == 0 ? newGuid() : keyValue;
            if (mode == "planAdd" && PlanId != "") {
                PlanSkipInit();
            }
            file_upload.init({
                keyValue: keyValue,
                extensions: '',
                isImage: false,
                el: '#uploader1',
                fileDir: 'ObserveRecord'
            });
        }
    }
    /*
    *
    *观察依据切换
    */
    function changeGist(obj) {
        if ($(obj).val() == "0") {
            if ($(obj)[0].checked == true)
                $("#div_obsgist1").show();
            else {
                $("#div_obsgist1").hide();
            }
        } else if ($(obj).val() == "1") {
            if ($(obj)[0].checked == true)
                $("#div_obsgist2").show();
            else
                $("#div_obsgist2").hide();
        }
        else if ($(obj).val() == "2") {
            if ($(obj)[0].checked == true)
                $("#div_obsgist3").show();
            else
                $("#div_obsgist3").hide();
        }
    }
    //观察类别赋值
    function checkObstype() {
        //取出观察类型
        var obstypeArr = "";
        $.SetForm({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "ObsType" },
            success: function (data) {
                if (data.length > 0) {
                    obstypeArr = data;
                }

            }
        });
        $.SetForm({
            url: "../../Observerecord/Observerecord/GetObsTypeData",
            param: { keyValue: keyValue },
            success: function (data) {
                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].isallsafety == "1") {
                            $("#obssafety .div_" + data[i].observetype)[0].style.display = "";
                            $("#obsNotsafety .div_" + data[i].observetype)[0].style.display = "none";

                        } else {
                            $("#obssafety .div_" + data[i].observetype)[0].style.display = "none";
                            $("#obsNotsafety .div_" + data[i].observetype)[0].style.display = "";
                        }
                        for (var j = 0; j < obstypeArr.length; j++) {
                            $("." + obstypeArr[j].ItemValue).each(function (k, it) {
                                if (data[i].existproblemcode == it.value && it.getAttribute("class") == data[i].observetype && it.getAttribute("ck") == data[i].isallsafety) {
                                    it.checked = true;
                                }
                            })
                        }
                    }
                }
            }
        })
    }
    //保存表单;
    function AcceptClick(IsCommit) {


        //取出观察类型
        var obstypeArr = "";
        $.SetForm({
            url: "../../SystemManage/DataItemDetail/GetDataItemListJson",
            param: { EnCode: "ObsType" },
            success: function (data) {
                if (data.length > 0) {
                    obstypeArr = data;
                }

            }
        });
        var safetyList = new Array();
        //观察依据拼接
        var obsgistValue = "";
        var obsgist = "";
        if (IsCommit == 1) {
            if (!$('#form1').Validform()) {
                return false;
            }
            //根据观察类别判断页面上是否都勾选并判断对应表格是否添加数据
            for (var i = 0; i < obstypeArr.length; i++) {
                var isCheck = false;
                var isData = false;
                $("." + obstypeArr[i].ItemValue).each(function () {
                    if ($(this)[0].checked == true) {
                        isCheck = true;
                        //ck==1时查找安全行为表格 ck==0时查找不安全行为表格
                        if ($(this).attr("ck") == "1") {
                            var rowData = $("#gridTable_" + $(this).attr("class")).jqGrid("getRowData");
                            if (rowData.length > 0) {
                                isData = true;
                            }
                        } else {
                            var rowData = $("#gridNotTable_" + $(this).attr("class")).jqGrid("getRowData");
                            if (rowData.length > 0) {
                                isData = true;
                            }
                        }
                    }
                })
                //if (isCheck == false) {
                //    dialogMsg(obstypeArr[i].ItemName + "未勾选！", 0);
                //    return;
                //}
                if (isData == false) {
                    dialogMsg(obstypeArr[i].ItemName + "表格无数据,请填写数据后在提交！", 0);
                    return;
                }

            }

            //if (document.getElementById("obsgist1").checked == false && document.getElementById("obsgist2").checked == false && document.getElementById("obsgist3").checked == false) {
            //    dialogMsg("请勾选观察依据！", 0);
            //    return;
            //}

            if (document.getElementById("obsgist1").checked == true) {
                if (document.getElementById("obsgistvalue1").value == "" || document.getElementById("obsgistvalue1").value == null || document.getElementById("obsgistvalue1").value == undefined) {
                    dialogMsg("请填写观察依据！", 0);
                    return;
                }
            }
            if (document.getElementById("obsgist2").checked == true) {
                if (document.getElementById("obsgistvalue2").value == "" || document.getElementById("obsgistvalue2").value == null || document.getElementById("obsgistvalue2").value == undefined) {
                    dialogMsg("请填写观察依据！", 0);
                    return;
                }
            }
            if (document.getElementById("obsgist3").checked == true) {
                if (document.getElementById("obsgistvalue3").value == "" || document.getElementById("obsgistvalue3").value == null || document.getElementById("obsgistvalue3").value == undefined) {
                    dialogMsg("请填写观察依据！", 0);
                    return;
                }
            }
        } else {
            if ($("#WorkName").val() == "" || $("#WorkName").val() == undefined) {
                dialogMsg("作业名称不能为空！", 0);
                return;
            }

        }

        for (var j = 0; j < obstypeArr.length; j++) {
            var array = $("." + obstypeArr[j].ItemValue);
            for (var k = 0; k < array.length; k++) {
                if (array[k].getAttribute("ck") == "1" && array[k].checked == true) {
                    var rowData = $("#gridTable_" + array[k].getAttribute("class")).jqGrid("getRowData");
                    if (rowData.length > 0) {
                        for (var i = 0; i < rowData.length; i++) {
                            safetyList.push({
                                BehaviorDesc: rowData[i].behaviordesc,
                                Recordid: keyValue,
                                Observetype: array[k].getAttribute("class"),
                                ObservetypeName: array[k].getAttribute("typename"),
                                IsSafety: array[k].getAttribute("ck")
                            })
                        }
                        break;
                    }
                } else if (array[k].getAttribute("ck") == "0" && array[k].checked == true) {
                    var rowData = $("#gridNotTable_" + array[k].getAttribute("class")).jqGrid("getRowData");
                    if (rowData.length > 0) {
                        for (var i = 0; i < rowData.length; i++) {
                            safetyList.push({
                                Recordid: keyValue,
                                Observetype: array[k].getAttribute("class"),
                                ObservetypeName: array[k].getAttribute("typename"),
                                IsSafety: array[k].getAttribute("ck"),
                                BehaviorDesc: rowData[i].behaviordesc,
                                PreventiveMeasures: rowData[i].preventivemeasures,
                                PersonreSponsible: rowData[i].personresponsible,
                                ReformDeadline: rowData[i].reformdeadline,
                                RemedialAction: rowData[i].remedialaction,
                                ImmediateCause: rowData[i].immediatecause,
                                RemoteCause: rowData[i].remotecause
                            })
                        }
                        break;
                    }
                }
            }
        }
        var postData = $("#form1").formSerialize(keyValue);
        var observecategory = new Array();
        $(".icheck input:checked").each(function () {
            observecategory.push({
                isallsafety: $(this).attr("ck"),
                observetypename: $(this).attr("typename"),
                observetype: $(this).attr("class"),
                existproblemcode: $(this).val(),
                recordid: keyValue
            })
        })
        postData["WorkArea"] = $("#WorkAreaId").attr("data-text");
        postData["WorkAreaId"] = $("#WorkAreaId").attr("data-value");
        if (document.getElementById("obsgist1").checked == true) {
            obsgistValue += $("#obsgistvalue1").val() + ",";
            obsgist += document.getElementById("obsgist1").value + ",";
        }
        if (document.getElementById("obsgist2").checked == true) {
            obsgistValue += $("#obsgistvalue2").val() + ",";
            obsgist += document.getElementById("obsgist2").value + ",";
        }
        if (document.getElementById("obsgist3").checked == true) {
            obsgistValue += $("#obsgistvalue3").val() + ",";
            obsgist += document.getElementById("obsgist3").value + ",";
        }
        postData["IsCommit"] = IsCommit;
        postData["ObsGistValue"] = obsgistValue;
        postData["ObsGist"] = obsgist;
        postData["observecategory"] = JSON.stringify(observecategory);
        postData["safetyList"] = JSON.stringify(safetyList);
        $.SaveForm({
            url: "../../Observerecord/Observerecord/SaveForm?keyValue=" + keyValue,
            param: postData,
            loading: "正在保存数据...",
            success: function () {
                $.currentIframe().$("#gridTable").trigger("reloadGrid");
            }
        })
    }
    function getWorkPeople() {
        if ($("#WorkUnitId").val() == "") {
            dialogMsg("请先选择部门！", 0);
            return;
        } else {
            selectUser({ deptId: $("#WorkUnitId").val(), userIds: 'WorkPeopleId', checkMode: 1, mode: 2, winObject: window.document.body, domId: 'WorkPeople,,WorkPeopleId' });
        }
    }
    //导出数据
    function ExportData() {
        window.location.href = "../../Observerecord/Observerecord/ExportData?keyValue=" + keyValue;
    }
    function checklength() {
    }

    //选择观察计划
    function selPlanWork() {
        dialogOpen({
            id: 'selPlanWork',
            title: '选择观察计划',
            url: '/Observerecord/Obsplan/SelectObsPlan',
            width: ($(top.window).width() - 250) + 'px',
            height: ($(top.window).height() - 50) + 'px',
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick();
            }
        })
    }
</script>
<div style="padding-top: 50px; margin-right: 30px;">
    <div id="obsInfo" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;基本观察信息</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form">
                <tr>
                    <td class="formTitle">作业名称<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div class="input-group" style="width:100%;">
                            <input id="WorkName" type="text"  isvalid="yes" maxlength="50" checkexpession="NotNull" class="form-control" />
                            <input id="ObsPlanId" type="hidden" /><input id="ObsPlanfjid" type="hidden" />
                            <span class="input-group-addon" onclick="selPlanWork(this)" title="从观察计划中选择工作任务"><i class='fa fa-gavel'></i></span>
                        </div>   
                    </td>
                    <td class="formTitle">作业部门/单位<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input type="hidden" id="WorkUnitCode" />
                        <input type="hidden" id="WorkUnitId" />
                        <input id="WorkUnit" type="text" class="form-control" readonly isvalid="yes" checkexpession="NotNull" onclick="selectDept('', 0, 0, '选择单位', window.document.body, 'WorkUnit,WorkUnitCode,WorkUnitId');" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">作业人员<font face="宋体">*</font></td>
                    <td class="formValue" colspan='3'>
                        <div class="input-group" style="width:100%;">
                            <input id="WorkPeople" type="text" class="form-control" maxlength="800"  isvalid="yes" checkexpession="NotNull" placeholder="多个人用(英文)逗号隔开"  />
                            <input type="hidden" id="WorkPeopleId" />
                            <span class="input-group-addon" onclick="getWorkPeople()" title="选择作业人员"><i class='fa fa-user'></i></span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">作业区域<font face="宋体">*</font></td>
                    <td class="formValue">
                        <div id="WorkAreaId" type="select" class="ui-select" isvalid="yes" checkexpession="NotNull"></div>
                    </td>
                    <td class="formTitle">作业地点</td>
                    <td class="formValue">
                        <input id="WorkPlace" type="text" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">观察起始时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="ObsStartTime" type="text" class="form-control input-datepicker fxtime" isvalid="yes" checkexpession="NotNull" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm' })" />
                    </td>
                    <td class="formTitle">观察结束时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="ObsEndTime" type="text" class="form-control input-datepicker fxtime" isvalid="yes" checkexpession="NotNull" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm' })" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">观察人员<font face="宋体">*</font></td>
                    <td class="formValue" colspan='3'>
                        <div class="input-group" style="width:100%;">
                            <input id="ObsPerson" type="text" class="form-control" isvalid="yes" checkexpession="NotNull" maxlength="800" placeholder="多个人用(英文)逗号隔开" />
                            <input type="hidden" id="ObsPersonId" />
                            <span class="input-group-addon" onclick="selectUser({ deptId: '', userIds: 'ObsPersonId', checkMode: 1, mode: 0, winObject: window.document.body, domId: 'ObsPerson,,ObsPersonId' });" title="选择观察人员"><i class='fa fa-user'></i></span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">观察依据</td>
                    <td class="formValue" colspan="3">
                        <div style="float:left" class="radio-inline">
                            <label>
                                <input type="checkbox" name="obsgist1" id="obsgist1" onclick="changeGist(this)" value="0" />操作规程/WSWP名称编号 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            </label>
                        </div>
                        <div id="div_obsgist1" style="float: left; width: 300px; display: none">
                            <input id="obsgistvalue1" type="text" class="form-control" />
                        </div>

                    </td>
                </tr>
                <tr>
                    <td class="formTitle"></td>
                    <td class="formValue" colspan="3">
                        <div style="float:left" class="radio-inline">
                            <label>
                                <input type="checkbox" name="obsgist2" id="obsgist2" onclick="changeGist(this)" value="1" />工作票或者操作票名称编号 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            </label>

                        </div>
                        <div id="div_obsgist2" style="float: left; width: 300px; display: none">
                            <input id="obsgistvalue2" type="text" hidden class="form-control" />
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle"></td>
                    <td class="formValue" colspan="3">
                        <div style="float:left" class="radio-inline">
                            <label>
                                <input type="checkbox" name="obsgist3" id="obsgist3" onclick="changeGist(this)" value="2" />其他文件名称编号 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            </label>
                        </div>
                        <div id="div_obsgist3" style="float: left; width: 300px; display: none">
                            <input id="obsgistvalue3" type="text" hidden class="form-control" />
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="obstype" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;观察类别</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <ul id="typeList"></ul>
        </div>
    </div>
    <div id="obssafety" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;安全行为</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>

        </div>
        <div class="panel-body" id="safetyData">
        </div>
    </div>
    <div id="obsNotsafety" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;不安全行为</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body" id="notSafetyData">

        </div>
    </div>
    <div id="fileInfo" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;现场影像记录</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <div id="uploader1" class="uploader" style="border:1px solid #ccc; margin-top:10px; min-height:80px; margin-bottom:10px;">
                <div class="queueList">
                    <div id="File1" class="placeholder">
                        <div class="filePicker" style="margin-left:25px; margin-top:10px;"></div>
                    </div>
                </div>
                <div class="statusBar" style="display:none;">
                    <div class="progress">
                        <span class="text">0%</span>
                        <span class="percentage"></span>
                    </div>
                    <div class="info"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="linkupInfo" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;沟通记录</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form">
                <tr>
                    <td class="formTitle">沟通时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="LinkUpTime" type="text" class="form-control input-datepicker fxtime" value="@DateTime.Now.ToString("yyyy-MM-dd HH:mm")" isvalid="yes" checkexpession="NotNull" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm' })" />
                    </td>
                    <td class="formTitle">沟通地点<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="LinkUpPlace" type="text" isvalid="yes" maxlength="100" checkexpession="NotNull" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">参与人员<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <input id="LinkPeople" type="text" class="form-control" readonly isvalid="yes" maxlength="800" checkexpession="NotNull" onclick="selectUser({ deptId: '', userIds: 'LinkPeopleId', checkMode: 1, mode: 0, winObject: window.document.body, domId: 'LinkPeople,,LinkPeopleId', callback: checklength() });" />
                        <input id="LinkPeopleId" type="hidden" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">沟通事项<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <textarea id="LinkUpContent" type="text" maxlength="500" isvalid="yes" checkexpession="NotNull" class="form-control"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">沟通结果<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <textarea id="LinkUpResult" type="text" maxlength="500" isvalid="yes" checkexpession="NotNull" class="form-control"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">备注</td>
                    <td class="formValue" colspan="3">
                        <textarea id="LinkUpRemark" type="text" class="form-control"></textarea>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="accepInfo" class="panel panel-default">
        <div class="panel-heading">
            <strong>&nbsp;&nbsp;验收记录</strong>
            <span class="tools pull-right">
                <a class="fa fa-chevron-down" title="展开/收起"></a>
            </span>
        </div>
        <div class="panel-body">
            <table class="form">
                <tr>
                    <td class="formTitle">验收结论<font face="宋体">*</font></td>
                    <td class="formValue" colspan="3">
                        <textarea id="AcceptResult" maxlength="500" type="text" isvalid="yes" checkexpession="NotNull" class="form-control"></textarea>
                    </td>

                </tr>
                <tr>
                    <td class="formTitle">验收人员<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="AcceptPerson" type="text" readonly isvalid="yes" checkexpession="NotNull" onclick="selectUser({ deptId: '',userIds:'', checkMode: 0, mode: 0, winObject: window.document.body, domId: 'AcceptPerson,,AcceptPersonId' });" class=" form-control" />
                        <input id="AcceptPersonId" type="hidden" />
                    </td>
                    <td class="formTitle">验收时间<font face="宋体">*</font></td>
                    <td class="formValue">
                        <input id="AcceptTime" type="text" isvalid="yes" checkexpession="NotNull" class="form-control input-datepicker fxtime" onfocus="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm' })" />
                    </td>
                </tr>
                <tr>
                    <td class="formTitle">备注</td>
                    <td class="formValue" colspan="3">
                        <textarea id="RecordRemark" type="text" class="form-control"></textarea>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div id="btngroup" class="form-button" style=" top:40px;  text-align: left; padding-left: 20px; position: fixed; bottom: auto; z-index: 1000;">
        <a onclick="AcceptClick(0)" class="btn btn-primary"><i class="fa fa-mail-forward"></i>&nbsp;确&nbsp;&nbsp;认</a>
        &nbsp;&nbsp;
        <a onclick="AcceptClick(1)" class="btn btn-primary"><i class="fa fa-mail-forward"></i>&nbsp;提&nbsp;&nbsp;交</a>
        &nbsp;&nbsp;
    </div>
    <div id="btnExport" class="form-button" style=" top:40px;  text-align: left; padding-left: 20px; position: fixed; bottom: auto; z-index: 1000;">
        <a onclick="ExportData()" class="btn btn-primary"><i class="fa fa-mail-forward"></i>&nbsp;导&nbsp;&nbsp;出</a>
        &nbsp;&nbsp;
    </div>
</div>





